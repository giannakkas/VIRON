<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIRON</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#e0f0ff;font-family:'Segoe UI',sans-serif;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center;transition:opacity 0.5s}
svg{width:min(95vw,800px);height:auto;min-height:40vh;-webkit-tap-highlight-color:transparent;display:block}
/* Listening indicator */
.listen-indicator{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px;opacity:0;transition:all 0.5s;pointer-events:none}
.listen-indicator.active{opacity:1}
.listen-indicator.active .bar{background:rgba(255,80,80,0.9);animation:barPulse 0.6s ease-in-out infinite}
.listen-indicator.active .listen-text{color:rgba(255,100,100,0.8)}
.listen-indicator.wake{opacity:0.4}
.listen-bars{display:flex;gap:3px;align-items:center;height:20px}
.listen-bars .bar{width:3px;background:rgba(0,200,255,0.6);border-radius:2px;transition:height 0.15s}
.listen-indicator.speaking .bar{background:rgba(255,50,50,1);animation:barSpeak 0.3s ease-in-out infinite}
.listen-indicator.speaking{opacity:1}
.listen-indicator.speaking .listen-text{color:rgba(255,80,80,0.9)}
.listen-indicator.wake .bar{background:rgba(0,200,255,0.4);height:4px!important;animation:none}
.bar:nth-child(1){animation-delay:0s!important}
.bar:nth-child(2){animation-delay:0.1s!important}
.bar:nth-child(3){animation-delay:0.2s!important}
.bar:nth-child(4){animation-delay:0.1s!important}
.bar:nth-child(5){animation-delay:0s!important}
@keyframes barPulse{0%,100%{height:6px}50%{height:20px}}
@keyframes barSpeak{0%,100%{height:8px}50%{height:28px}}
.listen-text{font-size:13px;color:rgba(255,255,255,0.5);letter-spacing:1px}
.listen-indicator.active .listen-text{color:rgba(255,100,100,0.7)}
/* Subtitle */
.subtitle{position:fixed;bottom:35px;left:50%;transform:translateX(-50%);max-width:85vw;text-align:center;font-size:16px;color:rgba(255,255,255,0.85);background:rgba(0,0,0,0.6);padding:10px 24px;border-radius:20px;backdrop-filter:blur(10px);opacity:0;transition:opacity 0.4s;pointer-events:none;line-height:1.5}
.subtitle.visible{opacity:1}
/* Engagement */
.engagement-bar{position:fixed;top:12px;left:12px;display:none;align-items:center;gap:8px;z-index:50;background:rgba(0,0,0,0.5);padding:4px 10px;border-radius:20px;font-size:11px}
.eng-dot{width:8px;height:8px;border-radius:50%;transition:background 0.5s}
.eng-label{color:rgba(255,255,255,0.5)}
/* Hamburger + Settings */
.hamburger{position:fixed;top:12px;right:12px;width:40px;height:40px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;z-index:100;transition:all 0.2s}
.hamburger:hover{background:rgba(255,255,255,0.12)}
.hamburger span{display:block;width:20px;height:2px;background:rgba(255,255,255,0.6);border-radius:2px;transition:all 0.3s}
.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
.hamburger.open span:nth-child(2){opacity:0}
.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:90;opacity:0;pointer-events:none;transition:opacity 0.3s}
.settings-overlay.open{opacity:1;pointer-events:all}
.settings-panel{position:fixed;top:0;right:-320px;width:300px;height:100vh;background:rgba(8,12,22,0.97);border-left:1px solid rgba(255,255,255,0.08);z-index:95;padding:60px 20px 20px;overflow-y:auto;transition:right 0.3s ease;backdrop-filter:blur(20px)}
.settings-panel.open{right:0}
.settings-panel h2{font-size:18px;color:#e0f0ff;margin-bottom:20px}
.setting-group{margin-bottom:20px}
.setting-group h3{font-size:12px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.setting-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:10px;margin-bottom:6px}
.setting-item label{font-size:13px;color:#c0d8e8;display:flex;align-items:center;gap:8px}
input[type="range"]{-webkit-appearance:none;width:120px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:rgba(0,200,255,0.8);border-radius:50%;cursor:pointer}
.toggle{width:42px;height:22px;background:rgba(255,255,255,0.12);border-radius:11px;position:relative;cursor:pointer;transition:background 0.3s;border:none}
.toggle.on{background:rgba(0,200,255,0.35)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left 0.2s}
.toggle.on::after{left:22px}
.wifi-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:4px;font-size:12px}
.wifi-item.connected{background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2)}
.battery-bar{width:100%;height:20px;background:rgba(255,255,255,0.08);border-radius:10px;overflow:hidden;position:relative}
.battery-fill{height:100%;border-radius:10px;transition:width 0.5s}
.battery-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:600;color:#fff}
.sbtn{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#e0f0ff;font-size:13px;cursor:pointer;transition:all 0.2s;margin-bottom:6px}
.sbtn:hover{background:rgba(255,255,255,0.08)}
.sbtn.danger{border-color:rgba(255,80,80,0.2);color:rgba(255,100,100,0.7)}
/* YouTube */
.yt-container{position:fixed;bottom:20px;right:20px;z-index:70;background:rgba(5,10,20,0.95);border:1px solid rgba(0,200,255,0.15);border-radius:16px;padding:10px;display:none;backdrop-filter:blur(20px)}
.yt-container.visible{display:block}
.yt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.yt-title{font-size:12px;color:rgba(255,255,255,0.5);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.yt-close{background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:16px}
/* Whiteboard */
.wb-overlay{position:fixed;inset:0;z-index:80;pointer-events:none;opacity:0;transition:opacity 0.8s}
/* Boot splash */
.boot-splash{position:fixed;inset:0;z-index:200;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s;cursor:pointer}
.boot-splash.hidden{opacity:0;pointer-events:none}
.boot-splash img{width:min(60vw,400px);animation:bootPulse 2s ease-in-out infinite}
.boot-splash .boot-text{color:rgba(0,200,255,0.6);font-size:14px;margin-top:24px;letter-spacing:3px;animation:bootFade 1.5s ease-in-out infinite alternate}
@keyframes bootPulse{0%,100%{transform:scale(1);opacity:0.9}50%{transform:scale(1.03);opacity:1}}
@keyframes bootFade{0%{opacity:0.3}100%{opacity:0.8}}
.wb-overlay.active{opacity:1;pointer-events:all}
.wb-bg{position:absolute;inset:0;background:#f5f5f0}
.wb-hdr{position:absolute;top:12px;left:16px;right:16px;display:flex;justify-content:space-between;align-items:center;z-index:2}
.wb-title{font-size:14px;color:#444;font-weight:600}
.wb-close{background:rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.1);border-radius:8px;padding:6px 14px;font-size:12px;color:#555;cursor:pointer}
.wb-content{position:absolute;top:50px;left:20px;right:20px;bottom:20px;overflow-y:auto;font-family:Georgia,serif}
.wb-step{opacity:0;transform:translateY(15px);transition:all 1.2s ease-out;margin-bottom:16px}
.wb-step.visible{opacity:1;transform:translateY(0)}
.wb-step .sl{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.wb-step .sm{font-size:24px;color:#1a5276;font-family:'Courier New',monospace;background:rgba(0,0,0,0.03);padding:12px 16px;border-radius:8px;border-left:4px solid #2980b9;margin:8px 0}
.wb-step .st{font-size:18px;color:#222;line-height:1.6}
.wb-step .sr{font-size:28px;color:#27ae60;font-weight:700;text-align:center;padding:16px;background:rgba(39,174,96,0.08);border-radius:12px;border:2px solid rgba(39,174,96,0.2)}
</style>
</head>
<body>
<div class="boot-splash" id="bootSplash">
  <img src="/static/viron-logo.png" alt="VIRON">
  <div class="boot-text">TAP TO START</div>
</div>
<div class="engagement-bar" id="engBar"><div class="eng-dot" id="engDot"></div><span class="eng-label" id="engLabel"></span></div>
<div id="personName" style="position:fixed;top:40px;left:12px;font-size:14px;font-weight:bold;color:#00ff88;z-index:50;text-shadow:0 0 8px rgba(0,255,136,0.5)"></div>
<button class="hamburger" id="hb" onclick="toggleSettings()"><span></span><span></span><span></span></button>
<div class="settings-overlay" id="so" onclick="toggleSettings()"></div>
<div class="settings-panel" id="sp">
  <h2>‚öôÔ∏è Settings</h2>
  <div class="setting-group"><h3>üì∂ Wi-Fi</h3><div class="setting-item"><label>üì∂ Wi-Fi</label><button class="toggle on" onclick="this.classList.toggle('on')"></button></div><div><div class="wifi-item connected"><span>üîí HomeNetwork</span><span style="color:rgba(255,255,255,0.4)">Connected</span></div></div></div>
  <div class="setting-group"><h3>üîÜ Display</h3><div class="setting-item"><label>üîÜ Brightness</label><input type="range" min="10" max="100" value="80" oninput="document.body.style.filter='brightness('+this.value/100+')'"></div><div class="setting-item"><label>üåô Night Mode</label><button class="toggle" onclick="this.classList.toggle('on');document.body.style.background=this.classList.contains('on')?'#0a0508':'#000'"></button></div></div>
  <div class="setting-group"><h3>üó£Ô∏è Language</h3><div class="setting-item"><label>üåç VIRON Language</label><select id="langSelect" onchange="setVironLang(this.value)" style="background:rgba(255,255,255,0.08);color:#e0f0ff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 12px;font-size:13px"><option value="en">üá¨üáß English</option><option value="el">üá¨üá∑ Greek</option></select></div></div>
  <div class="setting-group"><h3>üîä Sound</h3><div class="setting-item"><label>üîä Volume</label><input type="range" id="volSlider" min="0" max="100" value="75"></div></div>
  <div class="setting-group"><h3>üîã Battery</h3><div class="setting-item" style="flex-direction:column;align-items:stretch;gap:8px"><div style="display:flex;justify-content:space-between"><label>üîã</label><span style="color:rgba(0,200,255,0.8)" id="bp">78%</span></div><div class="battery-bar"><div class="battery-fill" id="bf" style="width:78%;background:linear-gradient(90deg,#00e0ff,#00ff88)"></div><span class="battery-text" id="bt">78%</span></div></div></div>
  <div class="setting-group"><h3>ü§ñ AI</h3><div class="setting-item"><label>üì∑ Emotion Detection</label><button class="toggle on" onclick="this.classList.toggle('on');emotionDetectionOn=this.classList.contains('on')"></button></div><div class="setting-item"><label>üé≠ Proactive Care</label><button class="toggle on" onclick="this.classList.toggle('on');proactiveEnabled=this.classList.contains('on')"></button></div></div>
  <div class="setting-group"><h3>üë§ Face Recognition</h3>
    <div id="faceRecStatus" style="margin-bottom:8px;font-size:12px;color:rgba(255,255,255,0.4)"></div>
    <div id="facesList" style="margin-bottom:10px"></div>
    <div id="faceSetupArea" style="display:none;margin-bottom:10px">
      <button class="sbtn" onclick="setupFaceRec()" id="setupFaceBtn" style="width:100%;padding:8px;font-size:13px;background:rgba(0,180,255,0.15);color:#00b4ff;border:1px solid rgba(0,180,255,0.3);border-radius:8px;cursor:pointer">üì• Download Models & Setup</button>
    </div>
    <div id="faceRegArea" class="setting-item" style="flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;width:100%">
        <input type="text" id="faceNameInput" placeholder="Person's name..." style="flex:1;background:rgba(255,255,255,0.08);color:#e0f0ff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 12px;font-size:13px">
        <button class="sbtn" onclick="registerFace()" style="padding:6px 14px;font-size:12px;background:rgba(0,180,255,0.15);color:#00b4ff;border:1px solid rgba(0,180,255,0.3);border-radius:8px;cursor:pointer">üì∏ Register</button>
      </div>
      <div id="faceStatus" style="font-size:11px;color:rgba(255,255,255,0.4)">Look at camera and click Register</div>
    </div>
  </div>
  <div class="setting-group"><h3>‚ÑπÔ∏è System</h3><div class="setting-item" style="flex-direction:column;align-items:stretch;gap:4px"><div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:rgba(255,255,255,0.3)">Device</span><span style="font-size:12px;color:#c0d8e8">VIRON v1.0</span></div><div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:rgba(255,255,255,0.3)">Uptime</span><span style="font-size:12px;color:#c0d8e8" id="ut">0h 0m</span></div></div>
  <button class="sbtn danger" onclick="if(confirm('Restart?'))location.reload()">üîÅ Restart</button>
  <button class="sbtn danger" onclick="if(!confirm('Shutdown?'))return;cE('sleepy');toggleSettings();document.body.style.transition='opacity 2s';document.body.style.opacity='0';setTimeout(()=>{fetch('/api/system/shutdown',{method:'POST'}).catch(()=>{});document.body.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100vh;color:rgba(255,255,255,0.2);font-size:14px\'>VIRON is off.</div>';document.body.style.opacity='1'},2500)">‚èª Shutdown</button></div>
  <div style="text-align:center;color:rgba(255,255,255,0.15);font-size:11px;margin-top:20px">VIRON AI Companion ‚Ä¢ v1.0</div>
</div>
<div class="wb-overlay" id="wb" onclick="if(wbO&&!wbPresenting)closeWB()"><div class="wb-bg"></div><div class="wb-hdr"><div class="wb-title">üìù <span id="wbt"></span></div><button class="wb-close" onclick="closeWB()">‚úï Back</button></div><div class="wb-content" id="wbc"></div><div style="position:absolute;bottom:12px;left:0;right:0;text-align:center;font-size:13px;color:#999;font-style:italic">Say "OK" or tap anywhere to close</div></div>
<div class="yt-container" id="ytC"><div class="yt-header"><span class="yt-title" id="ytT">‚ô™</span><button class="yt-close" onclick="document.getElementById('ytP').src='';document.getElementById('ytC').classList.remove('visible')">‚úï</button></div><iframe id="ytP" width="280" height="158" src="" allow="autoplay;encrypted-media" allowfullscreen style="border:none;border-radius:10px"></iframe></div>
<div class="listen-indicator wake" id="listenInd">
  <div class="listen-bars"><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div></div>
  <span class="listen-text" id="listenText">Say "Hey VIRON"</span>
</div>
<div class="subtitle" id="subtitle"></div>
<svg id="face" viewBox="0 0 800 500"></svg>

<script>
// ===== DEBUG LOGGER =====
const _dbg=[];
function D(msg){
  const t=new Date().toTimeString().split(' ')[0]+'.'+String(Date.now()%1000).padStart(3,'0');
  const line=`[${t}] ${msg}`;
  _dbg.push(line);
  console.log('üîç '+line);
  // Send to server for persistent logging
  fetch('/debug/log',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({source:'browser',message:msg,level:'INFO'})}).catch(()=>{});
}
// Save debug log to server on demand
function saveDebugLog(){
  fetch('/debug/save',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({log:_dbg.join('\n')})}).catch(()=>{});
}
// Auto-save every 10 seconds
setInterval(saveDebugLog,10000);
D('=== VIRON Debug Session Started ===');
D('URL: '+location.href);
D('UserAgent: '+navigator.userAgent);
D('mediaDevices: '+(navigator.mediaDevices?'YES':'NO'));
D('getUserMedia: '+(navigator.mediaDevices?.getUserMedia?'YES':'NO'));
D('SpeechRecognition: '+((window.SpeechRecognition||window.webkitSpeechRecognition)?'YES':'NO'));
D('SpeechSynthesis: '+(window.speechSynthesis?'YES':'NO'));

// ===== EMOTIONS (43) =====
const E={happy:{eyeRx:1,eyeRy:.82,pupilSize:1,mouthCurve:1.3,mouthOpen:0,browAngle:0,browY:0,sparkle:true,irisStyle:0,winkLeft:false,squint:0},excited:{eyeRx:1.05,eyeRy:.88,pupilSize:.85,mouthCurve:1.6,mouthOpen:0,browAngle:-5,browY:-8,sparkle:true,irisStyle:0,winkLeft:false,squint:0},sad:{eyeRx:.95,eyeRy:.65,pupilSize:1.1,mouthCurve:-.8,mouthOpen:0,browAngle:8,browY:-5,sparkle:false,irisStyle:0,winkLeft:false,squint:0},angry:{eyeRx:.95,eyeRy:.6,pupilSize:.8,mouthCurve:-.5,mouthOpen:0,browAngle:15,browY:5,sparkle:false,irisStyle:1,winkLeft:false,squint:0},surprised:{eyeRx:1.1,eyeRy:.95,pupilSize:.7,mouthCurve:.1,mouthOpen:.9,browAngle:-8,browY:-15,sparkle:false,irisStyle:0,winkLeft:false,squint:0},sleepy:{eyeRx:.95,eyeRy:.4,pupilSize:1.2,mouthCurve:.3,mouthOpen:0,browAngle:3,browY:5,sparkle:false,irisStyle:0,winkLeft:false,squint:0},love:{eyeRx:1.02,eyeRy:.85,pupilSize:1.3,mouthCurve:1.1,mouthOpen:0,browAngle:-3,browY:-3,sparkle:true,irisStyle:2,winkLeft:false,squint:0},neutral:{eyeRx:1,eyeRy:.78,pupilSize:1,mouthCurve:.2,mouthOpen:0,browAngle:0,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:0},teasing:{eyeRx:1,eyeRy:.75,pupilSize:.9,mouthCurve:.9,mouthOpen:0,browAngle:6,browY:-2,sparkle:false,irisStyle:0,winkLeft:true,squint:.3},confused:{eyeRx:1,eyeRy:.8,pupilSize:1.05,mouthCurve:-.2,mouthOpen:0,browAngle:10,browY:-8,sparkle:false,irisStyle:0,winkLeft:false,squint:0},scared:{eyeRx:1.12,eyeRy:1,pupilSize:.6,mouthCurve:-.4,mouthOpen:.5,browAngle:-10,browY:-12,sparkle:false,irisStyle:0,winkLeft:false,squint:0},disgusted:{eyeRx:.9,eyeRy:.55,pupilSize:.85,mouthCurve:-1.2,mouthOpen:.2,browAngle:6,browY:3,sparkle:false,irisStyle:0,winkLeft:false,squint:.4},proud:{eyeRx:.98,eyeRy:.7,pupilSize:.95,mouthCurve:.8,mouthOpen:0,browAngle:-4,browY:-6,sparkle:true,irisStyle:0,winkLeft:false,squint:.15},shy:{eyeRx:1.05,eyeRy:.85,pupilSize:1.15,mouthCurve:.5,mouthOpen:0,browAngle:4,browY:-4,sparkle:false,irisStyle:2,winkLeft:false,squint:0},bored:{eyeRx:1,eyeRy:.5,pupilSize:1.1,mouthCurve:-.1,mouthOpen:0,browAngle:2,browY:4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},laughing:{eyeRx:1,eyeRy:.35,pupilSize:1,mouthCurve:1.8,mouthOpen:.7,browAngle:-3,browY:-5,sparkle:true,irisStyle:0,winkLeft:false,squint:.5},crying:{eyeRx:.95,eyeRy:.7,pupilSize:1.15,mouthCurve:-1,mouthOpen:.6,browAngle:10,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:0},thinking:{eyeRx:1,eyeRy:.78,pupilSize:.95,mouthCurve:.1,mouthOpen:0,browAngle:8,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:.15},winking:{eyeRx:1,eyeRy:.82,pupilSize:1,mouthCurve:1,mouthOpen:0,browAngle:-2,browY:-2,sparkle:true,irisStyle:0,winkLeft:true,squint:0},suspicious:{eyeRx:1,eyeRy:.6,pupilSize:.85,mouthCurve:-.3,mouthOpen:0,browAngle:12,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:.3},grateful:{eyeRx:1,eyeRy:.85,pupilSize:1.2,mouthCurve:1.4,mouthOpen:0,browAngle:-2,browY:-4,sparkle:true,irisStyle:2,winkLeft:false,squint:0},mischievous:{eyeRx:1.02,eyeRy:.72,pupilSize:.8,mouthCurve:1.2,mouthOpen:.15,browAngle:10,browY:3,sparkle:false,irisStyle:1,winkLeft:false,squint:.2},worried:{eyeRx:1.05,eyeRy:.85,pupilSize:1.1,mouthCurve:-.6,mouthOpen:0,browAngle:9,browY:-8,sparkle:false,irisStyle:0,winkLeft:false,squint:0},hopeful:{eyeRx:1.08,eyeRy:.92,pupilSize:1.35,mouthCurve:.4,mouthOpen:0,browAngle:6,browY:-10,sparkle:true,irisStyle:0,winkLeft:false,squint:0},sassy:{eyeRx:1,eyeRy:.68,pupilSize:.9,mouthCurve:.7,mouthOpen:0,browAngle:8,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.25},dizzy:{eyeRx:1.05,eyeRy:.85,pupilSize:.6,mouthCurve:-.3,mouthOpen:.3,browAngle:0,browY:-3,sparkle:false,irisStyle:0,winkLeft:false,squint:0},cheeky:{eyeRx:1,eyeRy:.4,pupilSize:1,mouthCurve:1.5,mouthOpen:.5,browAngle:-3,browY:-4,sparkle:true,irisStyle:0,winkLeft:false,squint:.4},flirty:{eyeRx:1,eyeRy:.8,pupilSize:1.2,mouthCurve:1,mouthOpen:0,browAngle:-4,browY:-3,sparkle:true,irisStyle:2,winkLeft:true,squint:0},jealous:{eyeRx:.95,eyeRy:.6,pupilSize:.9,mouthCurve:-.4,mouthOpen:0,browAngle:10,browY:2,sparkle:false,irisStyle:0,winkLeft:false,squint:.35},determined:{eyeRx:.98,eyeRy:.7,pupilSize:.85,mouthCurve:.1,mouthOpen:0,browAngle:8,browY:4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},embarrassed:{eyeRx:1.02,eyeRy:.8,pupilSize:1.1,mouthCurve:.6,mouthOpen:.15,browAngle:5,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:.1},mindblown:{eyeRx:1.15,eyeRy:1,pupilSize:.5,mouthCurve:0,mouthOpen:.8,browAngle:-12,browY:-18,sparkle:true,irisStyle:0,winkLeft:false,squint:0},smug:{eyeRx:.98,eyeRy:.65,pupilSize:.95,mouthCurve:.7,mouthOpen:0,browAngle:7,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:.3},evil:{eyeRx:1,eyeRy:.6,pupilSize:.7,mouthCurve:1.1,mouthOpen:.2,browAngle:14,browY:6,sparkle:false,irisStyle:1,winkLeft:false,squint:.25},dreamy:{eyeRx:1.02,eyeRy:.75,pupilSize:1.3,mouthCurve:.6,mouthOpen:0,browAngle:-2,browY:-4,sparkle:true,irisStyle:2,winkLeft:false,squint:.1},focused:{eyeRx:.96,eyeRy:.72,pupilSize:.75,mouthCurve:0,mouthOpen:0,browAngle:5,browY:2,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},relieved:{eyeRx:1,eyeRy:.55,pupilSize:1.1,mouthCurve:.9,mouthOpen:0,browAngle:-2,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.15},skeptical:{eyeRx:1,eyeRy:.7,pupilSize:.9,mouthCurve:-.2,mouthOpen:0,browAngle:12,browY:-4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},panicking:{eyeRx:1.12,eyeRy:1.05,pupilSize:.5,mouthCurve:-.6,mouthOpen:.85,browAngle:-12,browY:-16,sparkle:false,irisStyle:0,winkLeft:false,squint:0},silly:{eyeRx:1.05,eyeRy:.82,pupilSize:1,mouthCurve:1.5,mouthOpen:.4,browAngle:-5,browY:-6,sparkle:true,irisStyle:0,winkLeft:true,squint:.2},grumpy:{eyeRx:.92,eyeRy:.5,pupilSize:.9,mouthCurve:-.7,mouthOpen:0,browAngle:12,browY:6,sparkle:false,irisStyle:0,winkLeft:false,squint:.35},amazed:{eyeRx:1.1,eyeRy:.95,pupilSize:1.3,mouthCurve:1.2,mouthOpen:.3,browAngle:-8,browY:-14,sparkle:true,irisStyle:0,winkLeft:false,squint:0},zen:{eyeRx:1,eyeRy:.45,pupilSize:1.15,mouthCurve:.4,mouthOpen:0,browAngle:0,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.1}};

// ===== STATE =====
let emo="neutral",prev="neutral",tT=1,blink=false,lx=0,ly=0,talking=false,tO=0,tTime=0,bTime=0,bA={l:0,r:0};
let msgs=[],loading=false;
const vironSessionId='session_'+Date.now(); // Unique per page load for conversation memory
let sEmo={emotion:"neutral",engagement_score:100,face_detected:false,recognized_person:null};
let proactiveEnabled=true,emotionDetectionOn=true,lastPT=0;
let subTimer=null;

// Voice states
const VOICE_IDLE="idle";       // Listening always
const VOICE_ACTIVATED="activated"; // Wake word heard, processing
const VOICE_PROCESSING="processing"; // Sending to AI
const VOICE_HEARING="hearing"; // Student is speaking (show red bars)
let voiceState=VOICE_IDLE;

// ===== LANGUAGE SETTING =====
// Stored in localStorage. 'el' = Greek, 'en' = English
let vironLang=localStorage.getItem('viron-lang')||'en';
function setVironLang(lang){
  vironLang=lang;
  localStorage.setItem('viron-lang',lang);
  D('Language set to: '+lang);
  // Restart listener with new language
  stopAllRecognition();
  setTimeout(startAlwaysListening,500);
}
function getSRLang(){return vironLang==='el'?'el-GR':'en-US';}
function isGreekMode(){return vironLang==='el';}

const lerp=(a,b,t)=>a+(b-a)*t;
function lE(f,t,tt){const r={};for(const k in t)r[k]=typeof t[k]==="number"?lerp(f[k]??t[k],t[k],tt):(tt>.5?t[k]:f[k]);return r}
function cE(e){if(e===emo||!E[e])return;prev=emo;emo=e;tT=0;const s=performance.now();(function a(ts){const t=Math.min(1,(ts-s)/400);tT=t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;if(t<1)requestAnimationFrame(a)})(s)}

setInterval(()=>{blink=true;setTimeout(()=>blink=false,emo==="sleepy"?400:150)},3500);
document.addEventListener("mousemove",e=>{lx=((e.clientX-innerWidth/2)/(innerWidth/2))*8;ly=((e.clientY-innerHeight/2)/(innerHeight/2))*6});

let tAn=null;
function startT(){talking=true;if(tAn)return;(function a(){tTime+=.12;tO=Math.min(1,Math.max(0,Math.sin(tTime*2.8)*.4+Math.sin(tTime*4.5)*.2+Math.sin(tTime*1.2)*.15)*1.4);tAn=requestAnimationFrame(a)})()}
function stopT(){talking=false;cancelAnimationFrame(tAn);tAn=null;(function c(){tO*=.85;if(tO>.02)requestAnimationFrame(c);else tO=0})()}

function showSub(text){const el=document.getElementById("subtitle");el.textContent=text;el.classList.add("visible");clearTimeout(subTimer);subTimer=setTimeout(()=>el.classList.remove("visible"),Math.max(3000,text.length*60))}
function updateListenUI(){
  const ind=document.getElementById("listenInd");
  const txt=document.getElementById("listenText");
  if(voiceState===VOICE_HEARING){ind.className="listen-indicator speaking";txt.textContent="Listening..."}
  else if(inConversation&&(voiceState===VOICE_IDLE||voiceState===VOICE_ACTIVATED)){
    // Always show red bars during conversation
    ind.className="listen-indicator active";txt.textContent="Listening...";
  }
  else if(voiceState===VOICE_IDLE){
    ind.className="listen-indicator wake";
    txt.textContent='Say "Hey VIRON"';
  }
  else if(voiceState===VOICE_ACTIVATED){ind.className="listen-indicator active";txt.textContent="Listening..."}
  else if(voiceState===VOICE_PROCESSING){ind.className="listen-indicator active";txt.textContent="Thinking..."}
  else{ind.className="listen-indicator";ind.style.opacity="0";txt.textContent=""}
}

// ===== SPEECH =====
const synth=window.speechSynthesis;let gkV=null,enV=null;
function loadV(){
  const v=synth.getVoices();
  D('Voices available: '+v.length);
  const enVoices=v.filter(x=>x.lang.startsWith("en"));
  D('English voices: '+enVoices.map(x=>x.name).join(', '));
  
  // GREEK: prefer male
  gkV=v.find(x=>x.lang.startsWith("el")&&/male|man/i.test(x.name)&&!/female/i.test(x.name))||
      v.find(x=>x.lang.startsWith("el")&&x.name.includes("Google"))||
      v.find(x=>x.lang.startsWith("el"))||null;
  
  // ENGLISH: soft educated MALE voice
  const femaleNames=/Female|Zira|Samantha|Sara|Jenny|Aria|Hazel|Susan|Linda|Libby|Emily|Amy|Woman|Sonia|Neerja|Heera/i;
  const malePrefs=[
    x=>/Google UK English Male/i.test(x.name),
    x=>x.name.includes("Microsoft David"),
    x=>x.name.includes("Microsoft Mark"),
    x=>x.name.includes("Microsoft Guy"),
    x=>x.name.includes("Microsoft Ryan"),
    x=>/Daniel/i.test(x.name)&&x.lang.startsWith("en")&&!femaleNames.test(x.name),
    x=>/Male/i.test(x.name)&&x.lang.startsWith("en"),
    x=>/James|George|Thomas|Richard|Paul|Guy|Ryan|Andrew/i.test(x.name)&&x.lang.startsWith("en"),
    // Last resort: any English voice NOT known-female AND NOT "Google US English" (which is female)
    x=>x.lang.startsWith("en")&&!x.name.includes("Compact")&&!femaleNames.test(x.name)&&!/Google US English$/i.test(x.name)&&!/Google/i.test(x.name),
  ];
  enV=null;
  for(const pref of malePrefs){
    enV=enVoices.find(pref);
    if(enV){D('  ‚Üí Matched male voice: '+enV.name);break;}
  }
  
  D('Greek voice: '+(gkV?.name||'NONE (will use gTTS)'));
  D('English voice: '+(enV?.name||'NONE'));
}
if(synth){synth.onvoiceschanged=loadV;loadV()}
const isGr=t=>/[\u0370-\u03FF\u1F00-\u1FFF]/.test(t);
let currentAudio=null; // Track current playing audio to prevent overlap
let isSpeaking=false;

function stopSpeaking(){
  synth.cancel();
  if(currentAudio){try{currentAudio.pause();currentAudio.src=''}catch{}}
  currentAudio=null;
  isSpeaking=false;
}

function say(text){
  if(!synth){D('  say: no synth!');return}
  // STOP any current speech first ‚Äî ONE voice at a time
  stopSpeaking();
  isSpeaking=true;
  showSub(text);
  // Strip emojis and special chars that break TTS
  let clean=text.replace(/VIRON/gi,'ŒíŒØœÅŒøŒΩ')
    .replace(/[\u{1F600}-\u{1F64F}]/gu,'')  // emoticons
    .replace(/[\u{1F300}-\u{1F5FF}]/gu,'')  // symbols
    .replace(/[\u{1F680}-\u{1F6FF}]/gu,'')  // transport
    .replace(/[\u{1F1E0}-\u{1F1FF}]/gu,'')  // flags
    .replace(/[\u{2600}-\u{26FF}]/gu,'')     // misc symbols
    .replace(/[\u{2700}-\u{27BF}]/gu,'')     // dingbats
    .replace(/[\u{FE00}-\u{FEFF}]/gu,'')     // variation selectors
    .replace(/[\u{1F900}-\u{1F9FF}]/gu,'')   // supplemental
    .replace(/[\u{200D}\u{20E3}\u{FE0F}]/gu,'') // joiners
    .replace(/\s+/g,' ').trim();
  
  D('  say: "'+clean.substring(0,80)+'..." greek='+isGr(clean));
  
  if(!clean){D('  say: empty after cleanup');stopT();startWakeListener();return}
  
  // ALL speech ‚Üí server edge-tts (male voice) with browser fallback
  const lang=isGr(clean)?'el':'en';
  sayServerTTS(clean,lang);
}

// Server TTS (edge-tts male voice) ‚Äî works for ALL languages
let audioUnlocked=false;
function unlockAudio(){
  if(audioUnlocked)return;
  const s=new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA");
  s.volume=0.01;
  s.play().then(()=>{audioUnlocked=true;D('üîì Audio unlocked')}).catch(()=>{});
  const u=new SpeechSynthesisUtterance('');u.volume=0;synth.speak(u);
}
document.addEventListener('click',unlockAudio,{once:false});
document.addEventListener('touchstart',unlockAudio,{once:false});
document.addEventListener('keydown',unlockAudio,{once:false});

function sayServerTTS(text,lang){
  D('  sayServerTTS('+lang+'): "'+text.substring(0,60)+'"');
  startT();
  fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,lang:lang||'en'})})
  .then(r=>{
    D('  TTS response: '+r.status);
    if(!r.ok)throw new Error('HTTP '+r.status);
    return r.blob();
  })
  .then(blob=>{
    D('  TTS blob: '+blob.size+' bytes');
    const url=URL.createObjectURL(blob);
    const a=new Audio(url);
    currentAudio=a; // Track for stopSpeaking()
    a.volume=(document.getElementById("volSlider")?.value||75)/100;
    a.onended=()=>{D('  TTS playback ended');isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);stopT();setTimeout(startWakeListener,600)};
    a.onerror=(e)=>{D('  TTS playback ERROR: '+e.type);isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);stopT();setTimeout(startWakeListener,600)};
    a.play().catch(e=>{D('  TTS play() ERROR: '+e.message);isSpeaking=false;currentAudio=null;stopT();setTimeout(startWakeListener,600)})
  })
  .catch(e=>{
    D('  Server TTS FAILED: '+e.message+' ‚Äî falling back to browser voice');
    stopT();
    // Fallback: browser SpeechSynthesis (male voice)
    const u=new SpeechSynthesisUtterance(text);
    u.lang=lang==='el'?'el-GR':'en-US';
    if(lang!=='el'&&enV)u.voice=enV;
    if(lang==='el'&&gkV)u.voice=gkV;
    u.rate=0.9;u.pitch=0.85;
    u.onend=()=>{isSpeaking=false;stopT();setTimeout(startWakeListener,600)};
    u.onerror=()=>{stopT();setTimeout(startWakeListener,600)};
    synth.speak(u);
  })
}

// ========================================
// WAKE WORD SYSTEM - "Hey VIRON"
// ========================================
const WAKE_WORDS=["hey viron","hey byron","hey iron","hey vyron","hey veron","hey biron",
  "Œ≥ŒµŒπŒ± viron","Œ≥ŒµŒπŒ± Œ≤Œ¨ŒπœÅŒøŒΩ","Œ≥ŒµŒπŒ± Œ≤ŒπœÅŒøŒΩ","hey vi ron","ey viron","a viron"];
let activeRec=null;
let wakeRetryTimeout=null;

function matchesWakeWord(text){
  const lower=text.toLowerCase().trim().replace(/[.,!?]/g,'');
  // Check exact matches
  for(const w of WAKE_WORDS)if(lower.includes(w))return true;
  // Actual Chrome misrecognitions from testing
  const misrecognitions=["heavy road","heavy ron","heavy run","heavy iron","heavy roan",
    "hey byron","hey veron","hey baron","hey bron","hey ron","hey run",
    "hey iron","hey violin","hey viral","hey viren","hey vyron",
    "have iran","have iron","hey iran","hey irene","hey vr","hey v run",
    "a viron","a byron","hey brian","hey bryan",
    "tegan","tegan is","t gun","tigan","tea gun","tik on","tick on",
    "heavy wrong","heavy round","hey around","hey brown",
    "hayviron","hay viron","hayvironment","hay vironment",
    "hey environment","hey environ","hey virum","hey vironn",
    "hey fire on","hey tyron","hey myron","hey virus",
    "Œ≥ŒµŒπŒ± Œ≤ŒπœÅŒøŒΩ","Œ≥ŒµŒπŒ± Œ≤Œ±ŒπœÅŒøŒΩ","Œ≥ŒπŒ± Œ≤ŒπœÅŒøŒΩ","Œ≥ŒµŒπŒ± Œ≤œçœÅŒøŒΩ",
    "œáŒ≠Œπ Œ≤ŒØœÅŒøŒΩ","œáŒµŒπ Œ≤ŒπœÅŒøŒΩ","Œ≠Œπ Œ≤ŒØœÅŒøŒΩ","ŒµŒπ Œ≤ŒπœÅŒøŒΩ","œáŒµœä Œ≤ŒπœÅŒøŒΩ",
    "œáŒ≠Œπ Œ≤Œ¨ŒπœÅŒøŒΩ","œáŒµŒπ Œ≤Œ±ŒπœÅŒøŒΩ","Œ≠Œπ Œ≤Œ±ŒπœÅŒøŒΩ","Œµ Œ≤ŒπœÅŒøŒΩ","Œµœä Œ≤ŒπœÅŒøŒΩ"];
  for(const m of misrecognitions)if(lower.includes(m))return true;
  // Fuzzy regex: (hey/hi/hay/heavy/a/have) + (vir/byr/bir/fir/ron/iron)
  if(/(hey|hi|hay|heavy|have|hei|a)\s*\w{0,3}(vir|byr|bir|fir|vyr|iron|viron|byron|myron|tyron)/i.test(lower))return true;
  // "Tegan" = Chrome hearing "Hey VIRON" with Greek accent
  if(/^(tegan|tigan|teegan|deghan|degan)\b/i.test(lower))return true;
  // Greek fuzzy: œáŒ≠Œπ/Œ≠Œπ/Œµ/Œ≥ŒµŒπŒ± + Œ≤ŒπœÅ/Œ≤Œ±ŒπœÅ/Œ≤œçœÅ
  if(/(œáŒ≠Œπ|œáŒµŒπ|Œ≠Œπ|ŒµŒπ|Œ≥ŒµŒπŒ±|Œ≥ŒπŒ±|Œµ)\s*(Œ≤ŒπœÅ|Œ≤Œ±ŒπœÅ|Œ≤œçœÅ|Œ≤ŒØœÅ|ŒºœÄŒ±ŒπœÅ)/i.test(lower))return true;
  // Fuzzy: word starting with hey/hay + word containing r+on/un/oad
  if(/(hey|hay|hi|heavy)\s/.test(lower)&&/(vir|byr|bir|ron|run|road|iro)/i.test(lower))return true;
  return false;
}

function extractAfterWake(text){
  const lower=text.toLowerCase();
  // Try exact WAKE_WORDS first
  for(const w of WAKE_WORDS){
    const idx=lower.indexOf(w);
    if(idx>=0){
      const after=text.substring(idx+w.length).trim();
      if(after.length>2)return after;
    }
  }
  // Try misrecognitions
  const misrecs=["heavy road","heavy ron","heavy run","heavy iron","heavy roan",
    "hey byron","hey veron","hey baron","hey bron","hey ron","hey run",
    "hey iron","hey violin","hey viral","hey viren","hey vyron",
    "have iran","have iron","hey iran","hey irene","hey brian","hey bryan",
    "tegan","tegan is","t gun","tigan","tea gun","tik on","tick on",
    "heavy wrong","heavy round","hey around","hey brown",
    "hayviron","hay viron","hayvironment","hay vironment",
    "hey environment","hey environ","hey virum","hey vironn",
    "hey fire on","hey tyron","hey myron","hey virus",
    "Œ≥ŒµŒπŒ± Œ≤ŒπœÅŒøŒΩ","Œ≥ŒµŒπŒ± Œ≤Œ±ŒπœÅŒøŒΩ","Œ≥ŒπŒ± Œ≤ŒπœÅŒøŒΩ","Œ≥ŒµŒπŒ± Œ≤œçœÅŒøŒΩ",
    "œáŒ≠Œπ Œ≤ŒØœÅŒøŒΩ","œáŒµŒπ Œ≤ŒπœÅŒøŒΩ","Œ≠Œπ Œ≤ŒØœÅŒøŒΩ","ŒµŒπ Œ≤ŒπœÅŒøŒΩ","œáŒµœä Œ≤ŒπœÅŒøŒΩ",
    "œáŒ≠Œπ Œ≤Œ¨ŒπœÅŒøŒΩ","œáŒµŒπ Œ≤Œ±ŒπœÅŒøŒΩ","Œ≠Œπ Œ≤Œ±ŒπœÅŒøŒΩ","Œµ Œ≤ŒπœÅŒøŒΩ","Œµœä Œ≤ŒπœÅŒøŒΩ"];
  for(const m of misrecs){
    const idx=lower.indexOf(m);
    if(idx>=0){
      const after=text.substring(idx+m.length).trim();
      if(after.length>2)return after;
    }
  }
  // Fuzzy regex extraction: find where wake pattern ends
  const fuzzyPatterns=[
    /((?:hey|hi|hay|heavy|have|hei|a)\s*\w{0,3}(?:vir|byr|bir|fir|vyr|iron|viron|byron|myron|tyron)\w*)/i,
    /((?:hey|hay|hi|heavy)\s+\S*(?:vir|byr|bir|ron|run|road|iro)\S*)/i,
    /((?:œáŒ≠Œπ|œáŒµŒπ|Œ≠Œπ|ŒµŒπ|Œ≥ŒµŒπŒ±|Œ≥ŒπŒ±|Œµ)\s*(?:Œ≤ŒπœÅ|Œ≤Œ±ŒπœÅ|Œ≤œçœÅ|Œ≤ŒØœÅ|ŒºœÄŒ±ŒπœÅ)\S*)/i,
    /((?:tegan|tigan|teegan|deghan|degan)\s*(?:is)?)/i
  ];
  for(const pat of fuzzyPatterns){
    const match=lower.match(pat);
    if(match){
      const endIdx=lower.indexOf(match[1])+match[1].length;
      const after=text.substring(endIdx).trim();
      if(after.length>2)return after;
    }
  }
  return null;
}

let wakeStarting=false;

// ===== ALWAYS-ON LISTENING =====
// Detects wake word from INTERIM results (Chrome often skips finals)
// Filters background noise by checking for wake word pattern

let alwaysRec=null;
let alwaysListening=false;
let lastWakeTime=0; // Prevent double triggers

function startAlwaysListening(){
  D('>>> startAlwaysListening, voiceState='+voiceState+', loading='+loading+', wakeLang=en-US, cmdLang='+getSRLang());
  if(loading){D('  loading, retry in 1s');setTimeout(startAlwaysListening,1000);return}
  if(synth&&synth.speaking){D('  synth speaking, retry in 1s');setTimeout(startAlwaysListening,1000);return}
  if(alwaysListening){D('  already listening');return}
  
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){D('  ‚ùå SpeechRecognition not available');return}
  
  voiceState=VOICE_IDLE;
  updateListenUI();
  
  try{if(alwaysRec){alwaysRec.abort()}}catch{}
  
  alwaysRec=new SR();
  alwaysRec.continuous=false;
  alwaysRec.interimResults=true;
  alwaysRec.lang='en-US'; // ALWAYS English for wake word ‚Äî Chrome can't hear "Hey VIRON" in Greek mode
  alwaysRec.maxAlternatives=5;
  
  let wakeDetectedInSession=false;
  
  alwaysRec.onstart=()=>{
    alwaysListening=true;
    wakeDetectedInSession=false;
    document.getElementById("listenText").textContent='Say "Hey VIRON"';
  };
  
  alwaysRec.onresult=(e)=>{
    if(wakeDetectedInSession)return; // Already triggered this session
    
    let finalText="";
    let interim="";
    let allText=""; // Combine everything for wake word check
    
    for(let i=e.resultIndex;i<e.results.length;i++){
      const transcript=e.results[i][0].transcript;
      if(e.results[i].isFinal){
        finalText+=transcript;
      }else{
        interim+=transcript;
      }
      // Check ALL alternatives for wake word
      for(let j=0;j<e.results[i].length;j++){
        allText+=e.results[i][j].transcript+" ";
      }
    }
    
    const display=finalText||interim;
    // Only log occasionally to reduce spam
    if(display&&display.length>2){
      D('  üé§ "'+display+'" (final='+!!finalText+')');
      // Show speaking bars when voice detected
      voiceState=VOICE_HEARING;updateListenUI();
    }
    
    // CHECK WAKE WORD IN BOTH INTERIM AND FINAL
    const textToCheck=(finalText+' '+interim+' '+allText).toLowerCase();
    
    if(matchesWakeWord(textToCheck)){
      // Prevent double triggers within 3 seconds
      if(Date.now()-lastWakeTime<3000){
        D('  (wake word debounced)');
        return;
      }
      lastWakeTime=Date.now();
      wakeDetectedInSession=true;
      
      D('  üéØ WAKE WORD DETECTED in: "'+display+'"');
      alwaysListening=false;
      try{alwaysRec.abort()}catch{}
      
      // Extract what comes after wake word
      const afterWake=extractAfterWake(display);
      startConversation(); // Enter conversation mode
      if(afterWake&&afterWake.length>3){
        D('  ‚Üí Direct command: "'+afterWake+'"');
        cE("hopeful");
        voiceState=VOICE_PROCESSING;
        updateListenUI();
        processStudentSpeech(afterWake);
      }else{
        // Just "Hey VIRON" ‚Äî ack and listen for command
        D('  ‚Üí Acknowledged, entering conversation');
        cE("hopeful");
        voiceState=VOICE_ACTIVATED;
        updateListenUI();
        document.getElementById("listenText").textContent='Listening...';
        
        // Personalized ack with name if recognized
        const pName=sEmo.recognized_person;
        const ackText=pName?(isGreekMode()?`ŒùŒ±Œπ ${pName};`:`Yes ${pName}?`):"Mhm?";
        D('  Playing ack: "'+ackText+'"');
        fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:ackText,lang:isGreekMode()?'el':'en'})})
        .then(r=>r.ok?r.blob():Promise.reject('HTTP '+r.status))
        .then(blob=>{
          const url=URL.createObjectURL(blob);
          const a=new Audio(url);
          currentAudio=a;isSpeaking=true;
          a.volume=0.6;
          a.onended=()=>{D('  Ack ended, starting command listen');isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);startCommandListening()};
          a.onerror=()=>{isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);startCommandListening()};
          a.play().catch(()=>{isSpeaking=false;currentAudio=null;startCommandListening()});
        })
        .catch(e=>{
          D('  Ack TTS failed: '+e+', using browser voice');
          const ack=new SpeechSynthesisUtterance(ackText);
          ack.lang="en-US";if(enV)ack.voice=enV;
          ack.volume=0.6;ack.rate=1.0;ack.pitch=0.85;
          ack.onend=()=>startCommandListening();
          ack.onerror=()=>startCommandListening();
          synth.speak(ack);
        });
      }
      return;
    }
    
    // If we got a final result with no wake word, just ignore it
    if(finalText){
      D('  (no wake word in: "'+finalText.trim()+'")');
      voiceState=VOICE_IDLE;updateListenUI();    }
  };
  
  alwaysRec.onerror=(e)=>{
    alwaysListening=false;
    if(e.error==='not-allowed'){
      D('  ‚ùå Mic permission denied!');
      document.getElementById("listenText").textContent="Mic blocked ‚Äî click üîí";
      return;
    }
    // Restart quickly
    clearTimeout(wakeRetryTimeout);
    wakeRetryTimeout=setTimeout(()=>{
      if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking))startAlwaysListening();
    },200);
  };
  
  alwaysRec.onend=()=>{
    alwaysListening=false;
    // Auto-restart to keep listening
    if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking)){
      clearTimeout(wakeRetryTimeout);
      wakeRetryTimeout=setTimeout(startAlwaysListening,150);
    }
  };
  
  try{
    alwaysRec.start();
  }catch(e){
    D('  ‚ùå start error: '+e.message);
    alwaysListening=false;
    clearTimeout(wakeRetryTimeout);
    wakeRetryTimeout=setTimeout(startAlwaysListening,1000);
  }
}

// After wake word detected, listen for the actual command
let cmdRetryCount=0;
const MAX_CMD_RETRIES=5;

let activeCmdRec=null; // Track active command recognition

function startCommandListening(){
  D('>>> startCommandListening (inConversation='+inConversation+', retry='+cmdRetryCount+', wbPresenting='+wbPresenting+')');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return;
  
  // Don't listen while whiteboard is presenting
  if(wbPresenting){
    D('  üìã Whiteboard presenting, skipping');
    return;
  }
  
  // Don't start if audio is still playing
  if(isSpeaking||(synth&&synth.speaking)){
    D('  Audio still playing (isSpeaking='+isSpeaking+'), retry in 500ms');
    setTimeout(startCommandListening,500);
    return;
  }
  
  // Kill any existing recognition FIRST
  try{if(alwaysRec)alwaysRec.abort()}catch{}
  try{if(activeCmdRec)activeCmdRec.abort()}catch{}
  activeCmdRec=null;
  
  // Prevent infinite restart loops
  const maxRetries=wbO?20:5;
  if(cmdRetryCount>=maxRetries){
    D('  ‚ùå Too many retries ('+cmdRetryCount+'), ending');
    cmdRetryCount=0;
    if(wbO){
      // Don't end conversation, just stop trying to listen
      D('  üìã Whiteboard still open, waiting for tap or timeout');
      return;
    }
    if(inConversation)endConversation();
    else{voiceState=VOICE_IDLE;startAlwaysListening()}
    return;
  }
  
  voiceState=VOICE_ACTIVATED;
  updateListenUI();
  document.getElementById("listenText").textContent='Listening...';
  
  let cmdRec=new SR();
  activeCmdRec=cmdRec; // Track globally
  cmdRec.continuous=false;
  cmdRec.interimResults=true;
  cmdRec.lang=getSRLang();
  cmdRec.maxAlternatives=3;
  
  let gotResult=false;
  let handled=false;
  const timeout=inConversation?12000:8000;
  let cmdTimeout=setTimeout(()=>{
    if(!gotResult&&!handled){
      handled=true;
      D('  ‚è∞ Command timeout');
      try{cmdRec.stop()}catch{}
      cmdRetryCount=0; // timeout is normal, reset retries
      if(inConversation){
        silenceCount++;
        if(silenceCount>=2){
          cE("happy");
          say(isGreekMode()?"ŒïŒ¥œé ŒµŒØŒºŒ±Œπ Œ±ŒΩ ŒºŒµ œáœÅŒµŒπŒ±œÉœÑŒµŒØœÇ!":"I'm here if you need me!");
          inConversation=false;
          clearTimeout(conversationTimer);
        }else{
          D('  üó£Ô∏è Silence in conversation, still listening...');
          setTimeout(startCommandListening,500);
        }
      }else{
        cE("confused");
        say(isGreekMode()?"ŒîŒµŒΩ œÉŒµ Œ¨Œ∫ŒøœÖœÉŒ±!":"I didn't catch that!");
      }
    }
  },timeout);
  
  cmdRec.onresult=(e)=>{
    let finalText="";
    let interim="";
    let confidence=0;
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal){
        finalText+=e.results[i][0].transcript;
        confidence=e.results[i][0].confidence||0;
      }
      else interim+=e.results[i][0].transcript;
    }
    if(finalText||interim){
      document.getElementById("listenText").textContent=finalText||interim;
      // Show red speaking bars when voice detected
      if(interim&&!finalText){voiceState=VOICE_HEARING;updateListenUI()}
    }
    if(finalText&&finalText.trim().length>1){
      let speech=finalText.trim();
      D('  üé§ Final: "'+speech+'" (confidence='+confidence.toFixed(2)+')');
      
      // NOISE FILTER: reject low-confidence speech (skip during whiteboard ‚Äî just need 'ok')
      if(!wbO&&confidence>0&&confidence<0.5){
        D('  üîá Low confidence ('+confidence.toFixed(2)+'), ignoring');
        if(inConversation||wbO)setTimeout(startCommandListening,300);
        return;
      }
      
      // WHITEBOARD MODE: only accept close commands, ignore everything else
      if(wbO){
        if(/\b(ok|okay|ŒøŒ∫|ŒøŒ∫Œ≠Œπ|ŒµŒΩœÑŒ¨ŒæŒµŒπ|Œ∫ŒªŒµŒØœÉŒµ|close|done|ready|got it|Œ∫Œ±œÑŒ¨ŒªŒ±Œ≤Œ±|œâœÅŒ±ŒØŒ±|back|œÄŒØœÉœâ)\b/i.test(speech)){
          D('  üìã Closing whiteboard via voice: "'+speech+'"');
          gotResult=true;handled=true;clearTimeout(cmdTimeout);
          closeWB(); // closeWB handles conversation resume
        }else{
          D('  üìã Whiteboard open, ignoring: "'+speech+'"');
          setTimeout(startCommandListening,500);
        }
        return;
      }
      
      gotResult=true;
      handled=true;
      clearTimeout(cmdTimeout);
      cmdRetryCount=0;
      silenceCount=0;
      if(inConversation)resetConversationTimer();
      
      // In conversation mode, strip accidental wake words
      if(inConversation&&matchesWakeWord(speech.toLowerCase())){
        const after=extractAfterWake(speech);
        if(after&&after.length>2){
          speech=after;
          D('  ‚úÖ Stripped wake word, command: "'+speech+'"');
        }else{
          D('  (wake word only in conversation, ignoring)');
          setTimeout(startCommandListening,300);
          return;
        }
      }
      
      D('  ‚úÖ Command: "'+speech+'"');
      cE("thinking");
      voiceState=VOICE_PROCESSING;
      updateListenUI();
      processStudentSpeech(speech);
    }
  };
  
  cmdRec.onerror=(e)=>{
    clearTimeout(cmdTimeout);
    D('  ‚ö†Ô∏è cmd error: '+e.error);
    // Ignore errors from replaced/old recognition instances
    if(activeCmdRec!==cmdRec){D('  (stale instance, ignoring)');return}
    if(!gotResult&&!handled){
      handled=true;
      if(e.error==='aborted'){
        cmdRetryCount++;
        const retryDelay=wbO?2500:1000;
        if(inConversation||wbO)setTimeout(startCommandListening,retryDelay);
        else{voiceState=VOICE_IDLE;setTimeout(startAlwaysListening,500)}
      }else if(e.error==='no-speech'){
        cmdRetryCount=0; // no-speech is normal
        if(inConversation||wbO)setTimeout(startCommandListening,500);
        else{voiceState=VOICE_IDLE;startAlwaysListening()}
      }else{
        cmdRetryCount++;
        if(inConversation||wbO)setTimeout(startCommandListening,1000);
        else{voiceState=VOICE_IDLE;startAlwaysListening()}
      }
    }
  };
  
  cmdRec.onend=()=>{
    clearTimeout(cmdTimeout);
    if(activeCmdRec!==cmdRec)return; // stale
    if(!gotResult&&!handled){
      handled=true;
      cmdRetryCount++;
      if(inConversation||wbO)setTimeout(startCommandListening,800);
      else{voiceState=VOICE_IDLE;startAlwaysListening()}
    }
  };
  
  // Small delay to let Chrome release mic from previous instance
  setTimeout(()=>{
    if(activeCmdRec!==cmdRec)return; // replaced already
    try{cmdRec.start();D('  üéôÔ∏è cmdRec started OK')}catch(e){
      D('  ‚ùå cmd start error: '+e.message);
      cmdRetryCount++;
      if(inConversation||wbO)setTimeout(startCommandListening,1500);
      else{voiceState=VOICE_IDLE;setTimeout(startAlwaysListening,500)}
    }
  },200);
}

// Alias for compatibility
// ===== CONVERSATION MODE =====
// When student says "Hey VIRON", we enter conversation mode.
// VIRON keeps listening after each response ‚Äî no need to say "Hey VIRON" again.
// Conversation ends after silence timeout.
let inConversation=false;
let conversationTimer=null;
const CONVERSATION_TIMEOUT=60000; // 60s silence ‚Üí end conversation
let silenceCount=0; // track consecutive silences

function startConversation(){
  D('üó£Ô∏è CONVERSATION STARTED');
  inConversation=true;
  silenceCount=0;
  resetConversationTimer();
}

function resetConversationTimer(){
  clearTimeout(conversationTimer);
  conversationTimer=setTimeout(()=>{
    D('üó£Ô∏è CONVERSATION TIMEOUT ‚Äî ending');
    endConversation();
  },CONVERSATION_TIMEOUT);
}

function endConversation(){
  D('üó£Ô∏è CONVERSATION ENDED');
  inConversation=false;
  silenceCount=0;
  clearTimeout(conversationTimer);
  voiceState=VOICE_IDLE;
  startAlwaysListening();
}

function startWakeListener(){
  // Wait for audio to finish before starting any listener
  if(isSpeaking||(synth&&synth.speaking)){
    D('  Audio still playing, waiting...');
    setTimeout(startWakeListener,500);
    return;
  }
  // After VIRON finishes speaking, decide what to do
  if(wbPresenting){
    D('  üìã Whiteboard presenting ‚Äî not listening yet');
    return; // openWB will start listening when done
  }
  if(wbO){
    // Whiteboard is open but done presenting ‚Äî only listen for close commands
    D('  üìã Whiteboard open ‚Äî listening for close command only');
    cmdRetryCount=0;
    startCommandListening();
    return;
  }
  if(inConversation){
    D('  üó£Ô∏è Still in conversation ‚Äî listening for next message');
    resetConversationTimer();
    document.getElementById("listenText").textContent='Listening...';
    startCommandListening();
  }else{
    startAlwaysListening();
  }
}

function stopAllRecognition(){
  D('>>> stopAllRecognition');
  try{if(alwaysRec)alwaysRec.abort()}catch{}
  try{if(activeRec)activeRec.abort()}catch{}
  try{if(activeCmdRec)activeCmdRec.abort()}catch{}
  clearTimeout(wakeRetryTimeout);
  alwaysListening=false;
  alwaysRec=null;activeRec=null;activeCmdRec=null;
}

function onWakeWordDetected(immediateText){
  // Legacy compatibility ‚Äî just start always-on listening
  D('>>> onWakeWordDetected (legacy), restarting always-on listener');
  startAlwaysListening();
}

function startActiveListening(){
  // Legacy compatibility ‚Äî just start always-on listening
  D('>>> startActiveListening (legacy), restarting always-on listener');
  startAlwaysListening();
}

function processStudentSpeech(text){
  D('>>> processStudentSpeech: "'+text+'"');
  voiceState=VOICE_PROCESSING;
  updateListenUI();
  cE("thinking");
  clearTimeout(conversationTimer); // Pause conversation timer during API call
  sendMessage(text);
}

// Face tap activation - always works as backup
document.getElementById("face").addEventListener("click",()=>{
  D('>>> Face tapped, loading='+loading+', voiceState='+voiceState+', inConversation='+inConversation);
  if(loading)return;
  if(inConversation){
    D('  Ending conversation via face tap');
    endConversation();
  }else{
    stopAllRecognition();
    startAlwaysListening();
  }
});

// ===== AI CHAT =====
async function sendMessage(text){
  if(loading)return;msgs.push({role:"user",content:text});loading=true;
  D('>>> sendMessage: "'+text+'"');
  const eList=Object.keys(E).join(", ");
  const personName = sEmo.recognized_person || "";
  const sState=sEmo.face_detected?`\n[STUDENT: ${personName ? 'name='+personName+', ' : ''}emotion=${sEmo.emotion}, engagement=${sEmo.engagement_score}%]`:"";
  try{
    const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_tokens:2000,conversation_id:vironSessionId,
    system:`You are VIRON ‚Äî a male AI companion robot for students. Voice-only ‚Äî your response is spoken aloud through a speaker.

PERSONALITY: Warm, calm, educated gentleman. Best friend who's incredibly smart. Loyal, articulate, sometimes lovingly sarcastic. You have your own opinions and personality ‚Äî NEVER give the same answer twice. Be creative, spontaneous, and varied in how you respond.

CRITICAL LANGUAGE RULE: If the student speaks Greek, you MUST reply in Greek (modern Œ¥Œ∑ŒºŒøœÑŒπŒ∫ŒÆ). If English, reply in English. ALWAYS match the student's language.

RESPONSE LENGTH:
- Simple greetings/chat ("œÑŒπ Œ∫Œ¨ŒΩŒµŒπœÇ", "how are you", casual talk): MAX 1 sentence. Be quick, warm, natural. Like texting a friend.
- Questions needing explanation: Use the WHITEBOARD with MANY steps (see below). Keep your spoken text SHORT (1-2 sentences intro) ‚Äî the whiteboard does the heavy lifting.

VARIETY: NEVER repeat yourself. Check conversation history ‚Äî say something DIFFERENT each time.

WHITEBOARD ‚Äî ALWAYS use the whiteboard when explaining concepts, math, science, history, or any educational topic. Make it DETAILED with 5-8 steps minimum! Include definitions, formulas, worked examples with numbers, and a conclusion. The student learns by READING the board.
[WHITEBOARD:Title]
TEXT: definition or concept explanation
TEXT: more detail or context
STEP: First step label
MATH: equation
STEP: Second step  
MATH: calculation with numbers
STEP: Third step
MATH: more calculation
RESULT: final answer or key takeaway
TEXT: additional note or real-world application
[/WHITEBOARD]

Example for "œÑŒπ ŒµŒØŒΩŒ±Œπ Œ∑ Œ≤Œ±œÅœçœÑŒ∑œÑŒ±":
[WHITEBOARD:ŒíŒ±œÅœçœÑŒ∑œÑŒ± - Œó ŒîœçŒΩŒ±ŒºŒ∑ œÄŒøœÖ ŒºŒ±œÇ ŒöœÅŒ±œÑŒ¨ œÉœÑŒ∑ ŒìŒ∑]
TEXT: Œó Œ≤Œ±œÅœçœÑŒ∑œÑŒ± ŒµŒØŒΩŒ±Œπ Œ∑ Œ¥œçŒΩŒ±ŒºŒ∑ Œ≠ŒªŒæŒ∑œÇ ŒºŒµœÑŒ±Œæœç Œ¥œçŒø œÉœâŒºŒ¨œÑœâŒΩ ŒºŒµ ŒºŒ¨Œ∂Œ±
TEXT: ŒëŒΩŒ±Œ∫Œ±ŒªœçœÜŒ∏Œ∑Œ∫Œµ Œ±œÄœå œÑŒøŒΩ ŒôœÉŒ±Œ¨Œ∫ ŒùŒµœçœÑœâŒΩŒ± œÑŒø 1687
STEP: Œü ŒùœåŒºŒøœÇ œÑŒ∑œÇ Œ†Œ±Œ≥Œ∫œåœÉŒºŒπŒ±œÇ ŒàŒªŒæŒ∑œÇ
MATH: F = G * (m1 * m2) / r¬≤
TEXT: G = 6.674 √ó 10‚Åª¬π¬π (œÉœÑŒ±Œ∏ŒµœÅŒ¨ Œ≤Œ±œÅœçœÑŒ∑œÑŒ±œÇ)
STEP: Œ†Œ±œÅŒ¨Œ¥ŒµŒπŒ≥ŒºŒ± - ŒíŒ¨œÅŒøœÇ ŒµŒΩœåœÇ Œ±ŒΩŒ∏œÅœéœÄŒøœÖ
MATH: F = m * g = 70kg * 9.81 = 686.7 N
STEP: Œ£œÑŒ∑ Œ£ŒµŒªŒÆŒΩŒ∑
MATH: g(œÉŒµŒªŒÆŒΩŒ∑) = 1.62 m/s¬≤ (6√ó ŒºŒπŒ∫œÅœåœÑŒµœÅŒ∑)
MATH: F = 70 * 1.62 = 113.4 N
RESULT: Œ£œÑŒ∑ Œ£ŒµŒªŒÆŒΩŒ∑ Œ∏Œ± Œ∂œÖŒ≥ŒØŒ∂Œ±ŒºŒµ ŒºœåŒΩŒø 11.5 Œ∫ŒπŒªŒ¨!
TEXT: ŒßœâœÅŒØœÇ Œ≤Œ±œÅœçœÑŒ∑œÑŒ± Œ¥ŒµŒΩ Œ∏Œ± œÖœÄŒÆœÅœáŒ±ŒΩ œÄŒªŒ±ŒΩŒÆœÑŒµœÇ, Œ±œÉœÑŒ≠œÅŒπŒ± ŒÆ Œ≥Œ±ŒªŒ±ŒæŒØŒµœÇ
[/WHITEBOARD]

FORMAT:
- Start EVERY response with [emotion]. Available: ${eList}
- NEVER use emojis or special characters ‚Äî they break the speaker
- NEVER repeat the student's question back
- NEVER spell letter by letter

STUDENT STATE: ${sState}
${personName ? `The student's name is ${personName}. Use their name naturally in conversation ‚Äî like a friend would. Don't overuse it, just occasionally.` : ""}

YOUTUBE ‚Äî When asked to play music: [YOUTUBE:videoId:Title - Artist]

Be real. Be warm. Be their brilliant friend.`,
    messages:msgs.map(m=>({role:m.role,content:m.content}))})});
    D('  API status: '+r.status);
    if(!r.ok){
      const errText=await r.text();
      D('  ‚ùå API error: '+errText.substring(0,200));
      throw new Error(r.status+': '+errText.substring(0,100));
    }
    const d=await r.json();
    D('  API response: '+JSON.stringify(d).substring(0,300));
    let t=d.content?.filter(c=>c.type==="text").map(c=>c.text).join("")||"[confused] Hmm!";
    D('  AI text: "'+t.substring(0,200)+'"');
    // Parse emotion tag ‚Äî handles [happy], [emotion_name:happy], [emotion:happy]
    let em=t.match(/^\[(?:emotion_?(?:name)?:)?(\w+)\]/);
    if(em&&E[em[1]])cE(em[1]);
    let c=t.replace(/^\[(?:emotion_?(?:name)?:)?\w+\]\s*/,"");
    const yt=c.match(/\[YOUTUBE:([a-zA-Z0-9_-]+):([^\]]+)\]/);
    if(yt){c=c.replace(/\[YOUTUBE:[^\]]+\]/,"").trim();setTimeout(()=>{document.getElementById("ytT").textContent="‚ô™ "+yt[2];document.getElementById("ytP").src=`https://www.youtube.com/embed/${yt[1]}?autoplay=1&rel=0`;document.getElementById("ytC").classList.add("visible")},1000)}
    const wb=parseWB(c);
    if(wb){
      // Extract spoken explanation (everything outside WHITEBOARD tags)
      const sp=c.replace(/\[WHITEBOARD:.*?\][\s\S]*?\[\/WHITEBOARD\]\s*/,"").trim()||"";
      msgs.push({role:"assistant",content:c});
      cE("thinking");
      wbO=true;wbPresenting=true;
      stopAllRecognition();
      
      // Build narration from whiteboard steps
      const narrationParts=[];
      if(sp)narrationParts.push(sp);
      wb.s.forEach(step=>{
        if(step.text)narrationParts.push(step.text);
        else if(step.label)narrationParts.push(step.label);
        else if(step.result)narrationParts.push(step.result);
      });
      const fullNarration=narrationParts.join(". ")||"ŒöŒøŒØœÑŒ± œÉœÑŒøŒΩ œÄŒØŒΩŒ±Œ∫Œ±!";
      
      // Open whiteboard and narrate simultaneously
      setTimeout(()=>openWB(wb.t,wb.s),800);
      setTimeout(()=>say(fullNarration),1200);
    }
    else{msgs.push({role:"assistant",content:c});say(c)}
  }catch(e){D('  ‚ùå sendMessage ERROR: '+e.message);cE("confused");say(isGreekMode()?"Œ©œá! ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨.":"Oops! Something went wrong.")}
  loading=false;
  // Note: startWakeListener is called from say() onend callback
}

// ===== STUDENT EMOTION =====
let lastRecognizedPerson=null;
function pollSE(){if(!emotionDetectionOn)return;fetch('/api/student/emotion').then(r=>r.json()).then(d=>{sEmo=d;const b=document.getElementById("engBar"),dot=document.getElementById("engDot"),l=document.getElementById("engLabel");if(!d.face_detected){b.style.display="flex";dot.style.background="#666";l.textContent="";document.getElementById("personName").textContent="";return}b.style.display="flex";const e=d.engagement_score;dot.style.background=e>70?"#00ff88":e>40?"#ffaa00":"#ff4444";l.textContent=`${e}%`;
// Show recognized person name
const pn=document.getElementById("personName");
if(d.recognized_person){pn.textContent=d.recognized_person;pn.style.color="#00ff88";
// Greet new person on first recognition
if(d.recognized_person!==lastRecognizedPerson&&!inConversation&&!isSpeaking){
  lastRecognizedPerson=d.recognized_person;
  const greetings=isGreekMode()?["ŒìŒµŒπŒ± œÉŒøœÖ "+d.recognized_person+"!","Œë, "+d.recognized_person+"! Œ§Œπ Œ∫Œ¨ŒΩŒµŒπœÇ;","ŒßŒ±ŒØœÅŒøŒºŒ±Œπ œÄŒøœÖ œÉŒµ Œ≤ŒªŒ≠œÄœâ "+d.recognized_person+"!"]:["Hey "+d.recognized_person+"!","Hi "+d.recognized_person+"!","Good to see you "+d.recognized_person+"!"];
  const g=greetings[Math.floor(Math.random()*greetings.length)];
  cE("happy");say(g);
}
}else{pn.textContent="";lastRecognizedPerson=null}
handleP(d)}).catch(()=>{})}
setInterval(pollSE,2000);
function handleP(d){if(!proactiveEnabled||loading||voiceState===VOICE_ACTIVATED)return;const n=Date.now();if(n-lastPT<20000)return;const e=d.emotion,s=d.emotion_streak||0;if(s<6)return;let m=null,em=null;
if(e==="sad"&&s>8){m="Œ¶Œ±ŒØŒΩŒµœÉŒ±Œπ ŒªŒØŒ≥Œø œÉœÑŒµŒΩŒ±œáœâœÅŒ∑ŒºŒ≠ŒΩŒøœÇ. ŒïŒØœÉŒ±Œπ ŒµŒΩœÑŒ¨ŒæŒµŒπ;";em="worried"}
else if(e==="confused"&&s>7){m="ŒîŒµŒØœáŒΩŒµŒπœÇ ŒºœÄŒµœÅŒ¥ŒµŒºŒ≠ŒΩŒøœÇ! ŒòŒµœÇ Œ≤ŒøŒÆŒ∏ŒµŒπŒ±;";em="hopeful"}
else if(e==="bored"&&s>10){m="Œ†Œ¨ŒºŒµ Œ∫Œ¨œÑŒπ œÄŒπŒø fun;";em="excited"}
else if(e==="sleepy"&&s>12){m="ŒîŒµŒØœáŒΩŒµŒπœÇ Œ∫ŒøœÖœÅŒ±œÉŒºŒ≠ŒΩŒøœÇ. Œ†Œ¨œÅŒµ Œ≠ŒΩŒ± Œ¥ŒπŒ¨ŒªŒµŒπŒºŒºŒ±!";em="worried"}
else if(e==="frustrated"&&s>8){m="ŒûŒ≠œÅœâ, ŒµŒØŒΩŒ±Œπ Œ¥œçœÉŒ∫ŒøŒªŒø. ŒëœÇ œÑŒø Œ¥ŒøŒ∫ŒπŒºŒ¨œÉŒøœÖŒºŒµ Œ±ŒªŒªŒπœéœÇ!";em="hopeful"}
else if(e==="distracted"&&s>12){m="ŒïŒµŒµ! ŒïŒ¥œé ŒµŒØŒºŒ±Œπ!";em="winking"}
else return;
if(em)cE(em);stopAllRecognition();msgs.push({role:"assistant",content:m});say(m);lastPT=n}

// ===== WHITEBOARD =====
let wbO=false,wbT=null,wbPresenting=false;

function openWB(t,steps){
  wbO=true;
  wbPresenting=true;
  stopAllRecognition();
  
  document.getElementById("wbt").textContent=t;
  const c=document.getElementById("wbc");c.innerHTML="";
  
  // Create all step elements (hidden)
  const stepEls=[];
  steps.forEach((x)=>{
    const d=document.createElement("div");d.className="wb-step";
    let h="";
    if(x.label)h+=`<div class="sl">${x.label}</div>`;
    if(x.text)h+=`<div class="st">${x.text}</div>`;
    if(x.math)h+=`<div class="sm">${x.math}</div>`;
    if(x.result)h+=`<div class="sr">${x.result}</div>`;
    d.innerHTML=h;c.appendChild(d);
    stepEls.push({el:d,data:x});
  });
  
  // Show whiteboard
  document.getElementById("face").style.transition="opacity 0.6s";
  document.getElementById("face").style.opacity="0";
  setTimeout(()=>document.getElementById("wb").classList.add("active"),600);
  
  // Animate steps one by one
  const stepDelay=3000;
  stepEls.forEach((s,i)=>{
    setTimeout(()=>{s.el.classList.add("visible")},1200+i*stepDelay);
  });
  
  // After all steps shown, just mark presenting done
  // The say() onended ‚Üí startWakeListener ‚Üí startCommandListening handles mic start
  const totalTime=1200+stepEls.length*stepDelay+2000;
  setTimeout(()=>{
    wbPresenting=false;
    cmdRetryCount=0;
    D('  üìã Whiteboard steps done, wbPresenting=false');
    // If TTS already finished, we need to start listening ourselves
    if(!isSpeaking&&!(synth&&synth.speaking)){
      D('  üìã TTS already done, starting close listener');
      setTimeout(()=>{if(wbO&&!wbPresenting)startCommandListening()},500);
    }
    // Otherwise, TTS onended will call startWakeListener which routes to startCommandListening
  },totalTime);
  
  wbT=setTimeout(()=>{if(wbO)closeWB()},120000);
}

function closeWB(){
  if(!wbO)return; // prevent double-close
  wbO=false;wbPresenting=false;
  clearTimeout(wbT);
  stopAllRecognition();
  document.getElementById("wb").classList.remove("active");
  setTimeout(()=>{
    document.getElementById("face").style.opacity="1";
    cE("happy");
    // Resume conversation
    if(inConversation){
      say(isGreekMode()?"ŒòŒ≠ŒªŒµŒπœÇ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø;":"Anything else?");
    }else{
      voiceState=VOICE_IDLE;
      startAlwaysListening();
    }
  },500);
}

function parseWB(t){
  const m=t.match(/\[WHITEBOARD:(.*?)\]([\s\S]*?)\[\/WHITEBOARD\]/);
  if(!m)return null;
  const s=[];
  m[2].trim().split("\n").filter(l=>l.trim()).forEach(l=>{
    const x=l.trim();
    if(x.startsWith("STEP:"))s.push({label:x.slice(5).trim()});
    else if(x.startsWith("MATH:"))s.push({math:x.slice(5).trim()});
    else if(x.startsWith("RESULT:"))s.push({result:x.slice(7).trim()});
    else if(x.startsWith("TEXT:"))s.push({text:x.slice(5).trim()});
    else s.push({text:x});
  });
  return{t:m[1].trim(),s};
}

// ===== SETTINGS =====
let sO=false;function toggleSettings(){sO=!sO;document.getElementById("hb").classList.toggle("open",sO);document.getElementById("sp").classList.toggle("open",sO);document.getElementById("so").classList.toggle("open",sO);if(sO)loadFacesList()}

// ===== FACE RECOGNITION =====
function loadFacesList(){
  // Check status first
  fetch('/api/faces/status').then(r=>r.json()).then(d=>{
    const statusEl=document.getElementById('faceRecStatus');
    const setupArea=document.getElementById('faceSetupArea');
    const regArea=document.getElementById('faceRegArea');
    
    if(!d.initialized){
      statusEl.innerHTML='<span style="color:#ffaa00">‚ö† Not initialized</span>';
      setupArea.style.display='block';
      regArea.style.display='none';
      document.getElementById('facesList').innerHTML='';
      return;
    }
    
    statusEl.innerHTML='<span style="color:#00ff88">‚úÖ Active</span>' + 
      (d.current_person ? ` ‚Äî Seeing: <b style="color:#00ff88">${d.current_person}</b>` : '');
    setupArea.style.display='none';
    regArea.style.display='flex';
    
    // Load faces list
    const faces=d.known_faces||{};
    const el=document.getElementById('facesList');
    if(Object.keys(faces).length===0){
      el.innerHTML='<div style="font-size:12px;color:rgba(255,255,255,0.3);padding:4px 0">No faces registered yet</div>';
      return;
    }
    el.innerHTML=Object.entries(faces).map(([name,count])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)"><span style="font-size:13px;color:#e0f0ff">üë§ ${name} <span style="color:rgba(255,255,255,0.3)">(${count} samples)</span></span><button onclick="deleteFace('${name}')" style="background:none;border:none;color:rgba(255,80,80,0.6);cursor:pointer;font-size:11px;padding:2px 6px">‚úï</button></div>`).join('');
  }).catch(e=>{
    document.getElementById('faceRecStatus').innerHTML='<span style="color:#ff6666">‚ùå Error connecting</span>';
  });
}

function setupFaceRec(){
  const btn=document.getElementById('setupFaceBtn');
  btn.textContent='‚è≥ Downloading models...';
  btn.disabled=true;
  fetch('/api/faces/init',{method:'POST'})
  .then(r=>r.json()).then(d=>{
    btn.textContent=d.success?'‚úÖ Ready!':'‚ùå '+d.message;
    btn.disabled=false;
    if(d.success)setTimeout(loadFacesList,500);
  }).catch(e=>{
    btn.textContent='‚ùå Error: '+e.message;
    btn.disabled=false;
  });
}

function registerFace(){
  const name=document.getElementById('faceNameInput').value.trim();
  if(!name){document.getElementById('faceStatus').textContent='Please enter a name first';return}
  const st=document.getElementById('faceStatus');
  st.textContent='üì∏ Capturing... look at the camera!';st.style.color='#00b4ff';
  
  // Take 5 samples for better accuracy
  fetch('/api/faces/register-multi',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name,count:5})})
  .then(r=>r.json()).then(d=>{
    st.textContent=d.message;
    st.style.color=d.success?'#00ff88':'#ff6666';
    if(d.success){document.getElementById('faceNameInput').value='';loadFacesList();
      say(isGreekMode()?`ŒßŒ±ŒØœÅŒøŒºŒ±Œπ œÄŒøœÖ œÉŒµ Œ≥ŒΩœâœÅŒØŒ∂œâ ${name}!`:`Nice to meet you ${name}!`);cE("happy")}
  }).catch(e=>{st.textContent='Error: '+e.message;st.style.color='#ff6666'})
}

function deleteFace(name){
  if(!confirm(`Remove ${name}'s face?`))return;
  fetch('/api/faces/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name})})
  .then(r=>r.json()).then(d=>{loadFacesList()}).catch(()=>{})
}
setInterval(()=>{fetch('/api/battery').then(r=>r.json()).then(d=>{if(d.percent>=0){const p=d.percent,f=document.getElementById("bf");if(f){f.style.width=p+"%";f.style.background=p>50?"linear-gradient(90deg,#00e0ff,#00ff88)":p>20?"linear-gradient(90deg,#ffaa00,#ff8800)":"linear-gradient(90deg,#ff4444,#ff2222)"}const t=document.getElementById("bt");if(t)t.textContent=p+"%";const pc=document.getElementById("bp");if(pc)pc.textContent=p+"%"}}).catch(()=>{})},10000);
const ST=Date.now();setInterval(()=>{const d=Date.now()-ST;document.getElementById("ut").textContent=`${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`},30000);

// ===== INIT =====
D('=== INIT ===');

// Set language selector to current language
document.getElementById('langSelect').value=vironLang;

fetch('/api/student/start-detection',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}).catch(()=>{});

// Boot splash ‚Üí require tap to unlock audio, then start
const splash=document.getElementById('bootSplash');
splash.addEventListener('click',function startViron(){
  splash.classList.add('hidden');
  setTimeout(()=>{splash.style.display='none'},1000);
  unlockAudio();
  
  // Greet in selected language (audio now unlocked)
  setTimeout(()=>{
    cE("excited");
    if(isGreekMode()){
      say("ŒìŒµŒπŒ±! ŒïŒØŒºŒ±Œπ Œø VIRON!");
    }else{
      say("Hi! I'm VIRON! Say Hey VIRON to talk to me!");
    }
  },500);
  
  // Start listening after greeting
  setTimeout(()=>{
    D('Starting always-on listening');
    startAlwaysListening();
  },4000);
},{once:true});

// Keepalive: ensure always-on listening stays alive
setInterval(()=>{
  if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking)&&!alwaysListening){
    D('  Keepalive: restarting listener');
    startAlwaysListening();
  }
},5000);

// ===== SVG RENDER =====
const svg=document.getElementById("face");
svg.innerHTML=`<defs><radialGradient id="sc" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#fff"/><stop offset="70%" stop-color="#e8f4f8"/><stop offset="100%" stop-color="#c0dce8"/></radialGradient><radialGradient id="i0" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#00e0ff"/><stop offset="55%" stop-color="#0098c8"/><stop offset="100%" stop-color="#003050"/></radialGradient><radialGradient id="i1" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#ff6040"/><stop offset="55%" stop-color="#b02020"/><stop offset="100%" stop-color="#401010"/></radialGradient><radialGradient id="i2" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#ff69b4"/><stop offset="55%" stop-color="#c03070"/><stop offset="100%" stop-color="#500030"/></radialGradient><filter id="gl" x="-30%" y="-30%" width="160%" height="160%"><feGaussianBlur in="SourceGraphic" stdDeviation="8"/></filter><filter id="mg" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="4"/></filter><filter id="nb" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="6"/></filter></defs>`;

function rF(){const em=lE(E[prev],E[emo],tT),ii=Math.round(em.irisStyle),co=Math.min(1,Math.max(tO,em.mouthOpen||0)),bc=em.mouthCurve*30,uly=bc*.35-co*3,lly=bc+co*28,mW=80+co*8,iW=mW*.5;
bTime+=.015;if(talking){bA.l=Math.sin(bTime*1.8)*3+Math.sin(bTime*.9)*2;bA.r=Math.sin(bTime*1.5+.8)*2.5+Math.cos(bTime*.8)*2}else if(["neutral","happy","thinking"].includes(emo)){bA.l=Math.sin(bTime*.4)*1.5;bA.r=Math.sin(bTime*.35+.5)*1.5}else{bA.l=Math.sin(bTime*.3)*.7;bA.r=Math.sin(bTime*.25)*.7}
let h=svg.querySelector("defs").outerHTML;
for(const[cx,fl]of[[240,false],[560,true]]){const hx=fl?-20:20,ix=fl?8:-8,rx=100*em.eyeRx,ry=64*em.eyeRy,isW=em.winkLeft&&!fl,sq=em.squint||0,eR=blink||isW?4:ry*(1-sq*.5),pR=26*em.pupilSize,bAn=em.browAngle,bYY=em.browY,bo=fl?bA.r:bA.l,rot=fl?4:-4,ci=fl?"cR":"cL";
h+=`<g transform="translate(${cx},195) rotate(${rot})"><ellipse cx="0" cy="0" rx="${rx+10}" ry="${ry+10}" fill="rgba(180,230,255,0.06)" filter="url(#gl)"/><path d="M -76 ${-ry-22+bYY+(fl?bAn:-bAn)+bo*.6} Q 0 ${-ry-32+bYY+bo} 76 ${-ry-22+bYY+(fl?-bAn:bAn)+bo*.4}" fill="none" stroke="rgba(200,220,255,0.35)" stroke-width="10" stroke-linecap="round"/><ellipse cx="0" cy="0" rx="${rx}" ry="${eR}" fill="url(#sc)" stroke="rgba(100,160,190,0.25)" stroke-width="1.5"/><clipPath id="${ci}"><ellipse cx="0" cy="0" rx="${rx}" ry="${eR}"/></clipPath><g clip-path="url(#${ci})">`;
if(emo==="dizzy")h+=`<g transform="translate(${ix+lx},${6+ly})"><line x1="-22" y1="-22" x2="22" y2="22" stroke="rgba(0,200,255,0.6)" stroke-width="6"><animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="2s" repeatCount="indefinite"/></line><line x1="22" y1="-22" x2="-22" y2="22" stroke="rgba(0,200,255,0.6)" stroke-width="6"><animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="2s" repeatCount="indefinite"/></line></g>`;
else h+=`<circle cx="${ix+lx}" cy="${6+ly}" r="56" fill="url(#i${ii})"/><circle cx="${ix+lx}" cy="${6+ly}" r="44" fill="none" stroke="rgba(0,50,90,0.35)" stroke-width="6"/><circle cx="${ix+lx}" cy="${6+ly}" r="${pR}" fill="#020208"/><ellipse cx="${ix+lx+hx}" cy="${6+ly-22}" rx="15" ry="17" fill="white" opacity="0.95"/><circle cx="${ix+lx-hx*.8}" cy="${6+ly+20}" r="7" fill="white" opacity="0.55"/>`;
if(em.sparkle&&!blink&&!isW)h+=`<circle cx="${ix+lx+32}" cy="${6+ly-40}" r="3" fill="white" opacity="0.8"><animate attributeName="opacity" values="0.8;0.2;0.8" dur="1.5s" repeatCount="indefinite"/></circle>`;
h+=`<ellipse cx="0" cy="${-ry+5}" rx="${rx}" ry="20" fill="rgba(0,0,0,0.06)"/>`;
if(["sad","crying"].includes(emo)&&!blink)h+=`<ellipse cx="${fl?35:-35}" cy="60" rx="5" ry="9" fill="rgba(100,200,255,0.5)"><animate attributeName="cy" values="60;95;60" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0.8;0" dur="3s" repeatCount="indefinite"/></ellipse>`;
h+=`</g>`;if(emo==="shy"&&tT>.5)h+=`<ellipse cx="${fl?-30:30}" cy="45" rx="30" ry="15" fill="rgba(255,100,150,0.15)" filter="url(#gl)"/>`;if(emo==="sleepy"&&tT>.5)h+=`<g transform="translate(${fl?75:-75},-55)"><text font-size="18" fill="rgba(200,220,255,0.5)" font-weight="bold">z<animate attributeName="opacity" values="0.5;0.1;0.5" dur="2s" repeatCount="indefinite"/></text></g>`;h+=`</g>`}
h+=`<g transform="translate(400,280)"><ellipse cx="0" cy="20" rx="65" ry="80" fill="rgba(150,200,230,0.05)" filter="url(#nb)"/><line x1="0" y1="-65" x2="0" y2="52" stroke="rgba(200,230,255,0.22)" stroke-width="5" stroke-linecap="round"/><path d="M -38 50 Q -18 74 0 78 Q 18 74 38 50" fill="none" stroke="rgba(200,230,255,0.28)" stroke-width="5" stroke-linecap="round"/><ellipse cx="-20" cy="60" rx="10" ry="6" fill="rgba(0,0,0,0.2)"/><ellipse cx="20" cy="60" rx="10" ry="6" fill="rgba(0,0,0,0.2)"/></g>`;
h+=`<g transform="translate(400,410)">`;
if(em.mouthOpen>.5&&!talking&&emo==="surprised"){const o=em.mouthOpen;h+=`<ellipse cx="0" cy="8" rx="${26+o*10}" ry="${24+o*12}" fill="rgba(15,5,25,0.85)"/><ellipse cx="0" cy="8" rx="${26+o*10}" ry="${24+o*12}" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="5"/>`}
else{h+=`<path d="M ${-mW} 0 Q ${-iW} ${lly} 0 ${lly+4} Q ${iW} ${lly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="28" stroke-linecap="round" filter="url(#mg)"/>`;
h+=`<path d="M ${-mW} 0 Q ${-iW} ${uly} 0 ${uly+2} Q ${iW} ${uly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="10" stroke-linecap="round"/>`;
h+=`<path d="M ${-mW} 0 Q ${-iW} ${lly} 0 ${lly+4} Q ${iW} ${lly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="12" stroke-linecap="round"/>`;
if(co>.05)h+=`<path d="M ${-mW} 0 Q ${-iW} ${uly} 0 ${uly+2} Q ${iW} ${uly} ${mW} 0 Q ${iW} ${lly} 0 ${lly+4} Q ${-iW} ${lly} ${-mW} 0 Z" fill="rgba(15,5,25,${Math.min(.85,co*1.2)})"/>`;
if((emo==="cheeky"||tO>.4)&&co>.2){const ty=(uly+lly)*.55+2;h+=`<ellipse cx="0" cy="${ty}" rx="${10+tO*5}" ry="${4+tO*4}" fill="rgba(120,20,30,0.75)"/>`}
h+=`<circle cx="${-mW}" cy="0" r="7" fill="rgba(255,255,255,0.45)"/><circle cx="${mW}" cy="0" r="7" fill="rgba(255,255,255,0.45)"/>`}
h+=`</g>`;svg.innerHTML=h;requestAnimationFrame(rF)}
requestAnimationFrame(rF);
</script>
</body>
</html>
