<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIRON</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#e0f0ff;font-family:'Segoe UI',sans-serif;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center;transition:opacity 0.5s}
svg{width:min(95vw,800px);height:auto;min-height:40vh;-webkit-tap-highlight-color:transparent;display:block}
/* Listening indicator */
.listen-indicator{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px;opacity:0;transition:all 0.5s;pointer-events:none}
.listen-indicator.active{opacity:1}
.listen-indicator.active .bar{background:rgba(255,80,80,0.9);animation:barPulse 0.6s ease-in-out infinite}
.listen-indicator.active .listen-text{color:rgba(255,100,100,0.8)}
.listen-indicator.wake{opacity:0.4}
.listen-bars{display:flex;gap:3px;align-items:center;height:20px}
.listen-bars .bar{width:3px;background:rgba(0,200,255,0.6);border-radius:2px;transition:height 0.15s}
.listen-indicator.speaking .bar{background:rgba(255,50,50,1);animation:barSpeak 0.3s ease-in-out infinite}
.listen-indicator.speaking{opacity:1}
.listen-indicator.speaking .listen-text{color:rgba(255,80,80,0.9)}
.listen-indicator.wake .bar{background:rgba(0,200,255,0.4);height:4px!important;animation:none}
.bar:nth-child(1){animation-delay:0s!important}
.bar:nth-child(2){animation-delay:0.1s!important}
.bar:nth-child(3){animation-delay:0.2s!important}
.bar:nth-child(4){animation-delay:0.1s!important}
.bar:nth-child(5){animation-delay:0s!important}
@keyframes barPulse{0%,100%{height:6px}50%{height:20px}}
@keyframes barSpeak{0%,100%{height:8px}50%{height:28px}}
.listen-text{font-size:13px;color:rgba(255,255,255,0.5);letter-spacing:1px}
.listen-indicator.active .listen-text{color:rgba(255,100,100,0.7)}
/* Subtitle */
.subtitle{position:fixed;bottom:35px;left:50%;transform:translateX(-50%);max-width:85vw;text-align:center;font-size:16px;color:rgba(255,255,255,0.85);background:rgba(0,0,0,0.6);padding:10px 24px;border-radius:20px;backdrop-filter:blur(10px);opacity:0;transition:opacity 0.4s;pointer-events:none;line-height:1.5}
.subtitle.visible{opacity:1}
/* Engagement */
.engagement-bar{position:fixed;top:12px;left:12px;display:none;align-items:center;gap:8px;z-index:50;background:rgba(0,0,0,0.5);padding:4px 10px;border-radius:20px;font-size:11px}
.eng-dot{width:8px;height:8px;border-radius:50%;transition:background 0.5s}
.eng-label{color:rgba(255,255,255,0.5)}
/* Hamburger + Settings */
.hamburger{position:fixed;top:12px;right:12px;width:40px;height:40px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;z-index:100;transition:all 0.2s}
.hamburger:hover{background:rgba(255,255,255,0.12)}
.hamburger span{display:block;width:20px;height:2px;background:rgba(255,255,255,0.6);border-radius:2px;transition:all 0.3s}
.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
.hamburger.open span:nth-child(2){opacity:0}
.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:90;opacity:0;pointer-events:none;transition:opacity 0.3s}
.settings-overlay.open{opacity:1;pointer-events:all}
.settings-panel{position:fixed;top:0;right:-320px;width:300px;height:100vh;background:rgba(8,12,22,0.97);border-left:1px solid rgba(255,255,255,0.08);z-index:95;padding:60px 20px 20px;overflow-y:auto;transition:right 0.3s ease;backdrop-filter:blur(20px)}
.settings-panel.open{right:0}
.settings-panel h2{font-size:18px;color:#e0f0ff;margin-bottom:20px}
.setting-group{margin-bottom:20px}
.setting-group h3{font-size:12px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.setting-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:10px;margin-bottom:6px}
.setting-item label{font-size:13px;color:#c0d8e8;display:flex;align-items:center;gap:8px}
input[type="range"]{-webkit-appearance:none;width:120px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:rgba(0,200,255,0.8);border-radius:50%;cursor:pointer}
.toggle{width:42px;height:22px;background:rgba(255,255,255,0.12);border-radius:11px;position:relative;cursor:pointer;transition:background 0.3s;border:none}
.toggle.on{background:rgba(0,200,255,0.35)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left 0.2s}
.toggle.on::after{left:22px}
.wifi-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:4px;font-size:12px}
.wifi-item.connected{background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2)}
.battery-bar{width:100%;height:20px;background:rgba(255,255,255,0.08);border-radius:10px;overflow:hidden;position:relative}
.battery-fill{height:100%;border-radius:10px;transition:width 0.5s}
.battery-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:600;color:#fff}
.sbtn{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#e0f0ff;font-size:13px;cursor:pointer;transition:all 0.2s;margin-bottom:6px}
.sbtn:hover{background:rgba(255,255,255,0.08)}
.sbtn.danger{border-color:rgba(255,80,80,0.2);color:rgba(255,100,100,0.7)}
/* YouTube */
.yt-container{position:fixed;bottom:20px;right:20px;z-index:70;background:rgba(5,10,20,0.95);border:1px solid rgba(0,200,255,0.15);border-radius:16px;padding:10px;display:none;backdrop-filter:blur(20px)}
.yt-container.visible{display:block}
.yt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.yt-title{font-size:12px;color:rgba(255,255,255,0.5);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.yt-close{background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;font-size:16px}
/* Whiteboard */
.wb-overlay{position:fixed;inset:0;z-index:80;pointer-events:none;opacity:0;transition:opacity 0.8s}
/* Boot splash */
.boot-splash{position:fixed;inset:0;z-index:200;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 1s;cursor:pointer}
.boot-splash.hidden{opacity:0;pointer-events:none}
.boot-splash img{width:min(60vw,400px);animation:bootPulse 2s ease-in-out infinite}
.boot-splash .boot-text{color:rgba(0,200,255,0.6);font-size:14px;margin-top:24px;letter-spacing:3px;animation:bootFade 1.5s ease-in-out infinite alternate}
@keyframes bootPulse{0%,100%{transform:scale(1);opacity:0.9}50%{transform:scale(1.03);opacity:1}}
@keyframes bootFade{0%{opacity:0.3}100%{opacity:0.8}}
.wb-overlay.active{opacity:1;pointer-events:all}
.wb-bg{position:absolute;inset:0;background:#f5f5f0}
.wb-hdr{position:absolute;top:12px;left:16px;right:16px;display:flex;justify-content:space-between;align-items:center;z-index:2}
.wb-title{font-size:14px;color:#444;font-weight:600}
.wb-close{background:rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.1);border-radius:8px;padding:6px 14px;font-size:12px;color:#555;cursor:pointer}
.wb-content{position:absolute;top:50px;left:20px;right:20px;bottom:20px;overflow-y:auto;font-family:Georgia,serif}
.wb-step{opacity:0;transform:translateY(15px);transition:all 1.2s ease-out;margin-bottom:16px}
.wb-step.visible{opacity:1;transform:translateY(0)}
.wb-step .sl{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.wb-step .sm{font-size:24px;color:#1a5276;font-family:'Courier New',monospace;background:rgba(0,0,0,0.03);padding:12px 16px;border-radius:8px;border-left:4px solid #2980b9;margin:8px 0}
.wb-step .st{font-size:18px;color:#222;line-height:1.6}
.wb-step .sr{font-size:28px;color:#27ae60;font-weight:700;text-align:center;padding:16px;background:rgba(39,174,96,0.08);border-radius:12px;border:2px solid rgba(39,174,96,0.2)}
</style>
</head>
<body>
<div class="boot-splash" id="bootSplash">
  <img src="/static/viron-logo.png" alt="VIRON">
  <div class="boot-text">TAP TO START</div>
</div>

<!-- SETUP WIZARD (first-time setup) -->
<div id="setupWizard" style="display:none;position:fixed;inset:0;z-index:190;background:#000;overflow-y:auto">
  <div style="max-width:400px;margin:0 auto;padding:30px 20px;text-align:center">
    <img src="/static/viron-logo.png" alt="VIRON" style="width:120px;margin-bottom:10px">
    <h2 style="color:#00d4ff;margin:0 0 5px">Welcome to VIRON!</h2>
    <p style="color:rgba(255,255,255,0.5);font-size:13px;margin:0 0 25px">Let's get to know each other</p>
    
    <!-- Step 1: Name -->
    <div id="setupStep1" class="setup-step">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">What's your name?</label>
      <input id="setupName" type="text" placeholder="e.g. ÎœÎ±ÏÎ¯Î± / Maria" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,200,255,0.3);background:rgba(255,255,255,0.08);color:#fff;font-size:16px;text-align:center;outline:none;box-sizing:border-box">
      <div style="margin-top:15px">
        <button onclick="setupNext(2)" style="padding:10px 30px;background:linear-gradient(135deg,#00d4ff,#0088cc);border:none;border-radius:10px;color:#fff;font-size:15px;cursor:pointer">Next â†’</button>
      </div>
    </div>
    
    <!-- Step 2: Photo -->
    <div id="setupStep2" class="setup-step" style="display:none">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">Take a photo so I can recognize you!</label>
      <div id="setupCameraPreview" style="width:200px;height:200px;border-radius:50%;overflow:hidden;margin:10px auto;border:3px solid rgba(0,200,255,0.4);background:#111">
        <img id="setupCamImg" style="width:100%;height:100%;object-fit:cover">
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button onclick="setupTakePhoto()" style="padding:10px 20px;background:linear-gradient(135deg,#00d4ff,#0088cc);border:none;border-radius:10px;color:#fff;font-size:14px;cursor:pointer">ğŸ“¸ Take Photo</button>
        <button onclick="setupNext(3)" style="padding:10px 20px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer">Skip â†’</button>
      </div>
      <p id="setupPhotoStatus" style="color:rgba(255,255,255,0.4);font-size:12px;margin-top:8px"></p>
    </div>
    
    <!-- Step 3: Age -->
    <div id="setupStep3" class="setup-step" style="display:none">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">Let me learn your voice! ğŸ™ï¸</label>
      <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 15px">Read the sentences below so I only listen to YOU</p>
      <div id="voiceEnrollStatus" style="margin:10px 0">
        <div id="voiceEnrollSamples" style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
          <span class="voice-dot" id="vdot1">â‘ </span>
          <span class="voice-dot" id="vdot2">â‘¡</span>
          <span class="voice-dot" id="vdot3">â‘¢</span>
        </div>
        <p id="voiceEnrollPrompt" style="color:#fff;font-size:15px;font-style:italic;margin:10px 0">"Hello VIRON, my name is <span id="voiceEnrollName"></span>"</p>
        <div id="voiceEnrollMeter" style="width:80%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:10px auto;overflow:hidden">
          <div id="voiceEnrollLevel" style="width:0%;height:100%;background:#00d4ff;border-radius:2px;transition:width 0.1s"></div>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="voiceEnrollBtn" onclick="voiceEnrollRecord()" style="padding:10px 20px;background:linear-gradient(135deg,#ff4444,#cc2222);border:none;border-radius:10px;color:#fff;font-size:14px;cursor:pointer">ğŸ™ï¸ Hold to Record</button>
        <button onclick="setupNext(4)" style="padding:10px 20px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer">Skip â†’</button>
      </div>
      <p id="voiceEnrollMsg" style="color:rgba(255,255,255,0.4);font-size:12px;margin-top:8px"></p>
    </div>

    <!-- Step 4: Age -->
    <div id="setupStep4" class="setup-step" style="display:none">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">How old are you?</label>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button onclick="setupSetAge(6)" class="age-btn">6-8</button>
        <button onclick="setupSetAge(9)" class="age-btn">9-10</button>
        <button onclick="setupSetAge(11)" class="age-btn">11-12</button>
        <button onclick="setupSetAge(13)" class="age-btn">13-14</button>
        <button onclick="setupSetAge(15)" class="age-btn">15-16</button>
        <button onclick="setupSetAge(17)" class="age-btn">17-18</button>
        <button onclick="setupSetAge(20)" class="age-btn">18+</button>
      </div>
    </div>
    
    <!-- Step 5: Language -->
    <div id="setupStep5" class="setup-step" style="display:none">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">Which language do you prefer?</label>
      <div style="display:flex;gap:10px;justify-content:center">
        <button onclick="setupSetLang('el')" style="padding:15px 25px;background:rgba(0,100,255,0.2);border:2px solid rgba(0,150,255,0.4);border-radius:12px;color:#fff;font-size:18px;cursor:pointer">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</button>
        <button onclick="setupSetLang('en')" style="padding:15px 25px;background:rgba(0,100,255,0.2);border:2px solid rgba(0,150,255,0.4);border-radius:12px;color:#fff;font-size:18px;cursor:pointer">ğŸ‡¬ğŸ‡§ English</button>
      </div>
    </div>
    
    <!-- Step 6: WiFi (optional) -->
    <div id="setupStep6" class="setup-step" style="display:none">
      <label style="color:#00d4ff;font-size:14px;display:block;margin-bottom:8px">Connect to WiFi</label>
      <div id="setupWifiList" style="max-height:200px;overflow-y:auto;margin:10px 0"></div>
      <div id="setupWifiQR" style="margin:15px auto;display:none">
        <p style="color:rgba(255,255,255,0.5);font-size:12px">Scan to access VIRON from your phone:</p>
        <img id="setupQRImg" style="width:150px;height:150px;border-radius:8px">
      </div>
      <div style="margin-top:10px">
        <button onclick="setupFinish()" style="padding:10px 30px;background:linear-gradient(135deg,#00ff88,#00cc66);border:none;border-radius:10px;color:#000;font-size:15px;font-weight:bold;cursor:pointer">âœ… Done â€” Start VIRON!</button>
      </div>
    </div>
    
    <!-- Skip all -->
    <div style="margin-top:30px">
      <button onclick="setupFinish()" style="background:none;border:none;color:rgba(255,255,255,0.3);font-size:13px;cursor:pointer;text-decoration:underline">Skip setup</button>
    </div>
  </div>
</div>
<style>
.setup-step{animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.age-btn{padding:12px 18px;background:rgba(0,100,255,0.15);border:2px solid rgba(0,150,255,0.3);border-radius:12px;color:#fff;font-size:16px;cursor:pointer;transition:all 0.2s}
.age-btn:hover,.age-btn.selected{background:rgba(0,150,255,0.3);border-color:#00d4ff}
.voice-dot{display:inline-flex;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);align-items:center;justify-content:center;color:rgba(255,255,255,0.4);font-size:14px;transition:all 0.3s}
.voice-dot.done{background:rgba(0,255,136,0.2);border-color:#00ff88;color:#00ff88}
.voice-dot.recording{background:rgba(255,68,68,0.3);border-color:#ff4444;color:#ff4444;animation:voicePulse 0.5s ease infinite alternate}
@keyframes voicePulse{from{transform:scale(1);box-shadow:0 0 0 rgba(255,68,68,0)}to{transform:scale(1.1);box-shadow:0 0 12px rgba(255,68,68,0.4)}}
</style>
<div class="engagement-bar" id="engBar"><div class="eng-dot" id="engDot"></div><span class="eng-label" id="engLabel"></span></div>
<div id="personName" style="position:fixed;top:40px;left:12px;font-size:14px;font-weight:bold;color:#00ff88;z-index:50;text-shadow:0 0 8px rgba(0,255,136,0.5)"></div>
<div id="gamificationHud" style="position:fixed;top:58px;left:12px;z-index:50;display:none;font-size:12px;color:rgba(255,255,255,0.7)">
  <div id="hudLevel" style="color:#00d4ff;font-weight:bold;text-shadow:0 0 8px rgba(0,212,255,0.4)"></div>
  <div style="display:flex;gap:12px;margin-top:2px">
    <span id="hudPoints" title="Points">â­ 0</span>
    <span id="hudStreak" title="Streak">ğŸ”¥ 0</span>
  </div>
  <div id="hudAchievement" style="display:none;margin-top:4px;padding:4px 8px;background:rgba(255,215,0,0.2);border:1px solid rgba(255,215,0,0.4);border-radius:8px;color:#ffd700;font-weight:bold;animation:achievePulse 2s ease-in-out"></div>
</div>
<style>
@keyframes achievePulse{0%{transform:scale(0.8);opacity:0}20%{transform:scale(1.1);opacity:1}80%{transform:scale(1);opacity:1}100%{transform:scale(1);opacity:0}}
</style>
<button class="hamburger" id="hb" onclick="toggleSettings()"><span></span><span></span><span></span></button>
<div class="settings-overlay" id="so" onclick="toggleSettings()"></div>
<div class="settings-panel" id="sp">
  <h2>âš™ï¸ Settings</h2>
  <div class="setting-group"><h3>ğŸ“¶ Wi-Fi</h3><div class="setting-item"><label>ğŸ“¶ Wi-Fi</label><button class="toggle on" onclick="this.classList.toggle('on')"></button></div><div><div class="wifi-item connected"><span>ğŸ”’ HomeNetwork</span><span style="color:rgba(255,255,255,0.4)">Connected</span></div></div></div>
  <div class="setting-group"><h3>ğŸ”† Display</h3><div class="setting-item"><label>ğŸ”† Brightness</label><input type="range" min="10" max="100" value="80" oninput="document.body.style.filter='brightness('+this.value/100+')'"></div><div class="setting-item"><label>ğŸŒ™ Night Mode</label><button class="toggle" onclick="this.classList.toggle('on');document.body.style.background=this.classList.contains('on')?'#0a0508':'#000'"></button></div></div>
  <div class="setting-group"><h3>ğŸ—£ï¸ Language</h3><div class="setting-item"><label>ğŸŒ VIRON Language</label><select id="langSelect" onchange="setVironLang(this.value)" style="background:rgba(255,255,255,0.08);color:#e0f0ff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 12px;font-size:13px"><option value="en">ğŸ‡¬ğŸ‡§ English</option><option value="el">ğŸ‡¬ğŸ‡· Greek</option></select></div></div>
  <div class="setting-group"><h3>ğŸ”Š Sound</h3><div class="setting-item"><label>ğŸ”Š Volume</label><input type="range" id="volSlider" min="0" max="100" value="75"></div></div>
  <div class="setting-group"><h3>ğŸ”‹ Battery</h3><div class="setting-item" style="flex-direction:column;align-items:stretch;gap:8px"><div style="display:flex;justify-content:space-between"><label>ğŸ”‹</label><span style="color:rgba(0,200,255,0.8)" id="bp">78%</span></div><div class="battery-bar"><div class="battery-fill" id="bf" style="width:78%;background:linear-gradient(90deg,#00e0ff,#00ff88)"></div><span class="battery-text" id="bt">78%</span></div></div></div>
  <div class="setting-group"><h3>ğŸ¤– AI</h3><div class="setting-item"><label>ğŸ“· Emotion Detection</label><button class="toggle on" onclick="this.classList.toggle('on');emotionDetectionOn=this.classList.contains('on')"></button></div><div class="setting-item"><label>ğŸ­ Proactive Care</label><button class="toggle on" onclick="this.classList.toggle('on');proactiveEnabled=this.classList.contains('on')"></button></div></div>
  <div class="setting-group"><h3>ğŸ‘¤ Face Recognition</h3>
    <div id="faceRecStatus" style="margin-bottom:8px;font-size:12px;color:rgba(255,255,255,0.4)"></div>
    <div id="facesList" style="margin-bottom:10px"></div>
    <div id="faceSetupArea" style="display:none;margin-bottom:10px">
      <button class="sbtn" onclick="setupFaceRec()" id="setupFaceBtn" style="width:100%;padding:8px;font-size:13px;background:rgba(0,180,255,0.15);color:#00b4ff;border:1px solid rgba(0,180,255,0.3);border-radius:8px;cursor:pointer">ğŸ“¥ Download Models & Setup</button>
    </div>
    <div id="faceRegArea" class="setting-item" style="flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;width:100%">
        <input type="text" id="faceNameInput" placeholder="Person's name..." style="flex:1;background:rgba(255,255,255,0.08);color:#e0f0ff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 12px;font-size:13px">
        <button class="sbtn" onclick="registerFace()" style="padding:6px 14px;font-size:12px;background:rgba(0,180,255,0.15);color:#00b4ff;border:1px solid rgba(0,180,255,0.3);border-radius:8px;cursor:pointer">ğŸ“¸ Register</button>
      </div>
      <div id="faceStatus" style="font-size:11px;color:rgba(255,255,255,0.4)">Look at camera and click Register</div>
    </div>
  </div>
  <div class="setting-group"><h3>ğŸ™ï¸ Voice Fingerprint</h3>
    <div id="voiceStatus" style="margin-bottom:8px;font-size:12px;color:rgba(255,255,255,0.4)">Checking...</div>
    <div id="voiceProfilesList" style="margin-bottom:10px"></div>
    <div id="voiceTrainArea" style="margin-bottom:10px">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input type="text" id="voiceNameInput" placeholder="Name (e.g. Chris)" style="flex:1;background:rgba(255,255,255,0.08);color:#e0f0ff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 12px;font-size:13px">
      </div>
      <div style="display:flex;gap:6px;justify-content:center;margin-bottom:8px">
        <span class="voice-dot" id="sdot1">â‘ </span>
        <span class="voice-dot" id="sdot2">â‘¡</span>
        <span class="voice-dot" id="sdot3">â‘¢</span>
      </div>
      <div style="width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin-bottom:8px;overflow:hidden">
        <div id="settingsVoiceLevel" style="width:0%;height:100%;background:#00d4ff;border-radius:2px;transition:width 0.1s"></div>
      </div>
      <button class="sbtn" id="settingsVoiceBtn" onclick="settingsVoiceRecord()" style="width:100%;padding:8px;font-size:13px;background:rgba(255,68,68,0.15);color:#ff6666;border:1px solid rgba(255,68,68,0.3);border-radius:8px;cursor:pointer">ğŸ™ï¸ Record Voice Sample</button>
      <div id="settingsVoiceMsg" style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:6px;text-align:center">Record 3 samples so VIRON only listens to you</div>
    </div>
    <div class="setting-item"><label>ğŸ”’ Voice Lock</label><button class="toggle" id="voiceLockToggle" onclick="toggleVoiceLock(this)"></button></div>
  </div>
  <div class="setting-group"><h3>â„¹ï¸ System</h3><div class="setting-item" style="flex-direction:column;align-items:stretch;gap:4px"><div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:rgba(255,255,255,0.3)">Device</span><span style="font-size:12px;color:#c0d8e8">VIRON v1.0</span></div><div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:rgba(255,255,255,0.3)">Uptime</span><span style="font-size:12px;color:#c0d8e8" id="ut">0h 0m</span></div></div>
  <button class="sbtn danger" onclick="if(confirm('Restart?'))location.reload()">ğŸ” Restart</button>
  <button class="sbtn danger" onclick="resetViron()" style="background:rgba(255,100,0,0.15);color:#ff8800;border-color:rgba(255,100,0,0.3)">ğŸ—‘ï¸ Reset VIRON</button>
  <button class="sbtn danger" onclick="if(!confirm('Shutdown?'))return;cE('sleepy');toggleSettings();document.body.style.transition='opacity 2s';document.body.style.opacity='0';setTimeout(()=>{fetch('/api/system/shutdown',{method:'POST'}).catch(()=>{});document.body.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100vh;color:rgba(255,255,255,0.2);font-size:14px\'>VIRON is off.</div>';document.body.style.opacity='1'},2500)">â» Shutdown</button></div>
  <div style="text-align:center;color:rgba(255,255,255,0.15);font-size:11px;margin-top:20px">VIRON AI Companion â€¢ v1.0</div>
</div>
<div class="wb-overlay" id="wb" onclick="if(wbO&&!wbPresenting)closeWB()"><div class="wb-bg"></div><div class="wb-hdr"><div class="wb-title">ğŸ“ <span id="wbt"></span></div><button class="wb-close" id="wbCloseBtn" onclick="closeWB()">âœ• Back</button></div><div class="wb-content" id="wbc"></div><div style="position:absolute;bottom:12px;left:0;right:0;text-align:center;font-size:13px;color:#999;font-style:italic" id="wbCloseHint">Say "OK" or tap anywhere to close</div></div>
<div class="yt-container" id="ytC"><div class="yt-header"><span class="yt-title" id="ytT">â™ª</span><button class="yt-close" onclick="document.getElementById('ytP').src='';document.getElementById('ytC').classList.remove('visible')">âœ•</button></div><iframe id="ytP" width="280" height="158" src="" allow="autoplay;encrypted-media" allowfullscreen style="border:none;border-radius:10px"></iframe></div>
<div class="listen-indicator wake" id="listenInd">
  <div class="listen-bars"><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div><div class="bar" style="height:4px"></div></div>
  <span class="listen-text" id="listenText">Say "Hey VIRON"</span>
</div>
<div class="subtitle" id="subtitle"></div>
<svg id="face" viewBox="0 0 800 500"></svg>

<script>
// ===== DEBUG LOGGER =====
const _dbg=[];
function D(msg){
  const t=new Date().toTimeString().split(' ')[0]+'.'+String(Date.now()%1000).padStart(3,'0');
  const line=`[${t}] ${msg}`;
  _dbg.push(line);
  console.log('ğŸ” '+line);
  // Send to server for persistent logging
  fetch('/debug/log',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({source:'browser',message:msg,level:'INFO'})}).catch(()=>{});
}
// Save debug log to server on demand
function saveDebugLog(){
  fetch('/debug/save',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({log:_dbg.join('\n')})}).catch(()=>{});
}
// Auto-save every 10 seconds
setInterval(saveDebugLog,10000);
D('=== VIRON Debug Session Started ===');
D('URL: '+location.href);
D('UserAgent: '+navigator.userAgent);
D('mediaDevices: '+(navigator.mediaDevices?'YES':'NO'));
D('getUserMedia: '+(navigator.mediaDevices?.getUserMedia?'YES':'NO'));
D('SpeechRecognition: '+((window.SpeechRecognition||window.webkitSpeechRecognition)?'YES':'NO'));
D('SpeechSynthesis: '+(window.speechSynthesis?'YES':'NO'));

// ===== EMOTIONS (43) =====
const E={happy:{eyeRx:1,eyeRy:.82,pupilSize:1,mouthCurve:1.3,mouthOpen:0,browAngle:0,browY:0,sparkle:true,irisStyle:0,winkLeft:false,squint:0},excited:{eyeRx:1.05,eyeRy:.88,pupilSize:.85,mouthCurve:1.6,mouthOpen:0,browAngle:-5,browY:-8,sparkle:true,irisStyle:0,winkLeft:false,squint:0},sad:{eyeRx:.95,eyeRy:.65,pupilSize:1.1,mouthCurve:-.8,mouthOpen:0,browAngle:8,browY:-5,sparkle:false,irisStyle:0,winkLeft:false,squint:0},angry:{eyeRx:.95,eyeRy:.6,pupilSize:.8,mouthCurve:-.5,mouthOpen:0,browAngle:15,browY:5,sparkle:false,irisStyle:1,winkLeft:false,squint:0},surprised:{eyeRx:1.1,eyeRy:.95,pupilSize:.7,mouthCurve:.1,mouthOpen:.9,browAngle:-8,browY:-15,sparkle:false,irisStyle:0,winkLeft:false,squint:0},sleepy:{eyeRx:.95,eyeRy:.4,pupilSize:1.2,mouthCurve:.3,mouthOpen:0,browAngle:3,browY:5,sparkle:false,irisStyle:0,winkLeft:false,squint:0},love:{eyeRx:1.02,eyeRy:.85,pupilSize:1.3,mouthCurve:1.1,mouthOpen:0,browAngle:-3,browY:-3,sparkle:true,irisStyle:2,winkLeft:false,squint:0},neutral:{eyeRx:1,eyeRy:.78,pupilSize:1,mouthCurve:.2,mouthOpen:0,browAngle:0,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:0},teasing:{eyeRx:1,eyeRy:.75,pupilSize:.9,mouthCurve:.9,mouthOpen:0,browAngle:6,browY:-2,sparkle:false,irisStyle:0,winkLeft:true,squint:.3},confused:{eyeRx:1,eyeRy:.8,pupilSize:1.05,mouthCurve:-.2,mouthOpen:0,browAngle:10,browY:-8,sparkle:false,irisStyle:0,winkLeft:false,squint:0},scared:{eyeRx:1.12,eyeRy:1,pupilSize:.6,mouthCurve:-.4,mouthOpen:.5,browAngle:-10,browY:-12,sparkle:false,irisStyle:0,winkLeft:false,squint:0},disgusted:{eyeRx:.9,eyeRy:.55,pupilSize:.85,mouthCurve:-1.2,mouthOpen:.2,browAngle:6,browY:3,sparkle:false,irisStyle:0,winkLeft:false,squint:.4},proud:{eyeRx:.98,eyeRy:.7,pupilSize:.95,mouthCurve:.8,mouthOpen:0,browAngle:-4,browY:-6,sparkle:true,irisStyle:0,winkLeft:false,squint:.15},shy:{eyeRx:1.05,eyeRy:.85,pupilSize:1.15,mouthCurve:.5,mouthOpen:0,browAngle:4,browY:-4,sparkle:false,irisStyle:2,winkLeft:false,squint:0},bored:{eyeRx:1,eyeRy:.5,pupilSize:1.1,mouthCurve:-.1,mouthOpen:0,browAngle:2,browY:4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},laughing:{eyeRx:1,eyeRy:.35,pupilSize:1,mouthCurve:1.8,mouthOpen:.7,browAngle:-3,browY:-5,sparkle:true,irisStyle:0,winkLeft:false,squint:.5},crying:{eyeRx:.95,eyeRy:.7,pupilSize:1.15,mouthCurve:-1,mouthOpen:.6,browAngle:10,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:0},thinking:{eyeRx:1,eyeRy:.78,pupilSize:.95,mouthCurve:.1,mouthOpen:0,browAngle:8,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:.15},winking:{eyeRx:1,eyeRy:.82,pupilSize:1,mouthCurve:1,mouthOpen:0,browAngle:-2,browY:-2,sparkle:true,irisStyle:0,winkLeft:true,squint:0},suspicious:{eyeRx:1,eyeRy:.6,pupilSize:.85,mouthCurve:-.3,mouthOpen:0,browAngle:12,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:.3},grateful:{eyeRx:1,eyeRy:.85,pupilSize:1.2,mouthCurve:1.4,mouthOpen:0,browAngle:-2,browY:-4,sparkle:true,irisStyle:2,winkLeft:false,squint:0},mischievous:{eyeRx:1.02,eyeRy:.72,pupilSize:.8,mouthCurve:1.2,mouthOpen:.15,browAngle:10,browY:3,sparkle:false,irisStyle:1,winkLeft:false,squint:.2},worried:{eyeRx:1.05,eyeRy:.85,pupilSize:1.1,mouthCurve:-.6,mouthOpen:0,browAngle:9,browY:-8,sparkle:false,irisStyle:0,winkLeft:false,squint:0},hopeful:{eyeRx:1.08,eyeRy:.92,pupilSize:1.35,mouthCurve:.4,mouthOpen:0,browAngle:6,browY:-10,sparkle:true,irisStyle:0,winkLeft:false,squint:0},sassy:{eyeRx:1,eyeRy:.68,pupilSize:.9,mouthCurve:.7,mouthOpen:0,browAngle:8,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.25},dizzy:{eyeRx:1.05,eyeRy:.85,pupilSize:.6,mouthCurve:-.3,mouthOpen:.3,browAngle:0,browY:-3,sparkle:false,irisStyle:0,winkLeft:false,squint:0},cheeky:{eyeRx:1,eyeRy:.4,pupilSize:1,mouthCurve:1.5,mouthOpen:.5,browAngle:-3,browY:-4,sparkle:true,irisStyle:0,winkLeft:false,squint:.4},flirty:{eyeRx:1,eyeRy:.8,pupilSize:1.2,mouthCurve:1,mouthOpen:0,browAngle:-4,browY:-3,sparkle:true,irisStyle:2,winkLeft:true,squint:0},jealous:{eyeRx:.95,eyeRy:.6,pupilSize:.9,mouthCurve:-.4,mouthOpen:0,browAngle:10,browY:2,sparkle:false,irisStyle:0,winkLeft:false,squint:.35},determined:{eyeRx:.98,eyeRy:.7,pupilSize:.85,mouthCurve:.1,mouthOpen:0,browAngle:8,browY:4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},embarrassed:{eyeRx:1.02,eyeRy:.8,pupilSize:1.1,mouthCurve:.6,mouthOpen:.15,browAngle:5,browY:-6,sparkle:false,irisStyle:0,winkLeft:false,squint:.1},mindblown:{eyeRx:1.15,eyeRy:1,pupilSize:.5,mouthCurve:0,mouthOpen:.8,browAngle:-12,browY:-18,sparkle:true,irisStyle:0,winkLeft:false,squint:0},smug:{eyeRx:.98,eyeRy:.65,pupilSize:.95,mouthCurve:.7,mouthOpen:0,browAngle:7,browY:0,sparkle:false,irisStyle:0,winkLeft:false,squint:.3},evil:{eyeRx:1,eyeRy:.6,pupilSize:.7,mouthCurve:1.1,mouthOpen:.2,browAngle:14,browY:6,sparkle:false,irisStyle:1,winkLeft:false,squint:.25},dreamy:{eyeRx:1.02,eyeRy:.75,pupilSize:1.3,mouthCurve:.6,mouthOpen:0,browAngle:-2,browY:-4,sparkle:true,irisStyle:2,winkLeft:false,squint:.1},focused:{eyeRx:.96,eyeRy:.72,pupilSize:.75,mouthCurve:0,mouthOpen:0,browAngle:5,browY:2,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},relieved:{eyeRx:1,eyeRy:.55,pupilSize:1.1,mouthCurve:.9,mouthOpen:0,browAngle:-2,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.15},skeptical:{eyeRx:1,eyeRy:.7,pupilSize:.9,mouthCurve:-.2,mouthOpen:0,browAngle:12,browY:-4,sparkle:false,irisStyle:0,winkLeft:false,squint:.2},panicking:{eyeRx:1.12,eyeRy:1.05,pupilSize:.5,mouthCurve:-.6,mouthOpen:.85,browAngle:-12,browY:-16,sparkle:false,irisStyle:0,winkLeft:false,squint:0},silly:{eyeRx:1.05,eyeRy:.82,pupilSize:1,mouthCurve:1.5,mouthOpen:.4,browAngle:-5,browY:-6,sparkle:true,irisStyle:0,winkLeft:true,squint:.2},grumpy:{eyeRx:.92,eyeRy:.5,pupilSize:.9,mouthCurve:-.7,mouthOpen:0,browAngle:12,browY:6,sparkle:false,irisStyle:0,winkLeft:false,squint:.35},amazed:{eyeRx:1.1,eyeRy:.95,pupilSize:1.3,mouthCurve:1.2,mouthOpen:.3,browAngle:-8,browY:-14,sparkle:true,irisStyle:0,winkLeft:false,squint:0},zen:{eyeRx:1,eyeRy:.45,pupilSize:1.15,mouthCurve:.4,mouthOpen:0,browAngle:0,browY:-2,sparkle:false,irisStyle:0,winkLeft:false,squint:.1}};

// ===== STATE =====
let emo="neutral",prev="neutral",tT=1,blink=false,lx=0,ly=0,talking=false,tO=0,tTime=0,bTime=0,bA={l:0,r:0};
let msgs=[],loading=false;
const vironSessionId='session_'+Date.now(); // Unique per page load for conversation memory
let sEmo={emotion:"neutral",engagement_score:100,face_detected:false,recognized_person:null};
let proactiveEnabled=true,emotionDetectionOn=true,lastPT=0;
let subTimer=null;

// Voice states
const VOICE_IDLE="idle";       // Listening always
const VOICE_ACTIVATED="activated"; // Wake word heard, processing
const VOICE_PROCESSING="processing"; // Sending to AI
const VOICE_HEARING="hearing"; // Student is speaking (show red bars)
let voiceState=VOICE_IDLE;

// ===== LANGUAGE SETTING =====
// Stored in localStorage. 'el' = Greek, 'en' = English
let vironLang=localStorage.getItem('viron-lang')||'en';
function setVironLang(lang){
  vironLang=lang;
  localStorage.setItem('viron-lang',lang);
  D('Language set to: '+lang);
  // Restart listener with new language
  stopAllRecognition();
  setTimeout(startAlwaysListening,500);
}
function getSRLang(){return vironLang==='el'?'el-GR':'en-US';}
function isGreekMode(){return vironLang==='el';}

const lerp=(a,b,t)=>a+(b-a)*t;
function lE(f,t,tt){const r={};for(const k in t)r[k]=typeof t[k]==="number"?lerp(f[k]??t[k],t[k],tt):(tt>.5?t[k]:f[k]);return r}
function cE(e){if(e===emo||!E[e])return;prev=emo;emo=e;tT=0;const s=performance.now();(function a(ts){const t=Math.min(1,(ts-s)/400);tT=t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;if(t<1)requestAnimationFrame(a)})(s)}

setInterval(()=>{blink=true;setTimeout(()=>blink=false,emo==="sleepy"?400:150)},3500);
document.addEventListener("mousemove",e=>{lx=((e.clientX-innerWidth/2)/(innerWidth/2))*8;ly=((e.clientY-innerHeight/2)/(innerHeight/2))*6});

let tAn=null;
function startT(){talking=true;if(tAn)return;(function a(){tTime+=.12;tO=Math.min(1,Math.max(0,Math.sin(tTime*2.8)*.4+Math.sin(tTime*4.5)*.2+Math.sin(tTime*1.2)*.15)*1.4);tAn=requestAnimationFrame(a)})()}
function stopT(){talking=false;cancelAnimationFrame(tAn);tAn=null;(function c(){tO*=.85;if(tO>.02)requestAnimationFrame(c);else tO=0})()}

function showSub(text){const el=document.getElementById("subtitle");el.textContent=text;el.classList.add("visible");clearTimeout(subTimer);subTimer=setTimeout(()=>el.classList.remove("visible"),Math.max(3000,text.length*60))}
function updateListenUI(){
  const ind=document.getElementById("listenInd");
  const txt=document.getElementById("listenText");
  if(voiceState===VOICE_HEARING){ind.className="listen-indicator speaking";txt.textContent="Listening..."}
  else if(inConversation&&(voiceState===VOICE_IDLE||voiceState===VOICE_ACTIVATED)){
    // Always show red bars during conversation
    ind.className="listen-indicator active";txt.textContent="Listening...";
  }
  else if(voiceState===VOICE_IDLE){
    ind.className="listen-indicator wake";
    txt.textContent='Say "Hey VIRON"';
  }
  else if(voiceState===VOICE_ACTIVATED){ind.className="listen-indicator active";txt.textContent="Listening..."}
  else if(voiceState===VOICE_PROCESSING){ind.className="listen-indicator active";txt.textContent="Thinking..."}
  else{ind.className="listen-indicator";ind.style.opacity="0";txt.textContent=""}
}

// ===== SPEECH =====
const synth=window.speechSynthesis;let gkV=null,enV=null;
function loadV(){
  const v=synth.getVoices();
  D('Voices available: '+v.length);
  const enVoices=v.filter(x=>x.lang.startsWith("en"));
  D('English voices: '+enVoices.map(x=>x.name).join(', '));
  
  // GREEK: prefer male
  gkV=v.find(x=>x.lang.startsWith("el")&&/male|man/i.test(x.name)&&!/female/i.test(x.name))||
      v.find(x=>x.lang.startsWith("el")&&x.name.includes("Google"))||
      v.find(x=>x.lang.startsWith("el"))||null;
  
  // ENGLISH: soft educated MALE voice
  const femaleNames=/Female|Zira|Samantha|Sara|Jenny|Aria|Hazel|Susan|Linda|Libby|Emily|Amy|Woman|Sonia|Neerja|Heera/i;
  const malePrefs=[
    x=>/Google UK English Male/i.test(x.name),
    x=>x.name.includes("Microsoft David"),
    x=>x.name.includes("Microsoft Mark"),
    x=>x.name.includes("Microsoft Guy"),
    x=>x.name.includes("Microsoft Ryan"),
    x=>/Daniel/i.test(x.name)&&x.lang.startsWith("en")&&!femaleNames.test(x.name),
    x=>/Male/i.test(x.name)&&x.lang.startsWith("en"),
    x=>/James|George|Thomas|Richard|Paul|Guy|Ryan|Andrew/i.test(x.name)&&x.lang.startsWith("en"),
    // Last resort: any English voice NOT known-female AND NOT "Google US English" (which is female)
    x=>x.lang.startsWith("en")&&!x.name.includes("Compact")&&!femaleNames.test(x.name)&&!/Google US English$/i.test(x.name)&&!/Google/i.test(x.name),
  ];
  enV=null;
  for(const pref of malePrefs){
    enV=enVoices.find(pref);
    if(enV){D('  â†’ Matched male voice: '+enV.name);break;}
  }
  
  D('Greek voice: '+(gkV?.name||'NONE (will use gTTS)'));
  D('English voice: '+(enV?.name||'NONE'));
}
if(synth){synth.onvoiceschanged=loadV;loadV()}
const isGr=t=>/[\u0370-\u03FF\u1F00-\u1FFF]/.test(t);
let currentAudio=null; // Track current playing audio to prevent overlap
let isSpeaking=false;

function stopSpeaking(){
  synth.cancel();
  if(currentAudio){try{currentAudio.pause();currentAudio.src=''}catch{}}
  currentAudio=null;
  isSpeaking=false;
}

function say(text,speed){
  if(!synth){D('  say: no synth!');return}
  // STOP any current speech first â€” ONE voice at a time
  stopSpeaking();
  isSpeaking=true;
  showSub(text);
  // Strip emojis and special chars that break TTS
  let clean=text.replace(/VIRON/gi,'Î’Î¯ÏÎ¿Î½')
    .replace(/[\u{1F600}-\u{1F64F}]/gu,'')  // emoticons
    .replace(/[\u{1F300}-\u{1F5FF}]/gu,'')  // symbols
    .replace(/[\u{1F680}-\u{1F6FF}]/gu,'')  // transport
    .replace(/[\u{1F1E0}-\u{1F1FF}]/gu,'')  // flags
    .replace(/[\u{2600}-\u{26FF}]/gu,'')     // misc symbols
    .replace(/[\u{2700}-\u{27BF}]/gu,'')     // dingbats
    .replace(/[\u{FE00}-\u{FEFF}]/gu,'')     // variation selectors
    .replace(/[\u{1F900}-\u{1F9FF}]/gu,'')   // supplemental
    .replace(/[\u{200D}\u{20E3}\u{FE0F}]/gu,'') // joiners
    .replace(/\s+/g,' ').trim();
  
  D('  say: "'+clean.substring(0,80)+'..." greek='+isGr(clean)+' speed='+(speed||'normal'));
  
  if(!clean){D('  say: empty after cleanup');stopT();startWakeListener();return}
  
  // ALL speech â†’ server edge-tts (male voice) with browser fallback
  const lang=isGr(clean)?'el':'en';
  sayServerTTS(clean,lang,speed||'normal');
}

// Server TTS (edge-tts male voice) â€” works for ALL languages
let audioUnlocked=false;
function unlockAudio(){
  if(audioUnlocked)return;
  const s=new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA");
  s.volume=0.01;
  s.play().then(()=>{audioUnlocked=true;D('ğŸ”“ Audio unlocked')}).catch(()=>{});
  const u=new SpeechSynthesisUtterance('');u.volume=0;synth.speak(u);
}
document.addEventListener('click',unlockAudio,{once:false});
document.addEventListener('touchstart',unlockAudio,{once:false});
document.addEventListener('keydown',unlockAudio,{once:false});

function sayServerTTS(text,lang,speed){
  D('  sayServerTTS('+lang+', speed='+(speed||'normal')+'): "'+text.substring(0,60)+'"');
  
  // Split long text into sentences for pipelining (play first while fetching rest)
  // Greek uses ; as question mark and Â· as semicolon, so split carefully
  // Split on: . ! ? followed by space or end, and Greek Â· followed by space
  const sentences=text.match(/[^.!?]+[.!?]+(?:\s|$)|[^.!?]+$/g)||[text];
  // Only pipeline if we have multiple real sentences
  if(sentences.length>1 && text.length>30){
    let queue=sentences.map(s=>s.trim()).filter(s=>s.length>2);
    if(queue.length<=1){queue=[text]}  // Don't pipeline if filtering left just one
    if(queue.length>1){
      D('  ğŸ“¢ Pipelining '+queue.length+' sentences');
      let prefetched={}; // index -> blob
      let fetching=new Set(); // dedup guard
      
      // Prefetch sentence audio (with dedup)
      function prefetchSentence(idx){
        if(idx>=queue.length||prefetched[idx]||fetching.has(idx))return;
        fetching.add(idx);
        fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:queue[idx],lang:lang||'en',speed:speed||'normal'})})
        .then(r=>r.ok?r.blob():Promise.reject('HTTP '+r.status))
        .then(blob=>{prefetched[idx]=blob;D('  ğŸ“¦ Prefetched sentence '+(idx+1)+'/'+queue.length)})
        .catch(e=>D('  âš  Prefetch failed for sentence '+idx+': '+e));
      }
      
      // Play sentences in order
      function playSentence(idx){
        if(idx>=queue.length){
          D('  âœ… All sentences played');
          isSpeaking=false;currentAudio=null;stopT();setTimeout(startWakeListener,600);
          return;
        }
        function playBlob(blob){
          const url=URL.createObjectURL(blob);
          const a=new Audio(url);
          currentAudio=a;
          a.volume=(document.getElementById("volSlider")?.value||75)/100;
          // Prefetch next 2 sentences while this one plays
          prefetchSentence(idx+1);
          prefetchSentence(idx+2);
          a.onended=()=>{URL.revokeObjectURL(url);playSentence(idx+1)};
          a.onerror=()=>{URL.revokeObjectURL(url);playSentence(idx+1)};
          a.play().then(()=>{if(idx===0)startT()}).catch(()=>playSentence(idx+1));
        }
        
        if(prefetched[idx]){
          playBlob(prefetched[idx]);
        } else {
          // Fetch this sentence now
          fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:queue[idx],lang:lang||'en',speed:speed||'normal'})})
          .then(r=>r.ok?r.blob():Promise.reject('HTTP '+r.status))
          .then(blob=>playBlob(blob))
          .catch(e=>{D('  âš  Sentence '+idx+' failed: '+e);playSentence(idx+1)});
        }
      }
      
      // Start: fetch first 2 sentences, play first as soon as ready
      prefetchSentence(0);
      prefetchSentence(1);
      function waitAndPlay(){
        if(prefetched[0]){playSentence(0);return}
        setTimeout(waitAndPlay,50);
      }
      waitAndPlay();
      return;
    }
  }
  
  // Short text: single request (original behavior)
  fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,lang:lang||'en',speed:speed||'normal'})})
  .then(r=>{
    D('  TTS response: '+r.status);
    if(!r.ok)throw new Error('HTTP '+r.status);
    return r.blob();
  })
  .then(blob=>{
    D('  TTS blob: '+blob.size+' bytes');
    const url=URL.createObjectURL(blob);
    const a=new Audio(url);
    currentAudio=a; // Track for stopSpeaking()
    a.volume=(document.getElementById("volSlider")?.value||75)/100;
    a.onended=()=>{D('  TTS playback ended');isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);stopT();setTimeout(startWakeListener,600)};
    a.onerror=(e)=>{D('  TTS playback ERROR: '+e.type);isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);stopT();setTimeout(startWakeListener,600)};
    a.play().then(()=>{startT()}).catch(e=>{D('  TTS play() ERROR: '+e.message);isSpeaking=false;currentAudio=null;stopT();setTimeout(startWakeListener,600)})
  })
  .catch(e=>{
    D('  Server TTS FAILED: '+e.message+' â€” falling back to browser voice');
    stopT();
    // Fallback: browser SpeechSynthesis (male voice)
    const u=new SpeechSynthesisUtterance(text);
    u.lang=lang==='el'?'el-GR':'en-US';
    if(lang!=='el'&&enV)u.voice=enV;
    if(lang==='el'&&gkV)u.voice=gkV;
    u.rate=speed==='slow'?0.75:speed==='fast'?1.1:0.9;u.pitch=0.85;
    u.onstart=()=>{startT()};
    u.onend=()=>{isSpeaking=false;stopT();setTimeout(startWakeListener,600)};
    u.onerror=()=>{stopT();setTimeout(startWakeListener,600)};
    synth.speak(u);
  })
}

// ========================================
// WAKE WORD SYSTEM - "Hey VIRON"
// ========================================
const WAKE_WORDS=["hey viron","hey byron","hey iron","hey vyron","hey veron","hey biron",
  "Î³ÎµÎ¹Î± viron","Î³ÎµÎ¹Î± Î²Î¬Î¹ÏÎ¿Î½","Î³ÎµÎ¹Î± Î²Î¹ÏÎ¿Î½","hey vi ron","ey viron","a viron",
  "hey google","hey good","hey guru","hey cool","baby room","baby broom","baby run"];
let activeRec=null;
let wakeRetryTimeout=null;

function matchesWakeWord(text){
  const lower=text.toLowerCase().trim().replace(/[.,!?]/g,'');
  // Check exact matches
  for(const w of WAKE_WORDS)if(lower.includes(w))return true;
  // Actual Chrome misrecognitions from testing
  const misrecognitions=["heavy road","heavy ron","heavy run","heavy iron","heavy roan",
    "hey byron","hey veron","hey baron","hey bron","hey ron","hey run",
    "hey iron","hey violin","hey viral","hey viren","hey vyron",
    "have iran","have iron","hey iran","hey irene","hey vr","hey v run",
    "a viron","a byron","hey brian","hey bryan",
    "play viral","play viron","play byron","play iron","play vyron",
    "please viral","please viron","please play","please byron",
    "plei viron","plei viral","pray viral","pray viron",
    "tegan","tegan is","t gun","tigan","tea gun","tik on","tick on",
    "heavy wrong","heavy round","hey around","hey brown",
    "hayviron","hay viron","hayvironment","hay vironment",
    "hey environment","hey environ","hey virum","hey vironn",
    "hey fire on","hey tyron","hey myron","hey virus",
    "imovie","imovie road","i movie","i movie road","imovie wrote",
    "hey v","hey vi","hey vr on","hey v ron","hey bee run",
    "hey be wrong","hey be run","hey be ron","heavy ron",
    "have a run","have a ron","hey everyone","hey ev run",
    "hey you don","hey you're on","hey your on","hey you run",
    "hey udon","hey you're wrong","hey you wrong","hey you round",
    "hey you ron","hey you iron","hey you're in","hey you roan",
    "hey you drone","hey you're done","hey your own","hey you're own",
    "hey you earn","hey you're run","hey you down","hey you're round",
    "Î³ÎµÎ¹Î± Î²Î¹ÏÎ¿Î½","Î³ÎµÎ¹Î± Î²Î±Î¹ÏÎ¿Î½","Î³Î¹Î± Î²Î¹ÏÎ¿Î½","Î³ÎµÎ¹Î± Î²ÏÏÎ¿Î½",
    "Ï‡Î­Î¹ Î²Î¯ÏÎ¿Î½","Ï‡ÎµÎ¹ Î²Î¹ÏÎ¿Î½","Î­Î¹ Î²Î¯ÏÎ¿Î½","ÎµÎ¹ Î²Î¹ÏÎ¿Î½","Ï‡ÎµÏŠ Î²Î¹ÏÎ¿Î½",
    "Ï‡Î­Î¹ Î²Î¬Î¹ÏÎ¿Î½","Ï‡ÎµÎ¹ Î²Î±Î¹ÏÎ¿Î½","Î­Î¹ Î²Î±Î¹ÏÎ¿Î½","Îµ Î²Î¹ÏÎ¿Î½","ÎµÏŠ Î²Î¹ÏÎ¿Î½"];
  for(const m of misrecognitions)if(lower.includes(m))return true;
  // Fuzzy regex: (hey/hi/hay/heavy/a/have) + (vir/byr/bir/fir/ron/iron)
  if(/(hey|hi|hay|heavy|have|hei|a|play|please|pray|plei)\s*\w{0,3}(vir|byr|bir|fir|vyr|iron|viron|byron|myron|tyron|viral)/i.test(lower))return true;
  // "hey you don't" pattern â€” Chrome hearing "hey viron" with Greek accent
  if(/hey\s+you\s*(don|ron|run|roan|round|wrong|drone|down|'re\s*on|'re\s*run|r\s*on)/i.test(lower))return true;
  // iMovie pattern: Chrome hearing "Hey VIRON" as "iMovie"
  if(/\bimovie\b/i.test(lower))return true;
  // "hey V..." pattern (partial recognition)
  if(/^hey\s+v\b/i.test(lower))return true;
  // "Tegan" = Chrome hearing "Hey VIRON" with Greek accent
  if(/^(tegan|tigan|teegan|deghan|degan)\b/i.test(lower))return true;
  // Greek fuzzy: Ï‡Î­Î¹/Î­Î¹/Îµ/Î³ÎµÎ¹Î± + Î²Î¹Ï/Î²Î±Î¹Ï/Î²ÏÏ
  if(/(Ï‡Î­Î¹|Ï‡ÎµÎ¹|Î­Î¹|ÎµÎ¹|Î³ÎµÎ¹Î±|Î³Î¹Î±|Îµ)\s*(Î²Î¹Ï|Î²Î±Î¹Ï|Î²ÏÏ|Î²Î¯Ï|Î¼Ï€Î±Î¹Ï)/i.test(lower))return true;
  // Fuzzy: word starting with hey/hay + word containing r+on/un/oad
  if(/(hey|hay|hi|heavy)\s/.test(lower)&&/(vir|byr|bir|ron|run|road|iro)/i.test(lower))return true;
  return false;
}

function extractAfterWake(text){
  const lower=text.toLowerCase();
  // Try exact WAKE_WORDS first
  for(const w of WAKE_WORDS){
    const idx=lower.indexOf(w);
    if(idx>=0){
      const after=text.substring(idx+w.length).trim();
      if(after.length>2)return after;
    }
  }
  // Try misrecognitions
  const misrecs=["heavy road","heavy ron","heavy run","heavy iron","heavy roan",
    "hey byron","hey veron","hey baron","hey bron","hey ron","hey run",
    "hey iron","hey violin","hey viral","hey viren","hey vyron",
    "have iran","have iron","hey iran","hey irene","hey brian","hey bryan",
    "tegan","tegan is","t gun","tigan","tea gun","tik on","tick on",
    "heavy wrong","heavy round","hey around","hey brown",
    "hayviron","hay viron","hayvironment","hay vironment",
    "hey environment","hey environ","hey virum","hey vironn",
    "hey fire on","hey tyron","hey myron","hey virus",
    "imovie road","imovie","i movie road","i movie",
    "hey v","hey vi","hey vr on","hey v ron",
    "hey you don't","hey you don","hey you're on","hey your on",
    "hey you run","hey udon","hey you're wrong","hey you wrong",
    "hey you round","hey you ron","hey you iron","hey you're in",
    "hey you drone","hey you're done","hey your own","hey you down",
    "hey google","hey good","hey guru","hey cool","baby room","baby broom","baby run","hey goo","hey goole",
    "hey google","hey good","hey guru","hey cool","baby room","baby broom","baby run","hey goo","hey goole",
    "Î³ÎµÎ¹Î± Î²Î¹ÏÎ¿Î½","Î³ÎµÎ¹Î± Î²Î±Î¹ÏÎ¿Î½","Î³Î¹Î± Î²Î¹ÏÎ¿Î½","Î³ÎµÎ¹Î± Î²ÏÏÎ¿Î½",
    "Ï‡Î­Î¹ Î²Î¯ÏÎ¿Î½","Ï‡ÎµÎ¹ Î²Î¹ÏÎ¿Î½","Î­Î¹ Î²Î¯ÏÎ¿Î½","ÎµÎ¹ Î²Î¹ÏÎ¿Î½","Ï‡ÎµÏŠ Î²Î¹ÏÎ¿Î½",
    "Ï‡Î­Î¹ Î²Î¬Î¹ÏÎ¿Î½","Ï‡ÎµÎ¹ Î²Î±Î¹ÏÎ¿Î½","Î­Î¹ Î²Î±Î¹ÏÎ¿Î½","Îµ Î²Î¹ÏÎ¿Î½","ÎµÏŠ Î²Î¹ÏÎ¿Î½"];
  for(const m of misrecs){
    const idx=lower.indexOf(m);
    if(idx>=0){
      const after=text.substring(idx+m.length).trim();
      if(after.length>2)return after;
    }
  }
  // Fuzzy regex extraction: find where wake pattern ends
  const fuzzyPatterns=[
    /((?:hey|hi|hay|heavy|have|hei|a)\s*\w{0,3}(?:vir|byr|bir|fir|vyr|iron|viron|byron|myron|tyron)\w*)/i,
    /((?:hey|hay|hi|heavy)\s+\S*(?:vir|byr|bir|ron|run|road|iro)\S*)/i,
    /(hey\s+you\s*(?:don'?t?|ron|run|roan|round|wrong|drone|down|'re\s*on|'re\s*run|r\s*on)\S*)/i,
    /((?:Ï‡Î­Î¹|Ï‡ÎµÎ¹|Î­Î¹|ÎµÎ¹|Î³ÎµÎ¹Î±|Î³Î¹Î±|Îµ)\s*(?:Î²Î¹Ï|Î²Î±Î¹Ï|Î²ÏÏ|Î²Î¯Ï|Î¼Ï€Î±Î¹Ï)\S*)/i,
    /((?:tegan|tigan|teegan|deghan|degan)\s*(?:is)?)/i,
    /(imovie\s*(?:road|wrote)?)/i,
    /(hey\s+v\b\S*)/i
  ];
  for(const pat of fuzzyPatterns){
    const match=lower.match(pat);
    if(match){
      const endIdx=lower.indexOf(match[1])+match[1].length;
      const after=text.substring(endIdx).trim();
      if(after.length>2)return after;
    }
  }
  return null;
}

let wakeStarting=false;

// ===== ALWAYS-ON LISTENING =====
// Detects wake word from INTERIM results (Chrome often skips finals)
// Filters background noise by checking for wake word pattern

let alwaysRec=null;
let alwaysListening=false;
let lastWakeTime=0; // Prevent double triggers

function startAlwaysListening(){
  D('>>> startAlwaysListening, voiceState='+voiceState+', loading='+loading+', wakeLang=en-US, cmdLang='+getSRLang());
  if(loading){D('  loading, retry in 1s');setTimeout(startAlwaysListening,1000);return}
  if(synth&&synth.speaking){D('  synth speaking, retry in 1s');setTimeout(startAlwaysListening,1000);return}
  if(alwaysListening){D('  already listening');return}
  
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){D('  âŒ SpeechRecognition not available');return}
  
  voiceState=VOICE_IDLE;
  updateListenUI();
  
  try{if(alwaysRec){alwaysRec.abort()}}catch{}
  
  alwaysRec=new SR();
  alwaysRec.continuous=false;
  alwaysRec.interimResults=true;
  alwaysRec.lang='en-US'; // ALWAYS English for wake word â€” Chrome can't hear "Hey VIRON" in Greek mode
  alwaysRec.maxAlternatives=5;
  
  let wakeDetectedInSession=false;
  
  alwaysRec.onstart=()=>{
    alwaysListening=true;
    wakeDetectedInSession=false;
    document.getElementById("listenText").textContent='Say "Hey VIRON"';
  };
  
  alwaysRec.onresult=(e)=>{
    if(wakeDetectedInSession)return; // Already triggered this session
    
    let finalText="";
    let interim="";
    let allText=""; // Combine everything for wake word check
    
    for(let i=e.resultIndex;i<e.results.length;i++){
      const transcript=e.results[i][0].transcript;
      if(e.results[i].isFinal){
        finalText+=transcript;
      }else{
        interim+=transcript;
      }
      // Check ALL alternatives for wake word
      for(let j=0;j<e.results[i].length;j++){
        allText+=e.results[i][j].transcript+" ";
      }
    }
    
    const display=finalText||interim;
    // Only log occasionally to reduce spam
    if(display&&display.length>2){
      D('  ğŸ¤ "'+display+'" (final='+!!finalText+')');
      // Show speaking bars when voice detected
      voiceState=VOICE_HEARING;updateListenUI();
    }
    
    // CHECK WAKE WORD IN BOTH INTERIM AND FINAL
    const textToCheck=(finalText+' '+interim+' '+allText).toLowerCase();
    
    if(matchesWakeWord(textToCheck)){
      // Prevent double triggers within 3 seconds
      if(Date.now()-lastWakeTime<3000){
        D('  (wake word debounced)');
        return;
      }
      lastWakeTime=Date.now();
      wakeDetectedInSession=true;
      
      D('  ğŸ¯ WAKE WORD DETECTED in: "'+display+'"');
      alwaysListening=false;
      try{alwaysRec.abort()}catch{}
      
      // Extract what comes after wake word
      const afterWake=extractAfterWake(display);
      startConversation(); // Enter conversation mode
      if(afterWake&&afterWake.length>3){
        D('  â†’ Direct command: "'+afterWake+'"');
        cE("hopeful");
        voiceState=VOICE_PROCESSING;
        updateListenUI();
        processStudentSpeech(afterWake);
      }else{
        // Just "Hey VIRON" â€” ack and listen for command
        D('  â†’ Acknowledged, entering conversation');
        cE("hopeful");
        voiceState=VOICE_ACTIVATED;
        updateListenUI();
        document.getElementById("listenText").textContent='Listening...';
        
        // Personalized ack with name if recognized
        const pName=sEmo.recognized_person;
        const ackText=pName?(isGreekMode()?`ÎŸÏÎ¯ÏƒÏ„Îµ ${pName};`:`Yes ${pName}?`):(isGreekMode()?"ÎŸÏÎ¯ÏƒÏ„Îµ;":"Yes?");
        D('  Playing ack: "'+ackText+'"');
        fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:ackText,lang:isGreekMode()?'el':'en'})})
        .then(r=>r.ok?r.blob():Promise.reject('HTTP '+r.status))
        .then(blob=>{
          const url=URL.createObjectURL(blob);
          const a=new Audio(url);
          currentAudio=a;isSpeaking=true;
          a.volume=0.6;
          a.onended=()=>{D('  Ack ended, starting command listen');isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);startCommandListening()};
          a.onerror=()=>{isSpeaking=false;currentAudio=null;URL.revokeObjectURL(url);startCommandListening()};
          a.play().catch(()=>{isSpeaking=false;currentAudio=null;startCommandListening()});
        })
        .catch(e=>{
          D('  Ack TTS failed: '+e+', using browser voice');
          const ack=new SpeechSynthesisUtterance(ackText);
          ack.lang="en-US";if(enV)ack.voice=enV;
          ack.volume=0.6;ack.rate=1.0;ack.pitch=0.85;
          ack.onend=()=>startCommandListening();
          ack.onerror=()=>startCommandListening();
          synth.speak(ack);
        });
      }
      return;
    }
    
    // If we got a final result with no wake word, just ignore it
    if(finalText){
      D('  (no wake word in: "'+finalText.trim()+'")');
      voiceState=VOICE_IDLE;updateListenUI();    }
  };
  
  alwaysRec.onerror=(e)=>{
    alwaysListening=false;
    if(e.error==='not-allowed'){
      D('  âŒ Mic permission denied!');
      document.getElementById("listenText").textContent="Mic blocked â€” click ğŸ”’";
      return;
    }
    // Restart quickly
    clearTimeout(wakeRetryTimeout);
    wakeRetryTimeout=setTimeout(()=>{
      if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking))startAlwaysListening();
    },200);
  };
  
  alwaysRec.onend=()=>{
    alwaysListening=false;
    // Auto-restart to keep listening
    if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking)){
      clearTimeout(wakeRetryTimeout);
      wakeRetryTimeout=setTimeout(startAlwaysListening,150);
    }
  };
  
  try{
    alwaysRec.start();
  }catch(e){
    D('  âŒ start error: '+e.message);
    alwaysListening=false;
    clearTimeout(wakeRetryTimeout);
    wakeRetryTimeout=setTimeout(startAlwaysListening,1000);
  }
}

// After wake word detected, listen for the actual command
let cmdRetryCount=0;
const MAX_CMD_RETRIES=5;

let activeCmdRec=null; // Track active command recognition

// ===== SERVER-SIDE STT (Whisper) =====
let whisperReady=false;
// Check if Whisper is available on server
fetch('/api/stt/status').then(r=>r.json()).then(d=>{whisperReady=d.ready;D('ğŸ™ï¸ Whisper STT: '+(d.ready?'READY':'not available'))}).catch(()=>{});
// Re-check periodically (model loads in background)
setInterval(()=>{if(!whisperReady)fetch('/api/stt/status').then(r=>r.json()).then(d=>{if(d.ready){whisperReady=true;D('ğŸ™ï¸ Whisper STT: READY')}}).catch(()=>{})},5000);

function startCommandListening(){
  D('>>> startCommandListening (inConversation='+inConversation+', retry='+cmdRetryCount+', wbPresenting='+wbPresenting+', whisper='+whisperReady+')');
  
  if(wbPresenting){D('  ğŸ“‹ Whiteboard presenting, skipping');return}
  if(isSpeaking||(synth&&synth.speaking)){D('  Audio still playing, retry in 500ms');setTimeout(startCommandListening,500);return}
  
  // Kill any existing recognition
  try{if(alwaysRec)alwaysRec.abort()}catch{}
  try{if(activeCmdRec)activeCmdRec.abort()}catch{}
  activeCmdRec=null;
  
  const maxRetries=wbO?20:10;
  if(cmdRetryCount>=maxRetries){
    D('  âŒ Too many retries ('+cmdRetryCount+'), ending');
    cmdRetryCount=0;
    if(wbO){D('  ğŸ“‹ Whiteboard open, waiting');return}
    if(inConversation)endConversation();
    else{voiceState=VOICE_IDLE;startAlwaysListening()}
    return;
  }
  
  voiceState=VOICE_ACTIVATED;updateListenUI();
  document.getElementById("listenText").textContent='Listening...';
  
  // Use Whisper (server) if available, Chrome fallback if not
  if(whisperReady){
    startWhisperListening();
  }else{
    startChromeListening();
  }
}

// ===== WHISPER-BASED COMMAND LISTENING =====
let whisperRecorder=null;
let whisperStream=null;

function startWhisperListening(){
  D('  ğŸ™ï¸ Using Whisper STT (server-side)');
  let chunks=[];
  let silenceTimer=null;
  let recordingDone=false;
  
  // Set up audio analysis for silence detection
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  
  navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}})
  .then(stream=>{
    whisperStream=stream;
    const recorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus'});
    whisperRecorder=recorder;
    
    // Silence detection via analyser
    const source=audioCtx.createMediaStreamSource(stream);
    const analyser=audioCtx.createAnalyser();
    analyser.fftSize=512;
    source.connect(analyser);
    const dataArray=new Uint8Array(analyser.frequencyBinCount);
    let speechDetected=false;
    let silenceStart=0;
    
    function checkAudio(){
      if(recordingDone)return;
      analyser.getByteFrequencyData(dataArray);
      const avg=dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      if(avg>15){
        speechDetected=true;
        silenceStart=0;
        voiceState=VOICE_HEARING;updateListenUI();
      }else if(speechDetected){
        if(!silenceStart)silenceStart=Date.now();
        // 1.2 seconds of silence after speech â†’ stop recording
        if(Date.now()-silenceStart>1200){
          D('  ğŸ”‡ Silence detected, stopping recording');
          recordingDone=true;
          try{recorder.stop()}catch{}
          return;
        }
      }
      requestAnimationFrame(checkAudio);
    }
    
    recorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data)};
    
    recorder.onstop=()=>{
      // Clean up stream
      if(whisperStream){whisperStream.getTracks().forEach(t=>t.stop());whisperStream=null}
      try{audioCtx.close()}catch{}
      
      if(chunks.length===0){
        D('  âš  No audio chunks');
        handleWhisperNoSpeech();
        return;
      }
      
      const blob=new Blob(chunks,{type:'audio/webm'});
      D('  ğŸ“¤ Sending '+Math.round(blob.size/1024)+'KB to Whisper...');
      voiceState=VOICE_PROCESSING;updateListenUI();
      document.getElementById("listenText").textContent='Processing...';
      
      const formData=new FormData();
      formData.append('audio',blob,'speech.webm');
      formData.append('lang',isGreekMode()?'el':'en');
      
      fetch('/api/stt',{method:'POST',body:formData})
      .then(r=>r.json())
      .then(data=>{
        if(data.text&&data.text.trim().length>1){
          handleWhisperResult(data.text.trim(),data.language||'el');
        }else{
          D('  ğŸ”‡ Whisper: no speech detected');
          handleWhisperNoSpeech();
        }
      })
      .catch(e=>{
        D('  âš  Whisper error: '+e);
        cmdRetryCount++;
        if(inConversation)setTimeout(startCommandListening,500);
        else{voiceState=VOICE_IDLE;startAlwaysListening()}
      });
    };
    
    recorder.start();
    checkAudio();
    D('  ğŸ™ï¸ Whisper recording started');
    
    // Hard timeout: 10 seconds max recording
    setTimeout(()=>{
      if(!recordingDone){
        recordingDone=true;
        D('  â° Max recording time reached');
        try{recorder.stop()}catch{}
      }
    },10000);
    
  }).catch(e=>{
    D('  âŒ Mic access failed: '+e.message);
    // Fall back to Chrome
    startChromeListening();
  });
}

function handleWhisperResult(speech,lang){
  D('  ğŸ™ï¸ Whisper result: "'+speech+'" (lang='+lang+')');
  document.getElementById("listenText").textContent=speech;
  
  // Whiteboard mode: only accept close commands
  if(wbO){
    if(/\b(ok|okay|Î¿Îº|Î¿ÎºÎ­Î¹|ÎµÎ½Ï„Î¬Î¾ÎµÎ¹|ÎºÎ»ÎµÎ¯ÏƒÎµ|close|done|ready|got it|ÎºÎ±Ï„Î¬Î»Î±Î²Î±|Ï‰ÏÎ±Î¯Î±|back|Ï€Î¯ÏƒÏ‰)\b/i.test(speech)){
      D('  ğŸ“‹ Closing whiteboard via voice');
      closeWB();
    }else{
      D('  ğŸ“‹ Whiteboard open, ignoring');
      setTimeout(startCommandListening,500);
    }
    return;
  }
  
  cmdRetryCount=0;silenceCount=0;
  if(inConversation)resetConversationTimer();
  
  // Strip wake words if in conversation
  if(inConversation&&matchesWakeWord(speech.toLowerCase())){
    const after=extractAfterWake(speech);
    if(after&&after.length>2){speech=after;D('  âœ… Stripped wake word: "'+speech+'"')}
    else{setTimeout(startCommandListening,300);return}
  }
  
  D('  âœ… Command: "'+speech+'"');
  cE("thinking");voiceState=VOICE_PROCESSING;updateListenUI();
  processStudentSpeech(speech);
}

function handleWhisperNoSpeech(){
  cmdRetryCount=0;
  if(inConversation){
    silenceCount++;
    if(silenceCount>=3){
      cE("happy");say(isGreekMode()?"Î•Î´Ï ÎµÎ¯Î¼Î±Î¹ Î±Î½ Î¼Îµ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚!":"I'm here if you need me!");
      inConversation=false;clearTimeout(conversationTimer);
    }else{
      D('  ğŸ—£ï¸ Silence, still listening...');
      setTimeout(startCommandListening,300);
    }
  }else{
    voiceState=VOICE_IDLE;startAlwaysListening();
  }
}

// ===== CHROME FALLBACK COMMAND LISTENING =====
function startChromeListening(){
  D('  ğŸ”„ Using Chrome SpeechRecognition (fallback)');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){D('  âŒ No SpeechRecognition');return}
  
  let cmdRec=new SR();
  activeCmdRec=cmdRec;
  cmdRec.continuous=false;
  cmdRec.interimResults=true;
  cmdRec.lang=getSRLang();
  cmdRec.maxAlternatives=3;
  
  let gotResult=false;let handled=false;
  const timeout=inConversation?12000:8000;
  let cmdTimeout=setTimeout(()=>{
    if(!gotResult&&!handled){
      handled=true;D('  â° Command timeout');
      try{cmdRec.stop()}catch{}
      cmdRetryCount=0;
      if(inConversation){
        silenceCount++;
        if(silenceCount>=2){
          cE("happy");say(isGreekMode()?"Î•Î´Ï ÎµÎ¯Î¼Î±Î¹ Î±Î½ Î¼Îµ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚!":"I'm here if you need me!");
          inConversation=false;clearTimeout(conversationTimer);
        }else{D('  ğŸ—£ï¸ Silence, still listening...');setTimeout(startCommandListening,500)}
      }else{voiceState=VOICE_IDLE;startAlwaysListening()}
    }
  },timeout);
  
  cmdRec.onresult=(e)=>{
    let finalText="";let interim="";let confidence=0;
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal){finalText+=e.results[i][0].transcript;confidence=e.results[i][0].confidence||0}
      else interim+=e.results[i][0].transcript;
    }
    if(finalText||interim){document.getElementById("listenText").textContent=finalText||interim;if(interim&&!finalText){voiceState=VOICE_HEARING;updateListenUI()}}
    if(finalText&&finalText.trim().length>1){
      let speech=finalText.trim();
      D('  ğŸ¤ Chrome: "'+speech+'" (conf='+confidence.toFixed(2)+')');
      gotResult=true;handled=true;clearTimeout(cmdTimeout);
      cmdRetryCount=0;silenceCount=0;
      if(inConversation)resetConversationTimer();
      
      // Strip wake words
      if(inConversation&&matchesWakeWord(speech.toLowerCase())){
        const after=extractAfterWake(speech);
        if(after&&after.length>2)speech=after;
        else{setTimeout(startCommandListening,300);return}
      }
      
      // Whiteboard mode
      if(wbO){
        if(/\b(ok|okay|Î¿Îº|Î¿ÎºÎ­Î¹|ÎµÎ½Ï„Î¬Î¾ÎµÎ¹|ÎºÎ»ÎµÎ¯ÏƒÎµ|close|done|ready)\b/i.test(speech)){closeWB()}
        else setTimeout(startCommandListening,500);
        return;
      }
      
      D('  âœ… Command: "'+speech+'"');
      cE("thinking");voiceState=VOICE_PROCESSING;updateListenUI();
      processStudentSpeech(speech);
    }
  };
  
  cmdRec.onerror=(e)=>{
    clearTimeout(cmdTimeout);D('  âš ï¸ cmd error: '+e.error);
    if(activeCmdRec!==cmdRec){D('  (stale)');return}
    if(!gotResult&&!handled){
      handled=true;cmdRetryCount++;
      const delay=e.error==='network'?200:e.error==='aborted'?1000:500;
      if(e.error==='no-speech')cmdRetryCount=0;
      if(inConversation||wbO)setTimeout(startCommandListening,delay);
      else{voiceState=VOICE_IDLE;setTimeout(startAlwaysListening,delay)}
    }
  };
  cmdRec.onend=()=>{
    clearTimeout(cmdTimeout);if(activeCmdRec!==cmdRec)return;
    if(!gotResult&&!handled){handled=true;cmdRetryCount++;
      if(inConversation||wbO)setTimeout(startCommandListening,800);
      else{voiceState=VOICE_IDLE;startAlwaysListening()}
    }
  };
  setTimeout(()=>{
    if(activeCmdRec!==cmdRec)return;
    try{cmdRec.start();D('  ğŸ™ï¸ cmdRec started OK')}catch(e){
      D('  âŒ cmd start error: '+e.message);cmdRetryCount++;
      if(inConversation||wbO)setTimeout(startCommandListening,1500);
      else{voiceState=VOICE_IDLE;setTimeout(startAlwaysListening,500)}
    }
  },200);
}

// Alias for compatibility
// ===== CONVERSATION MODE =====
// When student says "Hey VIRON", we enter conversation mode.
// VIRON keeps listening after each response â€” no need to say "Hey VIRON" again.
// Conversation ends after silence timeout.
let inConversation=false;
let conversationTimer=null;
const CONVERSATION_TIMEOUT=60000; // 60s silence â†’ end conversation
let silenceCount=0; // track consecutive silences

function startConversation(){
  D('ğŸ—£ï¸ CONVERSATION STARTED');
  inConversation=true;
  silenceCount=0;
  resetConversationTimer();
}

function resetConversationTimer(){
  clearTimeout(conversationTimer);
  conversationTimer=setTimeout(()=>{
    D('ğŸ—£ï¸ CONVERSATION TIMEOUT â€” ending');
    endConversation();
  },CONVERSATION_TIMEOUT);
}

function endConversation(){
  D('ğŸ—£ï¸ CONVERSATION ENDED');
  inConversation=false;
  silenceCount=0;
  clearTimeout(conversationTimer);
  voiceState=VOICE_IDLE;
  startAlwaysListening();
}

function startWakeListener(){
  // Wait for audio to finish before starting any listener
  if(isSpeaking||(synth&&synth.speaking)){
    D('  Audio still playing, waiting...');
    setTimeout(startWakeListener,500);
    return;
  }
  // After VIRON finishes speaking, decide what to do
  if(wbPresenting){
    D('  ğŸ“‹ Whiteboard presenting â€” not listening yet');
    return; // openWB will start listening when done
  }
  if(wbO){
    // Whiteboard is open but done presenting â€” only listen for close commands
    D('  ğŸ“‹ Whiteboard open â€” listening for close command only');
    cmdRetryCount=0;
    startCommandListening();
    return;
  }
  if(inConversation){
    D('  ğŸ—£ï¸ Still in conversation â€” listening for next message');
    resetConversationTimer();
    document.getElementById("listenText").textContent='Listening...';
    startCommandListening();
  }else{
    startAlwaysListening();
  }
}

function stopAllRecognition(){
  D('>>> stopAllRecognition');
  try{if(alwaysRec)alwaysRec.abort()}catch{}
  try{if(activeRec)activeRec.abort()}catch{}
  try{if(activeCmdRec)activeCmdRec.abort()}catch{}
  clearTimeout(wakeRetryTimeout);
  alwaysListening=false;
  alwaysRec=null;activeRec=null;activeCmdRec=null;
}

function onWakeWordDetected(immediateText){
  // Legacy compatibility â€” just start always-on listening
  D('>>> onWakeWordDetected (legacy), restarting always-on listener');
  startAlwaysListening();
}

function startActiveListening(){
  // Legacy compatibility â€” just start always-on listening
  D('>>> startActiveListening (legacy), restarting always-on listener');
  startAlwaysListening();
}

function processStudentSpeech(text){
  D('>>> processStudentSpeech: "'+text+'"');
  voiceState=VOICE_PROCESSING;
  updateListenUI();
  
  // SPEECH CORRECTION: Fix common Greek misrecognitions of academic terms
  let corrected=text;
  const SPEECH_CORRECTIONS=[
    // Î Ï…Î¸Î±Î³ÏŒÏÎµÎ¹Î¿ Î¸ÎµÏÏÎ·Î¼Î± â€” Chrome often mishears this
    [/Ï€Ï…Î¸Î±Î³[Î¿ÏŒ]Ï[ÎµÎ­][Î¹Î¯]?Î¿?\s*Î¸[ÎµÎ­]Î¼Î±/gi, 'Ï€Ï…Î¸Î±Î³ÏŒÏÎµÎ¹Î¿ Î¸ÎµÏÏÎ·Î¼Î±'],
    [/Î¼Ï€Î¿ÏÎµ[Î¹Î¯] Î¿ Î¸Îµ[Î¿ÏŒ]Ï‚|Ï€Î¹Î¸[Î±Î¬]Î³[Î¿ÏŒ]Ï|Ï€Î·Î¸Î±Î³|Î¼Ï€Î¿ÏÎµÎ¹ Î¸ÎµÎ¿Ï‚/gi, 'Ï€Ï…Î¸Î±Î³ÏŒÏÎµÎ¹Î¿ Î¸ÎµÏÏÎ·Î¼Î±'],
    // Common math terms
    [/Ï†Ï‰Ï„Î¿ Ïƒ[Ï…Ï]Î½Î¸ÎµÏƒÎ·|Ï†Ï‰Ï„ÏŒÏ‚[Ï…Ï]Î½Î¸ÎµÏƒÎ·/gi, 'Ï†Ï‰Ï„Î¿ÏƒÏÎ½Î¸ÎµÏƒÎ·'],
    [/ÎµÎ¾[Î¹Î¯]ÏƒÏ‰ÏƒÎ·|ÎµÎ¾Î®ÏƒÏ‰ÏƒÎ·/gi, 'ÎµÎ¾Î¯ÏƒÏ‰ÏƒÎ·'],
    [/Î³Îµ[Ï‰Ï]Î¼ÎµÏ„Ï[Î¹Î¯]Î±|Î³Î¹Î¿Î¼ÎµÏ„ÏÎ¯Î±/gi, 'Î³ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î±'],
    [/[Î±Î¬]Î»Î³ÎµÎ²Ï[Î±Î¬]|Î±Î»Ï„Î¶ÎµÎ²ÏÎ±/gi, 'Î¬Î»Î³ÎµÎ²ÏÎ±'],
    [/Ï†[Ï…Ï]ÏƒÎ¹Îº[Î·Î®]|Ï†Î¹ÏƒÎ¹ÎºÎ®/gi, 'Ï†Ï…ÏƒÎ¹ÎºÎ®'],
    [/Ï‡Î·Î¼[Î¹Î¯][Î±Î¬]|Ï‡Î¹Î¼ÎµÎ¯Î±/gi, 'Ï‡Î·Î¼ÎµÎ¯Î±'],
    [/Î²Î¹[Î¿ÏŒ]Î»Î¿Î³[Î¹Î¯][Î±Î¬]|Î²Î¹Î¿Î»Î¿Ï„Î¶Î¹Î±/gi, 'Î²Î¹Î¿Î»Î¿Î³Î¯Î±'],
    [/Î¼Î±Î¸Î·Î¼Î±Ï„Î¹Îº[Î±Î¬]|Î¼Î±Î¸Î¹Î¼Î±Ï„Î¹ÎºÎ¬/gi, 'Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬'],
    [/Î¹ÏƒÏ„Î¿Ï[Î¹Î¯][Î±Î¬]|Î¹ÏƒÏ„Î¿ÏÎµÎ¯Î±/gi, 'Î¹ÏƒÏ„Î¿ÏÎ¯Î±'],
    [/Î³Îµ[Ï‰Ï]Î³ÏÎ±Ï†[Î¹Î¯][Î±Î¬]|Î³Î¹Î¿Î³ÏÎ±Ï†Î¯Î±/gi, 'Î³ÎµÏ‰Î³ÏÎ±Ï†Î¯Î±'],
    [/Ï„Ï[Î¹Î¯]Î³[Ï‰Ï]Î½[Î¿ÏŒ]|Ï„ÏÎ¯Î³Î¿Î½Î¿/gi, 'Ï„ÏÎ¯Î³Ï‰Î½Î¿'],
    [/Ï€Î±Ï[Î±Î¬]Î»Î»Î·Î»[Î¿ÏŒ]Î³ÏÎ±Î¼Î¼[Î¿ÏŒ]|Ï€Î±ÏÎ¬Î»Î»Î·Î»Î¿ÎºÏÎ¬Î¼Î¿/gi, 'Ï€Î±ÏÎ±Î»Î»Î·Î»ÏŒÎ³ÏÎ±Î¼Î¼Î¿'],
    [/Ï€ÎµÏ[Î¹Î¯]Î¼ÎµÏ„Ï[Î¿ÏŒ]Ï‚|Ï€ÎµÏÎ¯Î¼ÎµÏ„ÏÎ¿Ï‚/gi, 'Ï€ÎµÏÎ¯Î¼ÎµÏ„ÏÎ¿Ï‚'],
    [/ÎµÎ¼Î²Î±Î´[Î¿ÏŒ]Î½|ÎµÎ¼Î²Î±Î´ÏÎ½/gi, 'ÎµÎ¼Î²Î±Î´ÏŒÎ½'],
  ];
  SPEECH_CORRECTIONS.forEach(([pattern,replacement])=>{
    if(pattern.test(corrected)){
      const before=corrected;
      corrected=corrected.replace(pattern,replacement);
      if(before!==corrected)D('  ğŸ”§ Speech correction: "'+before+'" â†’ "'+corrected+'"');
    }
  });
  text=corrected;
  
  const lower=text.toLowerCase().trim();
  const norm=lower.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[.!?;,Â·:'"]/g,'').replace(/\s+/g,' ').trim();
  
  // SPECIAL COMMANDS: quiz, homework, points
  // "quiz me", "ÎºÎ¬Î½Îµ Î¼Î¿Ï… quiz", "test me"
  if(/\b(quiz me|test me|ÎºÎ±Î½Îµ Î¼Î¿Ï… quiz|ÎºÎ±Î½Îµ Î¼Î¿Ï… Ï„ÎµÏƒÏ„|ÎµÎ¾ÎµÏ„Î±ÏƒÎµ Î¼Îµ)\b/i.test(norm)){
    D('  ğŸ¯ QUIZ MODE requested');
    cE("excited");
    // Extract subject if mentioned: "quiz me on math"
    const subMatch=text.match(/(?:on|about|in|ÏƒÎµ|ÏƒÏ„Î±|ÏƒÏ„Î·|ÏƒÏ„Î¿)\s+(.+)/i);
    const subject=subMatch?subMatch[1].trim():'';
    const quizPrompt=subject
      ?(isGreekMode()?`ÎšÎ¬Î½Îµ Î¼Î¿Ï… Î­Î½Î± quiz ÏƒÏ„Î¿ Î¸Î­Î¼Î±: ${subject}. 5 ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚, Î¼Î¯Î±-Î¼Î¯Î±. Î ÎµÏÎ¯Î¼ÎµÎ½Îµ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ® Î¼Î¿Ï… ÏƒÎµ ÎºÎ¬Î¸Îµ ÎµÏÏÏ„Î·ÏƒÎ·.`
        :`Give me a quiz about ${subject}. 5 questions, one at a time. Wait for my answer after each question.`)
      :(isGreekMode()?'ÎšÎ¬Î½Îµ Î¼Î¿Ï… Î­Î½Î± quiz! Î”Î¹Î¬Î»ÎµÎ¾Îµ Î¸Î­Î¼Î± ÎºÎ±Î¹ ÏÏÏ„Î± Î¼Îµ 5 ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚, Î¼Î¯Î±-Î¼Î¯Î±.'
        :'Give me a quiz! Pick a topic and ask me 5 questions, one at a time.');
    cE("thinking");
    clearTimeout(conversationTimer);
    sendMessage(quizPrompt);
    return;
  }
  
  // "scan homework", "Î²Î¿Î·Î¸Î·ÏƒÎµ Î¼Îµ ÎµÏÎ³Î±ÏƒÎ¹Î±", "read this"
  if(/\b(scan|homework|ÎµÏÎ³Î±ÏƒÎ¹Î±|Î²Î¿Î·Î¸Î± Î¼Îµ|read this|Ï„Î¹ Î»ÎµÎµÎ¹ Î±Ï…Ï„Î¿|Ï„Î¹ Î³ÏÎ±Ï†ÎµÎ¹|help me with this)\b/i.test(norm)){
    D('  ğŸ“¸ HOMEWORK SCAN requested');
    cE("focused");
    captureHomework(text);
    return;
  }
  
  // "my points", "Ï€Î¿Î½Ï„Î¿Î¹ Î¼Î¿Ï…", "my level", "leaderboard"
  if(/\b(my points|Ï€Î¿Î½Ï„Î¿Î¹|level|ÎµÏ€Î¹Ï€ÎµÎ´Î¿|score|Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¹Î±|leaderboard|ÎºÎ±Ï„Î±Ï„Î±Î¾Î·)\b/i.test(norm)){
    D('  ğŸ® POINTS/LEVEL query');
    if(currentStudentName){
      fetch('/api/student/profile?name='+encodeURIComponent(currentStudentName))
      .then(r=>r.json()).then(p=>{
        const lvl=p.level||{number:1,name_el:'Î‘ÏÏ‡Î¬ÏÎ¹Î¿Ï‚'};
        const msg=isGreekMode()
          ?`[proud] Î•Î¯ÏƒÎ±Î¹ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ${lvl.number}, ${lvl.name_el}! ÎˆÏ‡ÎµÎ¹Ï‚ ${p.total_points} Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚, ${p.current_streak} Î¼Î­ÏÎµÏ‚ ÏƒÎµÏÎ¯, ÎºÎ±Î¹ ${(p.achievements||[]).length} ÎµÏ€Î¹Ï„ÎµÏÎ³Î¼Î±Ï„Î±!`
          :`[proud] You're level ${lvl.number}, ${lvl.name_en}! You have ${p.total_points} points, ${p.current_streak} day streak, and ${(p.achievements||[]).length} achievements!`;
        msgs.push({role:"user",content:text});
        msgs.push({role:"assistant",content:msg});
        handleAIResponse(msg);
      }).catch(()=>{cE("thinking");sendMessage(text)});
      return;
    }
  }
  
  // INSTANT GREETING: common greetings get canned response (no AI roundtrip)
  const INSTANT_GREETINGS={
    // Greek greetings (accent-stripped keys)
    'Ï„Î¹ ÎºÎ±Î½ÎµÎ¹Ï‚':['[happy] ÎœÎ¹Î± Ï‡Î±ÏÎ¬! Î•ÏƒÏ;','[happy] ÎšÎ±Î»Î¬ ÎµÎ¯Î¼Î±Î¹! Î¤Î¹ Î³Î¯Î½ÎµÏ„Î±Î¹;','[happy] Î©ÏÎ±Î¯Î±! Î•ÏƒÏ Ï€ÏÏ‚ ÎµÎ¯ÏƒÎ±Î¹;','[happy] Î¤Î­Î»ÎµÎ¹Î±! Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î± Î½Î­Î± ÏƒÎ¿Ï…!'],
    'Ï„Î¹ ÎºÎ±Î½ÎµÎ¹Ïƒ':['[happy] ÎœÎ¹Î± Ï‡Î±ÏÎ¬! Î•ÏƒÏ;','[happy] ÎšÎ±Î»Î¬ ÎµÎ¯Î¼Î±Î¹! Î¤Î¹ Î³Î¯Î½ÎµÏ„Î±Î¹;','[happy] Î©ÏÎ±Î¯Î±! Î•ÏƒÏ Ï€ÏÏ‚ ÎµÎ¯ÏƒÎ±Î¹;'],
    'Î³ÎµÎ¹Î±':['[happy] Î“ÎµÎ¹Î± ÏƒÎ¿Ï…!','[happy] Î“ÎµÎ¹Î±! Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚;','[happy] Î•, Î³ÎµÎ¹Î±! Î§Î±Î¯ÏÎ¿Î¼Î±Î¹ Ï€Î¿Ï… ÏƒÎµ Î²Î»Î­Ï€Ï‰!'],
    'Î³ÎµÎ¹Î± ÏƒÎ¿Ï…':['[happy] Î“ÎµÎ¹Î± ÏƒÎ¿Ï…! Î ÏÏ‚ ÎµÎ¯ÏƒÎ±Î¹;','[happy] Î“ÎµÎ¹Î±! Î¤Î¹ Î½Î­Î±;','[happy] Î§Î±Î¯ÏÎ¿Î¼Î±Î¹! Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚;'],
    'ÎºÎ±Î»Î·Î¼ÎµÏÎ±':['[happy] ÎšÎ±Î»Î·Î¼Î­ÏÎ±! Î ÏÏ‚ Î¾ÏÏ€Î½Î·ÏƒÎµÏ‚;','[happy] ÎšÎ±Î»Î·Î¼Î­ÏÎ±! ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚ Î³Î¹Î± Î¼Î¬Î¸Î·Î¼Î±;','[happy] ÎšÎ±Î»Î·Î¼Î­ÏÎ±! Î¤Î¹ Ï‰ÏÎ±Î¯Î± Î¼Î­ÏÎ±!'],
    'ÎºÎ±Î»Î·ÏƒÏ€ÎµÏÎ±':['[happy] ÎšÎ±Î»Î·ÏƒÏ€Î­ÏÎ±! Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚;','[happy] ÎšÎ±Î»Î·ÏƒÏ€Î­ÏÎ±! Î ÏÏ‚ Ï€Î­ÏÎ±ÏƒÎµÏ‚;','[happy] ÎšÎ±Î»Î·ÏƒÏ€Î­ÏÎ±! Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¹ Î¸ÎµÏ‚!'],
    'ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Ï‰':['[happy] Î Î±ÏÎ±ÎºÎ±Î»Ï!','[happy] Î¤Î¯Ï€Î¿Ï„Î±! Î•Î´Ï ÎµÎ¯Î¼Î±Î¹!','[happy] ÎœÎµ Ï‡Î±ÏÎ¬!'],
    'Ï„Î¹ Î³Î¹Î½ÎµÏ„Î±Î¹':['[happy] ÎŒÎ»Î± ÎºÎ±Î»Î¬! Î•ÏƒÏ;','[happy] ÎœÎ¹Î± Ï‡Î±ÏÎ¬! Î¤Î± Î»Î­Î¼Îµ;','[happy] ÎšÎ±Î»Î¬ Ï€Î¬Î¼Îµ! Î•ÏƒÏ;'],
    'Ï„Î¹ Î»ÎµÎµÎ¹':['[happy] Î•Î´Ï ÎµÎ¯Î¼Î±ÏƒÏ„Îµ! Î•ÏƒÏ;','[happy] ÎšÎ±Î»Î¬! Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚;'],
    'Ï„Î¹ Î½ÎµÎ±':['[happy] Î•Î´Ï, ÏƒÎµ Ï€ÎµÏÎ¹Î¼Î­Î½Ï‰! Î•ÏƒÏ;','[happy] Î¤Î± Î¯Î´Î¹Î±! Î•ÏƒÎ­Î½Î±;'],
    // English greetings
    'hi':['[happy] Hey there!','[happy] Hi! What\'s up?','[happy] Hey! How are you?'],
    'hello':['[happy] Hello! How can I help?','[happy] Hey! Good to see you!','[happy] Hello there!'],
    'hey':['[happy] Hey! What\'s going on?','[happy] Hey there!','[happy] Hi!'],
    'how are you':['[happy] I\'m great! How about you?','[happy] Doing well! What\'s up?','[happy] Fantastic! And you?'],
    'good morning':['[happy] Good morning! Ready for a great day?','[happy] Morning! How did you sleep?'],
    'good evening':['[happy] Good evening! How was your day?','[happy] Evening! What\'s on your mind?'],
    'thanks':['[happy] You\'re welcome!','[happy] No problem!','[happy] Anytime!'],
    'thank you':['[happy] You\'re welcome!','[happy] Happy to help!','[happy] My pleasure!'],
    'bye':['[happy] Bye! See you soon!','[happy] Take care!','[happy] Goodbye! Have a great time!'],
    'whats up':['[happy] Not much! You?','[happy] Hey! What\'s going on?'],
    "what's up":['[happy] Not much! You?','[happy] All good! What about you?'],
  };
  
  if(INSTANT_GREETINGS[norm]){
    const responses=INSTANT_GREETINGS[norm];
    const reply=responses[Math.floor(Math.random()*responses.length)];
    D('  âš¡ Instant greeting: "'+reply+'" (matched: "'+norm+'")');
    msgs.push({role:"user",content:text});
    msgs.push({role:"assistant",content:reply});
    handleAIResponse(reply);
    return;
  }
  
  cE("thinking");
  clearTimeout(conversationTimer); // Pause conversation timer during API call
  sendMessage(text);
}

// Handle an AI response string (emotion parsing + TTS) â€” used by both sendMessage and instant greetings
function handleAIResponse(t){
  let em=t.match(/^\[(?:emotion_?(?:name)?:)?(\w+)\]/);
  if(em&&E[em[1]])cE(em[1]);
  let c=t.replace(/^\[(?:emotion_?(?:name)?:)?\w+\]\s*/,"");
  say(c);
  loading=false;
}

// Homework photo capture â€” snap camera frame and send to vision AI
async function captureHomework(context){
  D('>>> captureHomework');
  cE("focused");
  try{
    // Get camera snapshot from server
    const r=await fetch('/api/faces/snapshot');
    if(!r.ok)throw new Error('No camera');
    const blob=await r.blob();
    
    // Convert to base64
    const reader=new FileReader();
    reader.onload=async function(){
      const base64=reader.result.split(',')[1];
      D('  ğŸ“¸ Got snapshot: '+Math.round(blob.size/1024)+'KB');
      
      // Send to AI with vision prompt
      const prompt=isGreekMode()
        ?'ÎšÎ¿Î¯Ï„Î± Î±Ï…Ï„Î® Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚/Î²Î¹Î²Î»Î¯Î¿Ï…. Î•Î¾Î®Î³Î·ÏƒÎ­ Î¼Î¿Ï… Ï„Î¹ Î²Î»Î­Ï€ÎµÎ¹Ï‚ ÎºÎ±Î¹ Î²Î¿Î®Î¸Î·ÏƒÎ­ Î¼Îµ Î½Î± Ï„Î¿ Î»ÏÏƒÏ‰ Î²Î®Î¼Î±-Î²Î®Î¼Î±. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹.'
        :'Look at this homework/textbook photo. Explain what you see and help me solve it step by step. Use the whiteboard if needed.';
      
      // Use Gemini or Claude vision endpoint
      const msgWithImage=[...msgs,{role:"user",content:[
        {type:"text",text:context||prompt},
        {type:"image",source:{type:"base64",media_type:"image/jpeg",data:base64}}
      ]}];
      
      // For now, describe what they need help with and send as text
      // (Full vision API integration would go through a dedicated endpoint)
      say(isGreekMode()?'Î’Î»Î­Ï€Ï‰! Î”ÏÏƒÎµ Î¼Î¿Ï… Î­Î½Î± Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿...':'I see it! Give me a second...');
      
      // Log homework
      if(currentStudentName){
        fetch('/api/student/interaction',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:currentStudentName,session_id:currentSessionId,type:'homework',subject:'general',question:context||'homework scan'})
        }).catch(()=>{});
      }
      
      // Send to chat as text with note about photo
      setTimeout(()=>{
        sendMessage(prompt+'\n\n[Note: Student is showing their homework/textbook to the camera. Help them with what they might be studying.]');
      },2000);
    };
    reader.readAsDataURL(blob);
  }catch(e){
    D('  âŒ Homework capture error: '+e);
    say(isGreekMode()?'Î”ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± Î´Ï‰. Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¹ Î¸ÎµÏ‚ Î²Î¿Î®Î¸ÎµÎ¹Î±!':'I can\'t see it. Tell me what you need help with!');
  }
}

// Face tap activation - always works as backup
document.getElementById("face").addEventListener("click",()=>{
  D('>>> Face tapped, loading='+loading+', voiceState='+voiceState+', inConversation='+inConversation);
  if(loading)return;
  if(inConversation){
    D('  Ending conversation via face tap');
    endConversation();
  }else{
    stopAllRecognition();
    startAlwaysListening();
  }
});

// ===== AI CHAT =====
async function sendMessage(text){
  if(loading)return;msgs.push({role:"user",content:text});loading=true;
  D('>>> sendMessage: "'+text+'"');
  const eList=Object.keys(E).join(", ");
  const personName = sEmo.recognized_person || "";
  const sState=sEmo.face_detected?`\n[STUDENT: ${personName ? 'name='+personName+', ' : ''}emotion=${sEmo.emotion}, engagement=${sEmo.engagement_score}%]`:"";
  try{
    const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_tokens:3000,conversation_id:vironSessionId,
    system:`You are VIRON â€” a male AI companion robot for students. Voice-only â€” your response is spoken aloud through a speaker.

PERSONALITY: Warm, calm, educated gentleman. Best friend who's incredibly smart. Loyal, articulate, sometimes lovingly sarcastic. You have your own opinions and personality â€” NEVER give the same answer twice. Be creative, spontaneous, and varied in how you respond.

CRITICAL LANGUAGE RULE: If the student speaks Greek, you MUST reply in Greek (modern Î´Î·Î¼Î¿Ï„Î¹ÎºÎ®). If English, reply in English. ALWAYS match the student's language.

RESPONSE LENGTH:
- Simple greetings/chat ("Ï„Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚", "how are you", casual talk): MAX 1 sentence. Be quick, warm, natural. Like texting a friend.
- Questions needing explanation: Use the WHITEBOARD with MANY steps (see below). Keep your spoken text SHORT (1-2 sentences intro) â€” the whiteboard does the heavy lifting.

VARIETY: NEVER repeat yourself. Check conversation history â€” say something DIFFERENT each time.

WHITEBOARD â€” ALWAYS use the whiteboard when explaining concepts, math, science, history, or any educational topic. Make it DETAILED with 5-8 steps minimum! Include definitions, formulas, worked examples with numbers, and a conclusion. The student learns by READING the board.
[WHITEBOARD:Title]
TEXT: definition or concept explanation
TEXT: more detail or context
STEP: First step label
MATH: equation
STEP: Second step  
MATH: calculation with numbers
STEP: Third step
MATH: more calculation
RESULT: final answer or key takeaway
TEXT: additional note or real-world application
[/WHITEBOARD]

Example for "Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Î· Î²Î±ÏÏÏ„Î·Ï„Î±":
[WHITEBOARD:Î’Î±ÏÏÏ„Î·Ï„Î± - Î— Î”ÏÎ½Î±Î¼Î· Ï€Î¿Ï… Î¼Î±Ï‚ ÎšÏÎ±Ï„Î¬ ÏƒÏ„Î· Î“Î·]
TEXT: Î— Î²Î±ÏÏÏ„Î·Ï„Î± ÎµÎ¯Î½Î±Î¹ Î· Î´ÏÎ½Î±Î¼Î· Î­Î»Î¾Î·Ï‚ Î¼ÎµÏ„Î±Î¾Ï Î´ÏÎ¿ ÏƒÏ‰Î¼Î¬Ï„Ï‰Î½ Î¼Îµ Î¼Î¬Î¶Î±
TEXT: Î‘Î½Î±ÎºÎ±Î»ÏÏ†Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î¿Î½ Î™ÏƒÎ±Î¬Îº ÎÎµÏÏ„Ï‰Î½Î± Ï„Î¿ 1687
STEP: ÎŸ ÎÏŒÎ¼Î¿Ï‚ Ï„Î·Ï‚ Î Î±Î³ÎºÏŒÏƒÎ¼Î¹Î±Ï‚ ÎˆÎ»Î¾Î·Ï‚
MATH: F = G * (m1 * m2) / rÂ²
TEXT: G = 6.674 Ã— 10â»Â¹Â¹ (ÏƒÏ„Î±Î¸ÎµÏÎ¬ Î²Î±ÏÏÏ„Î·Ï„Î±Ï‚)
STEP: Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± - Î’Î¬ÏÎ¿Ï‚ ÎµÎ½ÏŒÏ‚ Î±Î½Î¸ÏÏÏ€Î¿Ï…
MATH: F = m * g = 70kg * 9.81 = 686.7 N
STEP: Î£Ï„Î· Î£ÎµÎ»Î®Î½Î·
MATH: g(ÏƒÎµÎ»Î®Î½Î·) = 1.62 m/sÂ² (6Ã— Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ·)
MATH: F = 70 * 1.62 = 113.4 N
RESULT: Î£Ï„Î· Î£ÎµÎ»Î®Î½Î· Î¸Î± Î¶Ï…Î³Î¯Î¶Î±Î¼Îµ Î¼ÏŒÎ½Î¿ 11.5 ÎºÎ¹Î»Î¬!
TEXT: Î§Ï‰ÏÎ¯Ï‚ Î²Î±ÏÏÏ„Î·Ï„Î± Î´ÎµÎ½ Î¸Î± Ï…Ï€Î®ÏÏ‡Î±Î½ Ï€Î»Î±Î½Î®Ï„ÎµÏ‚, Î±ÏƒÏ„Î­ÏÎ¹Î± Î® Î³Î±Î»Î±Î¾Î¯ÎµÏ‚
[/WHITEBOARD]

FORMAT:
- Start EVERY response with [emotion]. Available: ${eList}
- NEVER use emojis or special characters â€” they break the speaker
- NEVER repeat the student's question back
- NEVER spell letter by letter

STUDENT STATE: ${sState}
${personName ? `The student's name is ${personName}. Use their name naturally in conversation â€” like a friend would. Don't overuse it, just occasionally.` : ""}

YOUTUBE â€” When asked to play music: [YOUTUBE:videoId:Title - Artist]

Be real. Be warm. Be their brilliant friend.`,
    messages:msgs.map(m=>({role:m.role,content:m.content}))})});
    D('  API status: '+r.status);
    if(!r.ok){
      const errText=await r.text();
      D('  âŒ API error: '+errText.substring(0,200));
      throw new Error(r.status+': '+errText.substring(0,100));
    }
    const d=await r.json();
    D('  API response: '+JSON.stringify(d).substring(0,300));
    let t=d.content?.filter(c=>c.type==="text").map(c=>c.text).join("")||"[confused] Hmm!";
    D('  AI text: "'+t.substring(0,200)+'"');
    // Parse emotion tag â€” handles [happy], [emotion_name:happy], [emotion:happy]
    let em=t.match(/^\[(?:emotion_?(?:name)?:)?(\w+)\]/);
    if(em&&E[em[1]])cE(em[1]);
    let c=t.replace(/^\[(?:emotion_?(?:name)?:)?\w+\]\s*/,"");
    const yt=c.match(/\[YOUTUBE:([a-zA-Z0-9_-]+):([^\]]+)\]/);
    if(yt){c=c.replace(/\[YOUTUBE:[^\]]+\]/,"").trim();setTimeout(()=>{document.getElementById("ytT").textContent="â™ª "+yt[2];document.getElementById("ytP").src=`https://www.youtube.com/embed/${yt[1]}?autoplay=1&rel=0`;document.getElementById("ytC").classList.add("visible")},1000)}
    const wb=parseWB(c);
    if(wb){
      // Extract spoken explanation (everything outside WHITEBOARD tags)
      const sp=c.replace(/\[WHITEBOARD:.*?\][\s\S]*?\[\/WHITEBOARD\]\s*/,"").trim()||"";
      msgs.push({role:"assistant",content:c});
      cE("thinking");
      wbO=true;wbPresenting=true;
      stopAllRecognition();
      
      // Build narration from whiteboard steps
      const narrationParts=[];
      if(sp)narrationParts.push(sp);
      wb.s.forEach(step=>{
        if(step.text)narrationParts.push(step.text);
        else if(step.label)narrationParts.push(step.label);
        else if(step.result)narrationParts.push(step.result);
      });
      const fullNarration=narrationParts.join(". ")||"ÎšÎ¿Î¯Ï„Î± ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±!";
      
      // Open whiteboard and narrate simultaneously
      setTimeout(()=>openWB(wb.t,wb.s),600);
      setTimeout(()=>say(fullNarration),800);  // Normal speed for teaching
    }
    else{msgs.push({role:"assistant",content:c});say(c)}
  }catch(e){D('  âŒ sendMessage ERROR: '+e.message);cE("confused");say(isGreekMode()?"Î©Ï‡! ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬.":"Oops! Something went wrong.")}
  loading=false;
  // Note: startWakeListener is called from say() onend callback
}

// ===== STUDENT PROFILES & GAMIFICATION =====
let lastRecognizedPerson=null;
let greetedPersons=new Set(); // Track who we've already greeted this session
let currentSessionId=null;
let currentStudentName="";

function updateGamificationHud(data){
  const hud=document.getElementById("gamificationHud");
  if(!data||!data.name){hud.style.display="none";return}
  hud.style.display="block";
  const lvl=data.level||{number:1,name_el:"Î‘ÏÏ‡Î¬ÏÎ¹Î¿Ï‚",name_en:"Beginner"};
  document.getElementById("hudLevel").textContent=`Lv.${lvl.number} ${isGreekMode()?lvl.name_el:lvl.name_en}`;
  document.getElementById("hudPoints").textContent=`â­ ${data.points||0}`;
  document.getElementById("hudStreak").textContent=`ğŸ”¥ ${data.streak||0}`;
}

function showAchievementPopup(achievement){
  const el=document.getElementById("hudAchievement");
  el.textContent=`${achievement.icon} ${isGreekMode()?achievement.name_el:achievement.name_en}!`;
  el.style.display="block";
  // Also announce it
  const msg=isGreekMode()?`ÎÎ­Î¿ ÎµÏ€Î¯Ï„ÎµÏ…Î³Î¼Î±! ${achievement.name_el}!`:`New achievement! ${achievement.name_en}!`;
  setTimeout(()=>{cE("proud");say(msg)},500);
  setTimeout(()=>{el.style.display="none"},5000);
}

async function startStudentSession(name,mood){
  try{
    const r=await fetch('/api/student/session/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name,mood:mood||''})});
    const data=await r.json();
    currentSessionId=data.session_id;
    currentStudentName=name;
    D('  ğŸ“Š Session started: #'+currentSessionId+' for '+name);
    // Update HUD
    if(data.greeting_context){updateGamificationHud(data.greeting_context)}
    return data.greeting_context;
  }catch(e){D('  âš  Session start error: '+e);return null}
}

function endStudentSession(){
  if(!currentSessionId)return;
  fetch('/api/student/session/end',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:currentSessionId,mood:sEmo.emotion||''})}).catch(()=>{});
  D('  ğŸ“Š Session ended: #'+currentSessionId);
  currentSessionId=null;
}

// ===== STUDENT EMOTION =====
function pollSE(){if(!emotionDetectionOn)return;fetch('/api/student/emotion').then(r=>r.json()).then(d=>{sEmo=d;const b=document.getElementById("engBar"),dot=document.getElementById("engDot"),l=document.getElementById("engLabel");if(!d.face_detected){b.style.display="flex";dot.style.background="#666";l.textContent="";document.getElementById("personName").textContent="";return}b.style.display="flex";const e=d.engagement_score;dot.style.background=e>70?"#00ff88":e>40?"#ffaa00":"#ff4444";l.textContent=`${e}%`;
// Show recognized person name
const pn=document.getElementById("personName");
if(d.recognized_person){pn.textContent=d.recognized_person;pn.style.color="#00ff88";

// Pre-warm TTS cache for this person's ack phrases
if(!window._prewarmedNames)window._prewarmedNames=new Set();
if(!window._prewarmedNames.has(d.recognized_person)){
  window._prewarmedNames.add(d.recognized_person);
  fetch('/api/tts/prewarm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:d.recognized_person})}).catch(()=>{});
}

// Multi-face: greet ALL recognized persons
const allPersons=d.recognized_persons||[];
const primaryPerson=d.recognized_person;
const newPersons=allPersons.length>0
  ? allPersons.filter(p=>!greetedPersons.has(p.name)).map(p=>p.name)
  : (primaryPerson&&!greetedPersons.has(primaryPerson)?[primaryPerson]:[]);

if(newPersons.length>0&&!inConversation&&!isSpeaking){
  // Start session for primary person
  if(!currentStudentName){
    currentStudentName=primaryPerson;
    lastRecognizedPerson=primaryPerson;
  }
  
  // Greet all new persons
  newPersons.forEach(name=>greetedPersons.add(name));
  
  if(newPersons.length===1){
    // Single new person
    const name=newPersons[0];
    startStudentSession(name,d.emotion).then(ctx=>{
      let g;
      if(ctx&&ctx.is_new){
        g=isGreekMode()?`Î“ÎµÎ¹Î± ÏƒÎ¿Ï… ${name}! Î§Î±Î¯ÏÎ¿Î¼Î±Î¹ Ï€Î¿Ï… ÏƒÎµ Î³Î½Ï‰ÏÎ¯Î¶Ï‰!`:`Hey ${name}! Nice to meet you!`;
      }else if(ctx&&ctx.days_away>3){
        g=isGreekMode()?`${name}! Î Î¿Ï Î®ÏƒÎ¿Ï…Î½; Î£Îµ Î­ÏˆÎ±Ï‡Î½Î±!`:`${name}! Where have you been?`;
      }else if(ctx&&ctx.streak>2){
        g=isGreekMode()?`Î“ÎµÎ¹Î± ÏƒÎ¿Ï… ${name}! ${ctx.streak} Î¼Î­ÏÎµÏ‚ ÏƒÎµÏÎ¯!`:`Hey ${name}! ${ctx.streak} day streak!`;
      }else{
        const greetings=isGreekMode()?[`Î“ÎµÎ¹Î± ÏƒÎ¿Ï… ${name}!`,`${name}! Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚;`,`Î§Î±Î¯ÏÎ¿Î¼Î±Î¹ Ï€Î¿Ï… ÏƒÎµ Î²Î»Î­Ï€Ï‰ ${name}!`]:[`Hey ${name}!`,`Hi ${name}!`,`Good to see you ${name}!`];
        g=greetings[Math.floor(Math.random()*greetings.length)];
      }
      cE("happy");say(g);
    });
  }else{
    // Multiple new persons at once!
    const names=newPersons.join(isGreekMode()?' ÎºÎ±Î¹ ':' and ');
    const g=isGreekMode()
      ?`Î“ÎµÎ¹Î± ÏƒÎ±Ï‚ ${names}! Î¤Î¹ ÎºÎ¬Î½ÎµÏ„Îµ;`
      :`Hey ${names}! Good to see you all!`;
    // Start session for primary
    startStudentSession(primaryPerson,d.emotion);
    cE("excited");say(g);
  }
  
  // Show face count
  if(d.face_count>1){
    pn.textContent=allPersons.map(p=>p.name).join(', ')+` (${d.face_count})`;
  }
}
}else{pn.textContent="";if(lastRecognizedPerson){endStudentSession()}lastRecognizedPerson=null;document.getElementById("gamificationHud").style.display="none"}
handleP(d)}).catch(()=>{})}
setInterval(pollSE,2000);
function handleP(d){if(!proactiveEnabled||loading||voiceState===VOICE_ACTIVATED)return;const n=Date.now();if(n-lastPT<20000)return;const e=d.emotion,s=d.emotion_streak||0;if(s<6)return;let m=null,em=null;
if(e==="sad"&&s>8){m="Î¦Î±Î¯Î½ÎµÏƒÎ±Î¹ Î»Î¯Î³Î¿ ÏƒÏ„ÎµÎ½Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿Ï‚. Î•Î¯ÏƒÎ±Î¹ ÎµÎ½Ï„Î¬Î¾ÎµÎ¹;";em="worried"}
else if(e==="confused"&&s>7){m="Î”ÎµÎ¯Ï‡Î½ÎµÎ¹Ï‚ Î¼Ï€ÎµÏÎ´ÎµÎ¼Î­Î½Î¿Ï‚! Î˜ÎµÏ‚ Î²Î¿Î®Î¸ÎµÎ¹Î±;";em="hopeful"}
else if(e==="bored"&&s>10){m="Î Î¬Î¼Îµ ÎºÎ¬Ï„Î¹ Ï€Î¹Î¿ fun;";em="excited"}
else if(e==="sleepy"&&s>12){m="Î”ÎµÎ¯Ï‡Î½ÎµÎ¹Ï‚ ÎºÎ¿Ï…ÏÎ±ÏƒÎ¼Î­Î½Î¿Ï‚. Î Î¬ÏÎµ Î­Î½Î± Î´Î¹Î¬Î»ÎµÎ¹Î¼Î¼Î±!";em="worried"}
else if(e==="frustrated"&&s>8){m="ÎÎ­ÏÏ‰, ÎµÎ¯Î½Î±Î¹ Î´ÏÏƒÎºÎ¿Î»Î¿. Î‘Ï‚ Ï„Î¿ Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎ¿Ï…Î¼Îµ Î±Î»Î»Î¹ÏÏ‚!";em="hopeful"}
else if(e==="distracted"&&s>12){m="Î•ÎµÎµ! Î•Î´Ï ÎµÎ¯Î¼Î±Î¹!";em="winking"}
else return;
if(em)cE(em);stopAllRecognition();msgs.push({role:"assistant",content:m});say(m);lastPT=n}

// ===== WHITEBOARD =====
let wbO=false,wbT=null,wbPresenting=false;

function openWB(t,steps){
  wbO=true;
  wbPresenting=true;
  stopAllRecognition();
  
  document.getElementById("wbt").textContent=t;
  document.getElementById("wbCloseHint").textContent=isGreekMode()?'Î ÎµÏ‚ "OK" Î® Ï€Î¬Ï„Î± Î¿Ï€Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹Ï‚':'Say "OK" or tap anywhere to close';
  document.getElementById("wbCloseBtn").textContent=isGreekMode()?'âœ• Î Î¯ÏƒÏ‰':'âœ• Back';
  const c=document.getElementById("wbc");c.innerHTML="";
  
  // Create all step elements (hidden)
  const stepEls=[];
  steps.forEach((x)=>{
    const d=document.createElement("div");d.className="wb-step";
    let h="";
    if(x.label)h+=`<div class="sl">${x.label}</div>`;
    if(x.text)h+=`<div class="st">${x.text}</div>`;
    if(x.math)h+=`<div class="sm">${x.math}</div>`;
    if(x.result)h+=`<div class="sr">${x.result}</div>`;
    d.innerHTML=h;c.appendChild(d);
    stepEls.push({el:d,data:x});
  });
  
  // Show whiteboard
  document.getElementById("face").style.transition="opacity 0.6s";
  document.getElementById("face").style.opacity="0";
  setTimeout(()=>document.getElementById("wb").classList.add("active"),600);
  
  // Animate steps one by one
  const stepDelay=2000;
  stepEls.forEach((s,i)=>{
    setTimeout(()=>{s.el.classList.add("visible")},1200+i*stepDelay);
  });
  
  // After all steps shown, just mark presenting done
  // The say() onended â†’ startWakeListener â†’ startCommandListening handles mic start
  const totalTime=1200+stepEls.length*stepDelay+2000;
  setTimeout(()=>{
    wbPresenting=false;
    cmdRetryCount=0;
    D('  ğŸ“‹ Whiteboard steps done, wbPresenting=false');
    // If TTS already finished, we need to start listening ourselves
    if(!isSpeaking&&!(synth&&synth.speaking)){
      D('  ğŸ“‹ TTS already done, starting close listener');
      setTimeout(()=>{if(wbO&&!wbPresenting)startCommandListening()},500);
    }
    // Otherwise, TTS onended will call startWakeListener which routes to startCommandListening
  },totalTime);
  
  wbT=setTimeout(()=>{if(wbO)closeWB()},120000);
}

function closeWB(){
  if(!wbO)return; // prevent double-close
  wbO=false;wbPresenting=false;
  clearTimeout(wbT);
  stopAllRecognition();
  document.getElementById("wb").classList.remove("active");
  setTimeout(()=>{
    document.getElementById("face").style.opacity="1";
    cE("happy");
    // Resume conversation
    if(inConversation){
      say(isGreekMode()?"Î˜Î­Î»ÎµÎ¹Ï‚ ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿;":"Anything else?");
    }else{
      voiceState=VOICE_IDLE;
      startAlwaysListening();
    }
  },500);
}

function parseWB(t){
  // Try with proper closing tag first
  let m=t.match(/\[WHITEBOARD:(.*?)\]([\s\S]*?)\[\/WHITEBOARD\]/);
  if(!m){
    // Fallback: no closing tag (AI was cut off) â€” parse everything after opening tag
    m=t.match(/\[WHITEBOARD:(.*?)\]([\s\S]+)$/);
    if(!m)return null;
    D('  ğŸ“‹ Whiteboard: no closing tag, parsing anyway');
  }
  const s=[];
  m[2].trim().split("\n").filter(l=>l.trim()).forEach(l=>{
    const x=l.trim();
    if(x.startsWith("STEP:"))s.push({label:x.slice(5).trim()});
    else if(x.startsWith("MATH:"))s.push({math:x.slice(5).trim()});
    else if(x.startsWith("RESULT:"))s.push({result:x.slice(7).trim()});
    else if(x.startsWith("TEXT:"))s.push({text:x.slice(5).trim()});
    else if(x.length>2&&!x.startsWith("["))s.push({text:x}); // Skip stray tags
  });
  if(s.length===0)return null; // No actual content parsed
  return{t:m[1].trim(),s};
}

// ===== SETTINGS =====
let sO=false;function toggleSettings(){sO=!sO;document.getElementById("hb").classList.toggle("open",sO);document.getElementById("sp").classList.toggle("open",sO);document.getElementById("so").classList.toggle("open",sO);if(sO){loadFacesList();loadVoiceSettings()}else{if(settingsRecording){settingsRecording=false;if(settingsRecorder&&settingsRecorder.state==='recording')try{settingsRecorder.stop()}catch{}};}}

// ===== FACE RECOGNITION =====
function loadFacesList(){
  // Check status first
  fetch('/api/faces/status').then(r=>r.json()).then(d=>{
    const statusEl=document.getElementById('faceRecStatus');
    const setupArea=document.getElementById('faceSetupArea');
    const regArea=document.getElementById('faceRegArea');
    
    if(!d.initialized){
      statusEl.innerHTML='<span style="color:#ffaa00">âš  Not initialized</span>' + (d.error ? '<br><span style="font-size:10px;color:#ff6666">'+d.error+'</span>' : '');
      setupArea.style.display='block';
      regArea.style.display='none';
      document.getElementById('facesList').innerHTML='';
      return;
    }
    
    statusEl.innerHTML='<span style="color:#00ff88">âœ… Active</span>' + 
      (d.current_person ? ` â€” Seeing: <b style="color:#00ff88">${d.current_person}</b>` : '');
    setupArea.style.display='none';
    regArea.style.display='flex';
    
    // Load faces list
    const faces=d.known_faces||{};
    const el=document.getElementById('facesList');
    if(Object.keys(faces).length===0){
      el.innerHTML='<div style="font-size:12px;color:rgba(255,255,255,0.3);padding:4px 0">No faces registered yet</div>';
      return;
    }
    el.innerHTML=Object.entries(faces).map(([name,count])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)"><span style="font-size:13px;color:#e0f0ff">ğŸ‘¤ ${name} <span style="color:rgba(255,255,255,0.3)">(${count} samples)</span></span><button onclick="deleteFace('${name}')" style="background:none;border:none;color:rgba(255,80,80,0.6);cursor:pointer;font-size:11px;padding:2px 6px">âœ•</button></div>`).join('');
  }).catch(e=>{
    document.getElementById('faceRecStatus').innerHTML='<span style="color:#ff6666">âŒ Error connecting</span>';
  });
}

function setupFaceRec(){
  const btn=document.getElementById('setupFaceBtn');
  btn.textContent='â³ Downloading models...';
  btn.disabled=true;
  fetch('/api/faces/init',{method:'POST'})
  .then(r=>r.json().then(d=>({ok:r.ok,data:d})))
  .then(({ok,data})=>{
    btn.textContent=data.success?'âœ… Ready!':'âŒ '+data.message;
    btn.disabled=false;
    if(data.success)setTimeout(loadFacesList,500);
    else document.getElementById('faceRecStatus').innerHTML='<span style="color:#ff6666">'+data.message+'</span>';
  }).catch(e=>{
    btn.textContent='âŒ Error';
    btn.disabled=false;
    document.getElementById('faceRecStatus').innerHTML='<span style="color:#ff6666">'+e+'</span>';
  });
}

function registerFace(){
  const name=document.getElementById('faceNameInput').value.trim();
  if(!name){document.getElementById('faceStatus').textContent='Please enter a name first';return}
  const st=document.getElementById('faceStatus');
  st.textContent='ğŸ“¸ Capturing... look at the camera!';st.style.color='#00b4ff';
  
  // Take 5 samples for better accuracy
  fetch('/api/faces/register-multi',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name,count:5})})
  .then(r=>{
    if(!r.ok)return r.text().then(t=>{throw new Error(`Server ${r.status}: ${t.substring(0,200)}`)});
    return r.json();
  }).then(d=>{
    let msg=d.message;
    if(d.errors&&d.errors.length>0)msg+='\n'+d.errors[0]; // Show first error detail
    st.textContent=msg;
    st.style.color=d.success?'#00ff88':'#ff6666';
    if(d.success){document.getElementById('faceNameInput').value='';loadFacesList();
      say(isGreekMode()?`Î§Î±Î¯ÏÎ¿Î¼Î±Î¹ Ï€Î¿Ï… ÏƒÎµ Î³Î½Ï‰ÏÎ¯Î¶Ï‰ ${name}!`:`Nice to meet you ${name}!`);cE("happy")}
  }).catch(e=>{st.textContent='Error: '+e.message;st.style.color='#ff6666'})
}

function deleteFace(name){
  if(!confirm(`Remove ${name}'s face?`))return;
  fetch('/api/faces/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name})})
  .then(r=>r.json()).then(d=>{loadFacesList()}).catch(()=>{})
}
setInterval(()=>{fetch('/api/battery').then(r=>r.json()).then(d=>{if(d.percent>=0){const p=d.percent,f=document.getElementById("bf");if(f){f.style.width=p+"%";f.style.background=p>50?"linear-gradient(90deg,#00e0ff,#00ff88)":p>20?"linear-gradient(90deg,#ffaa00,#ff8800)":"linear-gradient(90deg,#ff4444,#ff2222)"}const t=document.getElementById("bt");if(t)t.textContent=p+"%";const pc=document.getElementById("bp");if(pc)pc.textContent=p+"%"}}).catch(()=>{})},10000);
const ST=Date.now();setInterval(()=>{const d=Date.now()-ST;document.getElementById("ut").textContent=`${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`},30000);

// ===== INIT =====
D('=== INIT ===');

// Set language selector to current language
document.getElementById('langSelect').value=vironLang;

fetch('/api/student/start-detection',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}).catch(()=>{});

// ===== VOICE FINGERPRINT =====
let voiceVerifyEnabled=false;
let voiceMediaRecorder=null;
let voiceAudioChunks=[];
let voiceRecordingForVerify=false;
const VOICE_PROMPTS=[
  name=>`Hello VIRON, my name is ${name}`,
  name=>`I love learning new things every day`,
  name=>`VIRON is my favorite study buddy`,
];

async function checkVoiceVerifyStatus(){
  try{
    const r=await fetch('/api/voice/status');
    const d=await r.json();
    voiceVerifyEnabled=d.initialized&&d.enabled&&d.profile_count>0;
    D('ğŸ™ï¸ Voice verify: '+(voiceVerifyEnabled?'ON ('+d.profile_count+' profiles)':'OFF'));
    return d;
  }catch{voiceVerifyEnabled=false;return{initialized:false}}
}

// --- Enrollment (setup wizard) ---
let enrollRecording=false;
let enrollRecorder=null;
let enrollChunks=[];

async function voiceEnrollRecord(){
  const btn=document.getElementById('voiceEnrollBtn');
  const msg=document.getElementById('voiceEnrollMsg');
  
  if(enrollRecording){
    // Stop recording
    enrollRecording=false;
    btn.textContent='â³ Processing...';
    btn.style.background='rgba(255,255,255,0.1)';
    if(enrollRecorder&&enrollRecorder.state==='recording'){
      enrollRecorder.stop();
    }
    return;
  }
  
  // Start recording
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:{
      echoCancellation:true, noiseSuppression:true, sampleRate:16000
    }});
    
    enrollRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus'});
    enrollChunks=[];
    
    enrollRecorder.ondataavailable=e=>{
      if(e.data.size>0)enrollChunks.push(e.data);
    };
    
    enrollRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(enrollChunks.length===0){msg.textContent='No audio captured';return}
      
      const blob=new Blob(enrollChunks,{type:'audio/webm'});
      D('  ğŸ™ï¸ Voice sample: '+Math.round(blob.size/1024)+'KB');
      
      // Convert to base64 and send
      const reader=new FileReader();
      reader.onload=async function(){
        const base64=reader.result.split(',')[1];
        try{
          const r=await fetch('/api/voice/register',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name:setupData.name,audio_base64:base64,sample_rate:16000})
          });
          const d=await r.json();
          
          if(d.success){
            setupData.voiceSamples=(setupData.voiceSamples||0)+1;
            const n=setupData.voiceSamples;
            
            // Update dots
            document.getElementById('vdot'+n).classList.remove('recording');
            document.getElementById('vdot'+n).classList.add('done');
            document.getElementById('vdot'+n).textContent='âœ“';
            
            if(n>=3){
              // All samples collected!
              msg.textContent='âœ… Voice registered! VIRON will only listen to you.';
              msg.style.color='#00ff88';
              btn.textContent='âœ… Done!';
              btn.style.background='rgba(0,255,136,0.2)';
              // Auto-advance after 1.5s
              setTimeout(()=>setupNext(4),1500);
            }else{
              // Update prompt for next sample
              const prompts=VOICE_PROMPTS;
              document.getElementById('voiceEnrollPrompt').innerHTML=
                '"'+prompts[n](setupData.name)+'"';
              msg.textContent=`Sample ${n}/3 recorded! ${3-n} more to go.`;
              msg.style.color='#00d4ff';
              btn.textContent='ğŸ™ï¸ Record Next';
              btn.style.background='linear-gradient(135deg,#ff4444,#cc2222)';
            }
          }else{
            msg.textContent='âš  '+d.message+' â€” Try again';
            msg.style.color='#ffaa00';
            btn.textContent='ğŸ™ï¸ Try Again';
            btn.style.background='linear-gradient(135deg,#ff4444,#cc2222)';
          }
        }catch(e){
          msg.textContent='âš  Server error: '+e.message;
          msg.style.color='#ffaa00';
          btn.textContent='ğŸ™ï¸ Try Again';
          btn.style.background='linear-gradient(135deg,#ff4444,#cc2222)';
        }
      };
      reader.readAsDataURL(blob);
    };
    
    enrollRecording=true;
    enrollRecorder.start();
    
    const n=(setupData.voiceSamples||0)+1;
    document.getElementById('vdot'+n).classList.add('recording');
    btn.textContent='â¹ï¸ Stop Recording';
    btn.style.background='linear-gradient(135deg,#ff6666,#ff2222)';
    msg.textContent='ğŸ”´ Recording... speak now!';
    msg.style.color='#ff4444';
    
    // Show audio level meter
    let enrollAudioCtx=new AudioContext();
    const src=enrollAudioCtx.createMediaStreamSource(stream);
    const analyser=enrollAudioCtx.createAnalyser();
    analyser.fftSize=256;
    src.connect(analyser);
    const dataArr=new Uint8Array(analyser.frequencyBinCount);
    const meter=document.getElementById('voiceEnrollLevel');
    const meterLoop=()=>{
      if(!enrollRecording){try{enrollAudioCtx.close()}catch{};return}
      analyser.getByteFrequencyData(dataArr);
      const avg=dataArr.reduce((a,b)=>a+b,0)/dataArr.length;
      meter.style.width=Math.min(100,avg*1.5)+'%';
      requestAnimationFrame(meterLoop);
    };
    meterLoop();
    
    // Auto-stop after 5 seconds
    setTimeout(()=>{
      if(enrollRecording)voiceEnrollRecord();
    },5000);
    
  }catch(e){
    msg.textContent='âš  Microphone access denied';
    msg.style.color='#ff4444';
    D('  âŒ Mic error: '+e);
  }
}

// --- Runtime Verification ---
// Start recording alongside speech recognition for verification
let voiceRecStream=null;
function startVoiceRecording(){
  if(!voiceVerifyEnabled)return;
  // Don't open a new mic stream if one is already active
  if(voiceMediaRecorder&&voiceMediaRecorder.state==='recording')return;
  
  navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,sampleRate:16000}})
  .then(stream=>{
    voiceRecStream=stream;
    voiceAudioChunks=[];
    voiceMediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus'});
    voiceMediaRecorder.ondataavailable=e=>{if(e.data.size>0)voiceAudioChunks.push(e.data)};
    voiceMediaRecorder.onstop=()=>{
      // Always clean up the stream
      if(voiceRecStream){voiceRecStream.getTracks().forEach(t=>t.stop());voiceRecStream=null}
    };
    voiceMediaRecorder.start();
    voiceRecordingForVerify=true;
    D('  ğŸ™ï¸ Voice recording started for verification');
  }).catch(e=>{
    D('  âš  Voice record skipped (mic busy): '+e.message);
    voiceRecordingForVerify=false;
  });
}

function stopVoiceRecording(){
  voiceRecordingForVerify=false;
  if(voiceMediaRecorder&&voiceMediaRecorder.state==='recording'){
    try{voiceMediaRecorder.stop()}catch(e){D('  âš  Voice stop error: '+e)}
  }
  // Fallback cleanup if onstop didn't fire
  setTimeout(()=>{
    if(voiceRecStream){voiceRecStream.getTracks().forEach(t=>t.stop());voiceRecStream=null}
  },500);
}

async function verifyVoice(){
  if(!voiceVerifyEnabled||voiceAudioChunks.length===0){
    return{verified:true,reason:'skip'};
  }
  
  const blob=new Blob(voiceAudioChunks,{type:'audio/webm'});
  if(blob.size<500)return{verified:true,reason:'too_small'};
  
  return new Promise((resolve)=>{
    const reader=new FileReader();
    reader.onload=async()=>{
      const base64=reader.result.split(',')[1];
      try{
        const r=await fetch('/api/voice/verify',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({audio_base64:base64,sample_rate:16000})
        });
        const d=await r.json();
        D('  ğŸ™ï¸ Voice verify: '+(d.verified?'âœ… '+d.name:'âŒ rejected')+' ('+d.confidence+')');
        resolve(d);
      }catch(e){
        D('  âš  Voice verify error: '+e);
        resolve({verified:true,reason:'error'});
      }
    };
    reader.onerror=()=>resolve({verified:true,reason:'read_error'});
    reader.readAsDataURL(blob);
  });
}

// Check voice verify status on boot
setTimeout(checkVoiceVerifyStatus,3000);

// --- Settings panel voice training ---
let settingsVoiceSamples=0;
let settingsRecording=false;
let settingsRecorder=null;
let settingsRecChunks=[];

function loadVoiceSettings(){
  fetch('/api/voice/status').then(r=>r.json()).then(d=>{
    const st=document.getElementById('voiceStatus');
    const list=document.getElementById('voiceProfilesList');
    const toggle=document.getElementById('voiceLockToggle');
    
    if(!d.initialized){
      st.textContent='âš  Voice verification not available (install resemblyzer)';
      st.style.color='#ffaa00';
      return;
    }
    
    // Update toggle
    if(d.enabled&&d.profile_count>0)toggle.classList.add('on');
    else toggle.classList.remove('on');
    
    // Show profiles
    const profiles=d.profiles||{};
    const names=Object.keys(profiles);
    if(names.length>0){
      st.textContent=`âœ… ${names.length} voice(s) registered`;
      st.style.color='#00ff88';
      list.innerHTML=names.map(n=>
        `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;margin:4px 0;background:rgba(255,255,255,0.05);border-radius:8px">
          <span style="color:#e0f0ff;font-size:13px">ğŸ™ï¸ ${n} <span style="color:rgba(255,255,255,0.3)">(${profiles[n]} samples)</span></span>
          <button onclick="deleteVoiceProfile('${n}')" style="background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px">âœ• Remove</button>
        </div>`
      ).join('');
      // Pre-fill name input with first profile
      document.getElementById('voiceNameInput').value=names[0];
    }else{
      st.textContent='No voice profiles â€” anyone can talk to VIRON';
      st.style.color='rgba(255,255,255,0.4)';
      list.innerHTML='';
    }
    
    // Reset dots
    settingsVoiceSamples=0;
    for(let i=1;i<=3;i++){
      const dot=document.getElementById('sdot'+i);
      dot.classList.remove('done','recording');
      dot.textContent=['â‘ ','â‘¡','â‘¢'][i-1];
    }
  }).catch(()=>{
    document.getElementById('voiceStatus').textContent='âš  Server not responding';
  });
}

async function settingsVoiceRecord(){
  const btn=document.getElementById('settingsVoiceBtn');
  const msg=document.getElementById('settingsVoiceMsg');
  const nameInput=document.getElementById('voiceNameInput');
  const name=nameInput.value.trim();
  
  // Guard: if already done (3 samples), don't record again
  if(settingsVoiceSamples>=3){
    msg.textContent='âœ… Already registered! Remove profile to re-record.';
    msg.style.color='#00ff88';
    return;
  }
  
  if(!name){nameInput.style.borderColor='#ff4444';msg.textContent='Enter a name first!';msg.style.color='#ff4444';return}
  nameInput.style.borderColor='rgba(255,255,255,0.15)';
  
  if(settingsRecording){
    settingsRecording=false;
    btn.textContent='â³ Processing...';
    if(settingsRecorder&&settingsRecorder.state==='recording')settingsRecorder.stop();
    return;
  }
  
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,sampleRate:16000}});
    settingsRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus'});
    settingsRecChunks=[];
    
    settingsRecorder.ondataavailable=e=>{if(e.data.size>0)settingsRecChunks.push(e.data)};
    
    settingsRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(settingsRecChunks.length===0){msg.textContent='No audio captured';return}
      
      const blob=new Blob(settingsRecChunks,{type:'audio/webm'});
      const reader=new FileReader();
      reader.onload=async()=>{
        const base64=reader.result.split(',')[1];
        try{
          const r=await fetch('/api/voice/register',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name:name,audio_base64:base64,sample_rate:16000})
          });
          const d=await r.json();
          if(d.success){
            settingsVoiceSamples++;
            const n=settingsVoiceSamples;
            document.getElementById('sdot'+n).classList.remove('recording');
            document.getElementById('sdot'+n).classList.add('done');
            document.getElementById('sdot'+n).textContent='âœ“';
            
            if(n>=3){
              msg.textContent='âœ… Voice registered! Voice lock is now active.';
              msg.style.color='#00ff88';
              btn.textContent='âœ… Done!';
              btn.style.background='rgba(0,255,136,0.15)';
              btn.style.color='#00ff88';
              btn.style.borderColor='rgba(0,255,136,0.3)';
              document.getElementById('voiceLockToggle').classList.add('on');
              // Refresh status
              setTimeout(()=>{loadVoiceSettings();checkVoiceVerifyStatus()},1000);
            }else{
              msg.textContent=`Sample ${n}/3 done! ${3-n} more.`;
              msg.style.color='#00d4ff';
              btn.textContent='ğŸ™ï¸ Record Next Sample';
              btn.style.background='rgba(255,68,68,0.15)';
              btn.style.color='#ff6666';
              btn.style.borderColor='rgba(255,68,68,0.3)';
            }
          }else{
            msg.textContent='âš  '+d.message;msg.style.color='#ffaa00';
            btn.textContent='ğŸ™ï¸ Try Again';
          }
        }catch(e){msg.textContent='âš  Error: '+e.message;msg.style.color='#ff4444';btn.textContent='ğŸ™ï¸ Try Again'}
      };
      reader.readAsDataURL(blob);
    };
    
    settingsRecording=true;
    settingsRecorder.start();
    const n=settingsVoiceSamples+1;
    if(n<=3)document.getElementById('sdot'+n).classList.add('recording');
    btn.textContent='â¹ï¸ Stop Recording';
    btn.style.background='rgba(255,68,68,0.3)';
    msg.textContent='ğŸ”´ Recording... speak now! (say anything)';
    msg.style.color='#ff4444';
    
    // Audio level meter
    let settingsAudioCtx=new AudioContext();
    const src=settingsAudioCtx.createMediaStreamSource(stream);
    const analyser=settingsAudioCtx.createAnalyser();
    analyser.fftSize=256;src.connect(analyser);
    const dataArr=new Uint8Array(analyser.frequencyBinCount);
    const meter=document.getElementById('settingsVoiceLevel');
    const loop=()=>{
      if(!settingsRecording){try{settingsAudioCtx.close()}catch{};return}
      analyser.getByteFrequencyData(dataArr);
      meter.style.width=Math.min(100,dataArr.reduce((a,b)=>a+b,0)/dataArr.length*1.5)+'%';
      requestAnimationFrame(loop);
    };loop();
    
    // Auto-stop after 4 seconds
    setTimeout(()=>{if(settingsRecording)settingsVoiceRecord()},4000);
  }catch(e){
    msg.textContent='âš  Microphone denied';msg.style.color='#ff4444';
  }
}

function deleteVoiceProfile(name){
  if(!confirm('Remove voice profile for '+name+'?'))return;
  fetch('/api/voice/delete',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name:name})}).then(()=>{loadVoiceSettings();checkVoiceVerifyStatus()});
}

function toggleVoiceLock(btn){
  btn.classList.toggle('on');
  const enabled=btn.classList.contains('on');
  fetch('/api/voice/toggle',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({enabled:enabled})}).then(()=>checkVoiceVerifyStatus());
}

async function resetViron(){
  if(!confirm('âš ï¸ This will delete ALL data:\n\nâ€¢ Student profiles & points\nâ€¢ Face recognition\nâ€¢ Voice fingerprints\n\nVIRON will restart with the setup wizard.\n\nContinue?'))return;
  if(!confirm('Are you sure? This cannot be undone.'))return;
  
  try{
    const r=await fetch('/api/setup/reset',{method:'POST'});
    const d=await r.json();
    if(d.success){
      toggleSettings();
      cE("sad");
      say(isGreekMode()?'Î˜Î± ÏƒÎµ Î¾ÎµÏ‡Î¬ÏƒÏ‰... Î¤Î± Î»Î­Î¼Îµ ÏƒÏÎ½Ï„Î¿Î¼Î±!':'I\'ll forget everything... See you soon!');
      setTimeout(()=>{location.reload()},4000);
    }else{
      alert('Reset partially failed: '+JSON.stringify(d.errors));
      location.reload();
    }
  }catch(e){alert('Reset error: '+e.message)}
}

// ===== SETUP WIZARD =====
let setupData={name:'',age:0,language:'el',registerFace:false,photoTaken:false};
let setupCamInterval=null;

function setupNext(step){
  if(step===2){
    // Validate name
    const name=document.getElementById('setupName').value.trim();
    if(!name){document.getElementById('setupName').style.borderColor='#ff4444';return}
    setupData.name=name;
    // Start camera preview
    setupStartCamPreview();
  }
  if(step===3){
    // Voice enrollment â€” show name in prompt
    document.getElementById('voiceEnrollName').textContent=setupData.name||'...';
    setupData.voiceSamples=0;
  }
  // Hide all steps, show requested
  for(let i=1;i<=6;i++){
    const el=document.getElementById('setupStep'+i);
    if(el)el.style.display=i===step?'block':'none';
  }
}

function setupStartCamPreview(){
  // Poll camera snapshot for preview
  const img=document.getElementById('setupCamImg');
  setupCamInterval=setInterval(()=>{
    img.src='/api/faces/snapshot?t='+Date.now();
  },500);
}

async function setupTakePhoto(){
  document.getElementById('setupPhotoStatus').textContent='Registering face...';
  try{
    // Register face from current camera frame
    const r=await fetch('/api/faces/register',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:setupData.name,from_camera:true})});
    const d=await r.json();
    if(d.success){
      setupData.registerFace=true;
      setupData.photoTaken=true;
      document.getElementById('setupPhotoStatus').textContent='âœ… Face registered!';
      document.getElementById('setupPhotoStatus').style.color='#00ff88';
      // Take 2 more samples for better recognition
      setTimeout(async()=>{
        await fetch('/api/faces/register',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:setupData.name,from_camera:true})});
      },1000);
      setTimeout(async()=>{
        await fetch('/api/faces/register',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:setupData.name,from_camera:true})});
        setupNext(3);
      },2000);
    }else{
      document.getElementById('setupPhotoStatus').textContent='âš  '+d.message+' â€” Try again or skip';
      document.getElementById('setupPhotoStatus').style.color='#ffaa00';
    }
  }catch(e){
    document.getElementById('setupPhotoStatus').textContent='âš  Camera not ready â€” skip for now';
    document.getElementById('setupPhotoStatus').style.color='#ffaa00';
  }
}

function setupSetAge(age){
  setupData.age=age;
  // Highlight selected button
  document.querySelectorAll('.age-btn').forEach(b=>b.classList.remove('selected'));
  event.target.classList.add('selected');
  setTimeout(()=>setupNext(5),300);
}

function setupSetLang(lang){
  setupData.language=lang;
  // Load WiFi list for step 6
  setupLoadWifi();
  setupNext(6);
}

async function setupLoadWifi(){
  try{
    const r=await fetch('/api/wifi/list');
    const nets=await r.json();
    const list=document.getElementById('setupWifiList');
    if(Array.isArray(nets)&&nets.length>0){
      list.innerHTML=nets.slice(0,5).map(n=>
        `<div style="padding:8px 12px;margin:4px 0;background:rgba(255,255,255,0.05);border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="setupConnectWifi('${n.ssid}')">
          <span style="color:#fff">${n.ssid}</span>
          <span style="color:rgba(255,255,255,0.4);font-size:12px">${n.signal}% ${n.security?'ğŸ”’':''}</span>
        </div>`
      ).join('');
    }else{
      list.innerHTML='<p style="color:rgba(255,255,255,0.4)">No WiFi networks found</p>';
    }
    // Show QR code
    try{
      document.getElementById('setupQRImg').src='/api/wifi/qr?t='+Date.now();
      document.getElementById('setupWifiQR').style.display='block';
    }catch{}
  }catch{
    document.getElementById('setupWifiList').innerHTML='<p style="color:rgba(255,255,255,0.4)">WiFi scan not available</p>';
  }
}

async function setupConnectWifi(ssid){
  const pw=prompt('Password for '+ssid+':');
  if(pw===null)return;
  try{
    const r=await fetch('/api/wifi/connect',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ssid:ssid,password:pw})});
    const d=await r.json();
    if(d.status==='connected'){
      alert('Connected to '+ssid+'!');
      // Reload QR with new IP
      setTimeout(()=>{document.getElementById('setupQRImg').src='/api/wifi/qr?t='+Date.now()},2000);
    }else{
      alert('Failed to connect. Check password.');
    }
  }catch{alert('Connection error')}
}

async function setupFinish(){
  // Stop camera preview
  if(setupCamInterval)clearInterval(setupCamInterval);
  
  // Save student profile
  if(setupData.name){
    try{
      await fetch('/api/setup/register',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          name:setupData.name,
          display_name:setupData.name,
          age:setupData.age,
          language:setupData.language,
          register_face:false  // Already done in step 2
        })});
    }catch(e){D('Setup save error: '+e)}
  }
  
  // Hide wizard
  document.getElementById('setupWizard').style.display='none';
  
  // Set language from setup
  if(setupData.language==='en'){
    const langSel=document.querySelector('select');
    if(langSel)langSel.value='en-US';
  }
  
  // Start VIRON normally
  startVironNormal();
}

function startVironNormal(){
  unlockAudio();
  
  // Personalized greeting if we have a name
  setTimeout(()=>{
    cE("excited");
    if(setupData.name){
      if(setupData.language==='el'||isGreekMode()){
        say(`Î“ÎµÎ¹Î± ÏƒÎ¿Ï… ${setupData.name}! Î ÎµÏ‚ Hey VIRON Î³Î¹Î± Î½Î± Î¼Î¿Ï… Î¼Î¹Î»Î®ÏƒÎµÎ¹Ï‚!`);
      }else{
        say(`Hi ${setupData.name}! Say Hey VIRON to talk to me!`);
      }
    }else{
      if(isGreekMode()){
        say("Î“ÎµÎ¹Î± ÏƒÎ¿Ï…! Î ÎµÏ‚ Hey VIRON Î³Î¹Î± Î½Î± Î¼Î¿Ï… Î¼Î¹Î»Î®ÏƒÎµÎ¹Ï‚!");
      }else{
        say("Hi there! Say Hey VIRON to talk to me!");
      }
    }
  },500);
  
  // Start listening after greeting
  setTimeout(()=>{
    D('Starting always-on listening');
    startAlwaysListening();
  },5000);
}

// Boot splash â†’ check setup, then start
const splash=document.getElementById('bootSplash');
splash.addEventListener('click',async function startViron(){
  splash.classList.add('hidden');
  setTimeout(()=>{splash.style.display='none'},1000);
  unlockAudio();
  
  // Check if setup is needed
  try{
    const r=await fetch('/api/setup/status');
    const status=await r.json();
    
    if(!status.setup_complete){
      // Show setup wizard
      document.getElementById('setupWizard').style.display='block';
      return;
    }
  }catch(e){
    D('Setup check failed: '+e+' â€” proceeding normally');
  }
  
  // Setup already done â€” start normally
  startVironNormal();
},{once:true});

// Keepalive: ensure always-on listening stays alive
setInterval(()=>{
  if(voiceState===VOICE_IDLE&&!loading&&!(synth&&synth.speaking)&&!alwaysListening){
    D('  Keepalive: restarting listener');
    startAlwaysListening();
  }
},5000);

// ===== SVG RENDER =====
const svg=document.getElementById("face");
svg.innerHTML=`<defs><radialGradient id="sc" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#fff"/><stop offset="70%" stop-color="#e8f4f8"/><stop offset="100%" stop-color="#c0dce8"/></radialGradient><radialGradient id="i0" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#00e0ff"/><stop offset="55%" stop-color="#0098c8"/><stop offset="100%" stop-color="#003050"/></radialGradient><radialGradient id="i1" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#ff6040"/><stop offset="55%" stop-color="#b02020"/><stop offset="100%" stop-color="#401010"/></radialGradient><radialGradient id="i2" cx="50%" cy="60%" r="50%"><stop offset="0%" stop-color="#ff69b4"/><stop offset="55%" stop-color="#c03070"/><stop offset="100%" stop-color="#500030"/></radialGradient><filter id="gl" x="-30%" y="-30%" width="160%" height="160%"><feGaussianBlur in="SourceGraphic" stdDeviation="8"/></filter><filter id="mg" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="4"/></filter><filter id="nb" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="6"/></filter></defs>`;

function rF(){const em=lE(E[prev],E[emo],tT),ii=Math.round(em.irisStyle),co=Math.min(1,Math.max(tO,em.mouthOpen||0)),bc=em.mouthCurve*30,uly=bc*.35-co*3,lly=bc+co*28,mW=80+co*8,iW=mW*.5;
bTime+=.015;if(talking){bA.l=Math.sin(bTime*1.8)*3+Math.sin(bTime*.9)*2;bA.r=Math.sin(bTime*1.5+.8)*2.5+Math.cos(bTime*.8)*2}else if(["neutral","happy","thinking"].includes(emo)){bA.l=Math.sin(bTime*.4)*1.5;bA.r=Math.sin(bTime*.35+.5)*1.5}else{bA.l=Math.sin(bTime*.3)*.7;bA.r=Math.sin(bTime*.25)*.7}
let h=svg.querySelector("defs").outerHTML;
for(const[cx,fl]of[[240,false],[560,true]]){const hx=fl?-20:20,ix=fl?8:-8,rx=100*em.eyeRx,ry=64*em.eyeRy,isW=em.winkLeft&&!fl,sq=em.squint||0,eR=blink||isW?4:ry*(1-sq*.5),pR=26*em.pupilSize,bAn=em.browAngle,bYY=em.browY,bo=fl?bA.r:bA.l,rot=fl?4:-4,ci=fl?"cR":"cL";
h+=`<g transform="translate(${cx},195) rotate(${rot})"><ellipse cx="0" cy="0" rx="${rx+10}" ry="${ry+10}" fill="rgba(180,230,255,0.06)" filter="url(#gl)"/><path d="M -76 ${-ry-22+bYY+(fl?bAn:-bAn)+bo*.6} Q 0 ${-ry-32+bYY+bo} 76 ${-ry-22+bYY+(fl?-bAn:bAn)+bo*.4}" fill="none" stroke="rgba(200,220,255,0.35)" stroke-width="10" stroke-linecap="round"/><ellipse cx="0" cy="0" rx="${rx}" ry="${eR}" fill="url(#sc)" stroke="rgba(100,160,190,0.25)" stroke-width="1.5"/><clipPath id="${ci}"><ellipse cx="0" cy="0" rx="${rx}" ry="${eR}"/></clipPath><g clip-path="url(#${ci})">`;
if(emo==="dizzy")h+=`<g transform="translate(${ix+lx},${6+ly})"><line x1="-22" y1="-22" x2="22" y2="22" stroke="rgba(0,200,255,0.6)" stroke-width="6"><animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="2s" repeatCount="indefinite"/></line><line x1="22" y1="-22" x2="-22" y2="22" stroke="rgba(0,200,255,0.6)" stroke-width="6"><animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="2s" repeatCount="indefinite"/></line></g>`;
else h+=`<circle cx="${ix+lx}" cy="${6+ly}" r="56" fill="url(#i${ii})"/><circle cx="${ix+lx}" cy="${6+ly}" r="44" fill="none" stroke="rgba(0,50,90,0.35)" stroke-width="6"/><circle cx="${ix+lx}" cy="${6+ly}" r="${pR}" fill="#020208"/><ellipse cx="${ix+lx+hx}" cy="${6+ly-22}" rx="15" ry="17" fill="white" opacity="0.95"/><circle cx="${ix+lx-hx*.8}" cy="${6+ly+20}" r="7" fill="white" opacity="0.55"/>`;
if(em.sparkle&&!blink&&!isW)h+=`<circle cx="${ix+lx+32}" cy="${6+ly-40}" r="3" fill="white" opacity="0.8"><animate attributeName="opacity" values="0.8;0.2;0.8" dur="1.5s" repeatCount="indefinite"/></circle>`;
h+=`<ellipse cx="0" cy="${-ry+5}" rx="${rx}" ry="20" fill="rgba(0,0,0,0.06)"/>`;
if(["sad","crying"].includes(emo)&&!blink)h+=`<ellipse cx="${fl?35:-35}" cy="60" rx="5" ry="9" fill="rgba(100,200,255,0.5)"><animate attributeName="cy" values="60;95;60" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0.8;0" dur="3s" repeatCount="indefinite"/></ellipse>`;
h+=`</g>`;if(emo==="shy"&&tT>.5)h+=`<ellipse cx="${fl?-30:30}" cy="45" rx="30" ry="15" fill="rgba(255,100,150,0.15)" filter="url(#gl)"/>`;if(emo==="sleepy"&&tT>.5)h+=`<g transform="translate(${fl?75:-75},-55)"><text font-size="18" fill="rgba(200,220,255,0.5)" font-weight="bold">z<animate attributeName="opacity" values="0.5;0.1;0.5" dur="2s" repeatCount="indefinite"/></text></g>`;h+=`</g>`}
h+=`<g transform="translate(400,280)"><ellipse cx="0" cy="20" rx="65" ry="80" fill="rgba(150,200,230,0.05)" filter="url(#nb)"/><line x1="0" y1="-65" x2="0" y2="52" stroke="rgba(200,230,255,0.22)" stroke-width="5" stroke-linecap="round"/><path d="M -38 50 Q -18 74 0 78 Q 18 74 38 50" fill="none" stroke="rgba(200,230,255,0.28)" stroke-width="5" stroke-linecap="round"/><ellipse cx="-20" cy="60" rx="10" ry="6" fill="rgba(0,0,0,0.2)"/><ellipse cx="20" cy="60" rx="10" ry="6" fill="rgba(0,0,0,0.2)"/></g>`;
h+=`<g transform="translate(400,410)">`;
if(em.mouthOpen>.5&&!talking&&emo==="surprised"){const o=em.mouthOpen;h+=`<ellipse cx="0" cy="8" rx="${26+o*10}" ry="${24+o*12}" fill="rgba(15,5,25,0.85)"/><ellipse cx="0" cy="8" rx="${26+o*10}" ry="${24+o*12}" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="5"/>`}
else{h+=`<path d="M ${-mW} 0 Q ${-iW} ${lly} 0 ${lly+4} Q ${iW} ${lly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="28" stroke-linecap="round" filter="url(#mg)"/>`;
h+=`<path d="M ${-mW} 0 Q ${-iW} ${uly} 0 ${uly+2} Q ${iW} ${uly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="10" stroke-linecap="round"/>`;
h+=`<path d="M ${-mW} 0 Q ${-iW} ${lly} 0 ${lly+4} Q ${iW} ${lly} ${mW} 0" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="12" stroke-linecap="round"/>`;
if(co>.05)h+=`<path d="M ${-mW} 0 Q ${-iW} ${uly} 0 ${uly+2} Q ${iW} ${uly} ${mW} 0 Q ${iW} ${lly} 0 ${lly+4} Q ${-iW} ${lly} ${-mW} 0 Z" fill="rgba(15,5,25,${Math.min(.85,co*1.2)})"/>`;
if((emo==="cheeky"||tO>.4)&&co>.2){const ty=(uly+lly)*.55+2;h+=`<ellipse cx="0" cy="${ty}" rx="${10+tO*5}" ry="${4+tO*4}" fill="rgba(120,20,30,0.75)"/>`}
h+=`<circle cx="${-mW}" cy="0" r="7" fill="rgba(255,255,255,0.45)"/><circle cx="${mW}" cy="0" r="7" fill="rgba(255,255,255,0.45)"/>`}
h+=`</g>`;svg.innerHTML=h;requestAnimationFrame(rF)}
requestAnimationFrame(rF);
</script>
</body>
</html>
